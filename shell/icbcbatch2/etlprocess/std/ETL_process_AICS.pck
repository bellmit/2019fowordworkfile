create or replace package ETL_process_AICS is
  --Ö÷¿Ø
  procedure control_update;
  procedure update_account_bankinfo;
  procedure update_asset_loanaccount_info;
  procedure update_creditor_vary_relation;
  procedure update_customer_info;
  procedure update_equity_assets_info;
  procedure update_invest_contract;
  procedure update_invest_fundvary;
  procedure update_invest_profitdetail;
  procedure update_project_info;
  procedure update_repay_info;
  procedure update_asset_creditor_relation;
  procedure update_asset_creditorcontract;
  procedure update_asset_guaranteecontract;
  procedure update_asset_loanaccount;
  procedure update_asset_mortgagecontract;
  procedure update_asset_pawn_info;
  procedure update_invest_floatrate;
  procedure update_invest_plandetail;
  procedure update_invest_plan;
  procedure update_invest_rate;
  procedure update_repay_confirm;
  procedure update_deposits_loans_deal;
  procedure update_repo_deal_order;
  procedure update_security_deal;
  procedure update_security_master;
  procedure update_security_position;
  procedure update_security_rate_adjust;
  procedure update_repo_deal;
  procedure update_log(source_sheet      varchar2,
                       target_sheet      varchar2,
                       query_date        date,
                       success_status    varchar2,
                       exception_message varchar2 DEFAULT NULL);

end ETL_process_AICS;
/
create or replace package body ETL_process_AICS is
  procedure control_update is
  
  begin
    update_account_bankinfo;
    update_asset_loanaccount_info;
    update_creditor_vary_relation;
    update_customer_info;
    update_equity_assets_info;
    update_invest_contract;
    update_invest_fundvary;
    update_invest_profitdetail;
    update_project_info;
    update_repay_info;
    update_asset_creditor_relation;
    update_asset_creditorcontract;
    update_asset_guaranteecontract;
    update_asset_loanaccount;
    update_asset_mortgagecontract;
    update_asset_pawn_info;
    update_invest_floatrate;
    update_invest_plandetail;
    update_invest_plan;
    update_invest_rate;
    update_repay_confirm;
    update_deposits_loans_deal;
    update_repo_deal_order;
    update_security_deal;
    update_security_master;
    update_security_position;
    update_security_rate_adjust;
    update_repo_deal;
  
  end;
  --update_account_bankinfo
  procedure update_account_bankinfo is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t08_account_bankinfo
     where start_date = query_date;
    update STD_LAYER.t08_account_bankinfo
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t08_account_bankinfo HIS
    using (select accobelong,
                  accocheckserviceprotocol,
                  accofunction,
                  accomanageprotocol,
                  acconame,
                  accoproperty,
                  accotype,
                  accountmemo,
                  accounttotal,
                  address,
                  agentbank,
                  agentbankaccount,
                  applyer,
                  applyid,
                  archive_reviewer,
                  archive_status,
                  archive_user,
                  area,
                  areacode,
                  attribute,
                  audittype,
                  authushieldnum,
                  bankacco,
                  bankname,
                  bankno,
                  bankrate,
                  bigpaysystemno,
                  calinteresttype,
                  cancelaccoapplication,
                  cancelaccopaper,
                  canceler,
                  cancelexplain,
                  cancelstatus,
                  changecontent,
                  cityno,
                  counterbillsavetype,
                  counterremittype,
                  createuser,
                  deposittype,
                  ebankkey,
                  enteruser,
                  fileno,
                  fundtrustee,
                  guarantee_bank_code,
                  guarantee_bank_no,
                  havecanflg,
                  havereceiptflg,
                  is_rate_fixed,
                  is_suspended,
                  iscancel,
                  iscustodial,
                  isreview,
                  issavefile,
                  issetsubaccount,
                  isuseaccount,
                  jrxxkzbh,
                  jrxxkzhm,
                  keepbakcontracttype,
                  keepbankname,
                  moneytype,
                  nameinbank,
                  oddway,
                  onlinebankoperator,
                  openaccoapplication,
                  openaccountdate,
                  openebankpay,
                  openebanksearch,
                  opener,
                  operator,
                  organcode,
                  otherremittype,
                  otherrtnreceipt,
                  productcategory,
                  projectcode,
                  publicflg,
                  receiptflg,
                  rejecttype,
                  sealapproval,
                  sealauditor,
                  sealcard,
                  sealoperator,
                  seals,
                  sealsavetype,
                  sealseals,
                  sealsealsavetype,
                  status,
                  swiftcode,
                  tradeid,
                  transtype,
                  updateuser,
                  webbankcancelrtnreceipt,
                  webbankopenrtnreceipt,
                  zhdzpd,
                  zhglqk,
                  zhswbgfs,
                  zhyjbgfs,
                  archive_time,
                  cancelaccodate,
                  cancelapprovedate,
                  changedate,
                  createtime,
                  delaydate,
                  enabledate,
                  enddate,
                  expiredate,
                  lastmodifydate,
                  openaccodate,
                  reviewtime,
                  setdate,
                  valuedate,
                  accoid,
                  banknobrac,
                  rate,
                  retainage_id,
                  serialno
             from SRC_LAYER.aics_account_bankinfo
           minus
           select accobelong,
                  accocheckserviceprotocol,
                  accofunction,
                  accomanageprotocol,
                  acconame,
                  accoproperty,
                  accotype,
                  accountmemo,
                  accounttotal,
                  address,
                  agentbank,
                  agentbankaccount,
                  applyer,
                  applyid,
                  archive_reviewer,
                  archive_status,
                  archive_user,
                  area,
                  areacode,
                  attribute,
                  audittype,
                  authushieldnum,
                  bankacco,
                  bankname,
                  bankno,
                  bankrate,
                  bigpaysystemno,
                  calinteresttype,
                  cancelaccoapplication,
                  cancelaccopaper,
                  canceler,
                  cancelexplain,
                  cancelstatus,
                  changecontent,
                  cityno,
                  counterbillsavetype,
                  counterremittype,
                  createuser,
                  deposittype,
                  ebankkey,
                  enteruser,
                  fileno,
                  fundtrustee,
                  guarantee_bank_code,
                  guarantee_bank_no,
                  havecanflg,
                  havereceiptflg,
                  is_rate_fixed,
                  is_suspended,
                  iscancel,
                  iscustodial,
                  isreview,
                  issavefile,
                  issetsubaccount,
                  isuseaccount,
                  jrxxkzbh,
                  jrxxkzhm,
                  keepbakcontracttype,
                  keepbankname,
                  moneytype,
                  nameinbank,
                  oddway,
                  onlinebankoperator,
                  openaccoapplication,
                  openaccountdate,
                  openebankpay,
                  openebanksearch,
                  opener,
                  operator,
                  organcode,
                  otherremittype,
                  otherrtnreceipt,
                  productcategory,
                  projectcode,
                  publicflg,
                  receiptflg,
                  rejecttype,
                  sealapproval,
                  sealauditor,
                  sealcard,
                  sealoperator,
                  seals,
                  sealsavetype,
                  sealseals,
                  sealsealsavetype,
                  status,
                  swiftcode,
                  tradeid,
                  transtype,
                  updateuser,
                  webbankcancelrtnreceipt,
                  webbankopenrtnreceipt,
                  zhdzpd,
                  zhglqk,
                  zhswbgfs,
                  zhyjbgfs,
                  archive_time,
                  cancelaccodate,
                  cancelapprovedate,
                  changedate,
                  createtime,
                  delaydate,
                  enabledate,
                  enddate,
                  expiredate,
                  lastmodifydate,
                  openaccodate,
                  reviewtime,
                  setdate,
                  valuedate,
                  accoid,
                  banknobrac,
                  rate,
                  retainage_id,
                  serialno
           
             from STD_LAYER.t08_account_bankinfo) DIF
    on (HIS.acconame = DIF.acconame)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t08_account_bankinfo
      select accobelong,
             accocheckserviceprotocol,
             accofunction,
             accomanageprotocol,
             acconame,
             accoproperty,
             accotype,
             accountmemo,
             accounttotal,
             address,
             agentbank,
             agentbankaccount,
             applyer,
             applyid,
             archive_reviewer,
             archive_status,
             archive_user,
             area,
             areacode,
             attribute,
             audittype,
             authushieldnum,
             bankacco,
             bankname,
             bankno,
             bankrate,
             bigpaysystemno,
             calinteresttype,
             cancelaccoapplication,
             cancelaccopaper,
             canceler,
             cancelexplain,
             cancelstatus,
             changecontent,
             cityno,
             counterbillsavetype,
             counterremittype,
             createuser,
             deposittype,
             ebankkey,
             enteruser,
             fileno,
             fundtrustee,
             guarantee_bank_code,
             guarantee_bank_no,
             havecanflg,
             havereceiptflg,
             is_rate_fixed,
             is_suspended,
             iscancel,
             iscustodial,
             isreview,
             issavefile,
             issetsubaccount,
             isuseaccount,
             jrxxkzbh,
             jrxxkzhm,
             keepbakcontracttype,
             keepbankname,
             moneytype,
             nameinbank,
             oddway,
             onlinebankoperator,
             openaccoapplication,
             openaccountdate,
             openebankpay,
             openebanksearch,
             opener,
             operator,
             organcode,
             otherremittype,
             otherrtnreceipt,
             productcategory,
             projectcode,
             publicflg,
             receiptflg,
             rejecttype,
             sealapproval,
             sealauditor,
             sealcard,
             sealoperator,
             seals,
             sealsavetype,
             sealseals,
             sealsealsavetype,
             status,
             swiftcode,
             tradeid,
             transtype,
             updateuser,
             webbankcancelrtnreceipt,
             webbankopenrtnreceipt,
             zhdzpd,
             zhglqk,
             zhswbgfs,
             zhyjbgfs,
             archive_time,
             cancelaccodate,
             cancelapprovedate,
             changedate,
             createtime,
             delaydate,
             enabledate,
             enddate,
             expiredate,
             lastmodifydate,
             openaccodate,
             reviewtime,
             setdate,
             valuedate,
             accoid,
             banknobrac,
             rate,
             retainage_id,
             serialno,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_account_bankinfo
       where acconame not in
             (select acconame
                from (select accobelong,
                             accocheckserviceprotocol,
                             accofunction,
                             accomanageprotocol,
                             acconame,
                             accoproperty,
                             accotype,
                             accountmemo,
                             accounttotal,
                             address,
                             agentbank,
                             agentbankaccount,
                             applyer,
                             applyid,
                             archive_reviewer,
                             archive_status,
                             archive_user,
                             area,
                             areacode,
                             attribute,
                             audittype,
                             authushieldnum,
                             bankacco,
                             bankname,
                             bankno,
                             bankrate,
                             bigpaysystemno,
                             calinteresttype,
                             cancelaccoapplication,
                             cancelaccopaper,
                             canceler,
                             cancelexplain,
                             cancelstatus,
                             changecontent,
                             cityno,
                             counterbillsavetype,
                             counterremittype,
                             createuser,
                             deposittype,
                             ebankkey,
                             enteruser,
                             fileno,
                             fundtrustee,
                             guarantee_bank_code,
                             guarantee_bank_no,
                             havecanflg,
                             havereceiptflg,
                             is_rate_fixed,
                             is_suspended,
                             iscancel,
                             iscustodial,
                             isreview,
                             issavefile,
                             issetsubaccount,
                             isuseaccount,
                             jrxxkzbh,
                             jrxxkzhm,
                             keepbakcontracttype,
                             keepbankname,
                             moneytype,
                             nameinbank,
                             oddway,
                             onlinebankoperator,
                             openaccoapplication,
                             openaccountdate,
                             openebankpay,
                             openebanksearch,
                             opener,
                             operator,
                             organcode,
                             otherremittype,
                             otherrtnreceipt,
                             productcategory,
                             projectcode,
                             publicflg,
                             receiptflg,
                             rejecttype,
                             sealapproval,
                             sealauditor,
                             sealcard,
                             sealoperator,
                             seals,
                             sealsavetype,
                             sealseals,
                             sealsealsavetype,
                             status,
                             swiftcode,
                             tradeid,
                             transtype,
                             updateuser,
                             webbankcancelrtnreceipt,
                             webbankopenrtnreceipt,
                             zhdzpd,
                             zhglqk,
                             zhswbgfs,
                             zhyjbgfs,
                             archive_time,
                             cancelaccodate,
                             cancelapprovedate,
                             changedate,
                             createtime,
                             delaydate,
                             enabledate,
                             enddate,
                             expiredate,
                             lastmodifydate,
                             openaccodate,
                             reviewtime,
                             setdate,
                             valuedate,
                             accoid,
                             banknobrac,
                             rate,
                             retainage_id,
                             serialno
                        from SRC_LAYER.aics_account_bankinfo
                      intersect
                      select accobelong,
                             accocheckserviceprotocol,
                             accofunction,
                             accomanageprotocol,
                             acconame,
                             accoproperty,
                             accotype,
                             accountmemo,
                             accounttotal,
                             address,
                             agentbank,
                             agentbankaccount,
                             applyer,
                             applyid,
                             archive_reviewer,
                             archive_status,
                             archive_user,
                             area,
                             areacode,
                             attribute,
                             audittype,
                             authushieldnum,
                             bankacco,
                             bankname,
                             bankno,
                             bankrate,
                             bigpaysystemno,
                             calinteresttype,
                             cancelaccoapplication,
                             cancelaccopaper,
                             canceler,
                             cancelexplain,
                             cancelstatus,
                             changecontent,
                             cityno,
                             counterbillsavetype,
                             counterremittype,
                             createuser,
                             deposittype,
                             ebankkey,
                             enteruser,
                             fileno,
                             fundtrustee,
                             guarantee_bank_code,
                             guarantee_bank_no,
                             havecanflg,
                             havereceiptflg,
                             is_rate_fixed,
                             is_suspended,
                             iscancel,
                             iscustodial,
                             isreview,
                             issavefile,
                             issetsubaccount,
                             isuseaccount,
                             jrxxkzbh,
                             jrxxkzhm,
                             keepbakcontracttype,
                             keepbankname,
                             moneytype,
                             nameinbank,
                             oddway,
                             onlinebankoperator,
                             openaccoapplication,
                             openaccountdate,
                             openebankpay,
                             openebanksearch,
                             opener,
                             operator,
                             organcode,
                             otherremittype,
                             otherrtnreceipt,
                             productcategory,
                             projectcode,
                             publicflg,
                             receiptflg,
                             rejecttype,
                             sealapproval,
                             sealauditor,
                             sealcard,
                             sealoperator,
                             seals,
                             sealsavetype,
                             sealseals,
                             sealsealsavetype,
                             status,
                             swiftcode,
                             tradeid,
                             transtype,
                             updateuser,
                             webbankcancelrtnreceipt,
                             webbankopenrtnreceipt,
                             zhdzpd,
                             zhglqk,
                             zhswbgfs,
                             zhyjbgfs,
                             archive_time,
                             cancelaccodate,
                             cancelapprovedate,
                             changedate,
                             createtime,
                             delaydate,
                             enabledate,
                             enddate,
                             expiredate,
                             lastmodifydate,
                             openaccodate,
                             reviewtime,
                             setdate,
                             valuedate,
                             accoid,
                             banknobrac,
                             rate,
                             retainage_id,
                             serialno
                        from STD_LAYER.t08_account_bankinfo));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_account_bankinfo',
               'STD_LAYER.t08_account_bankinfo',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_account_bankinfo',
                 'STD_LAYER.t08_account_bankinfo',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
    
  end update_account_bankinfo;

  --update_asset_loanaccount_info
  procedure update_asset_loanaccount_info is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t01_asset_loanaccount_info
     where start_date = query_date;
    update STD_LAYER.t01_asset_loanaccount_info
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t01_asset_loanaccount_info HIS
    using (select loanaccountcode,
                  loanaccountnum,
                  loanaccountname,
                  loanstatus,
                  projectcode,
                  industrydetail,
                  provincecode,
                  cityno,
                  regioncode,
                  businesscondition,
                  corpusamount,
                  interest,
                  disbursementfee,
                  minquotedprice,
                  maxquotedprice,
                  loanaccountcosts,
                  replayrate,
                  memo,
                  enteruser,
                  entertime,
                  lastupdateuser,
                  lastupdatetime,
                  loanmanager,
                  evaluationuser,
                  reclaimscale,
                  currentscale,
                  quotationscale,
                  disposalyears,
                  balancecost,
                  currentbalance,
                  deductionten,
                  lasttimeloss,
                  lastbalance,
                  qualification,
                  issolvency,
                  ispay,
                  lastamount,
                  recoverablescale,
                  recoverablebalancec,
                  disposalmoney,
                  lastbalanceall,
                  abstract1,
                  abstract2,
                  abstract3,
                  abstract4,
                  abstract5,
                  abstract6,
                  abstract7,
                  abstract8,
                  abstract9,
                  abstract10,
                  setupdate,
                  representative,
                  registemoney,
                  businesscope,
                  address,
                  cykind,
                  relationcode,
                  opertorvaluationdate,
                  transferbalance,
                  fxassetrate,
                  schemeid,
                  isalldeal,
                  assetsource,
                  assetsourcename,
                  abstract11,
                  abstract12,
                  predisposalperiod,
                  defaultinterest,
                  otherfee,
                  subcompanyreceivedate,
                  subcompanyreceivemoney,
                  litigationstatus,
                  mindealprice,
                  entertype,
                  propertynature,
                  escrowstatus,
                  assetseller,
                  baseday,
                  margin_balance,
                  recprecoverablescale,
                  recprecoverablebalance,
                  asset_category,
                  source,
                  is_continue_agency,
                  continue_agency
             from SRC_LAYER.aics_asset_loanaccount_info
           minus
           select loanaccountcode,
                  loanaccountnum,
                  loanaccountname,
                  loanstatus,
                  projectcode,
                  industrydetail,
                  provincecode,
                  cityno,
                  regioncode,
                  businesscondition,
                  corpusamount,
                  interest,
                  disbursementfee,
                  minquotedprice,
                  maxquotedprice,
                  loanaccountcosts,
                  replayrate,
                  memo,
                  enteruser,
                  entertime,
                  lastupdateuser,
                  lastupdatetime,
                  loanmanager,
                  evaluationuser,
                  reclaimscale,
                  currentscale,
                  quotationscale,
                  disposalyears,
                  balancecost,
                  currentbalance,
                  deductionten,
                  lasttimeloss,
                  lastbalance,
                  qualification,
                  issolvency,
                  ispay,
                  lastamount,
                  recoverablescale,
                  recoverablebalancec,
                  disposalmoney,
                  lastbalanceall,
                  abstract1,
                  abstract2,
                  abstract3,
                  abstract4,
                  abstract5,
                  abstract6,
                  abstract7,
                  abstract8,
                  abstract9,
                  abstract10,
                  setupdate,
                  representative,
                  registemoney,
                  businesscope,
                  address,
                  cykind,
                  relationcode,
                  opertorvaluationdate,
                  transferbalance,
                  fxassetrate,
                  schemeid,
                  isalldeal,
                  assetsource,
                  assetsourcename,
                  abstract11,
                  abstract12,
                  predisposalperiod,
                  defaultinterest,
                  otherfee,
                  subcompanyreceivedate,
                  subcompanyreceivemoney,
                  litigationstatus,
                  mindealprice,
                  entertype,
                  propertynature,
                  escrowstatus,
                  assetseller,
                  baseday,
                  margin_balance,
                  recprecoverablescale,
                  recprecoverablebalance,
                  asset_category,
                  source,
                  is_continue_agency,
                  continue_agency
           
             from STD_LAYER.t01_asset_loanaccount_info) DIF
    on (HIS.loanaccountcode = DIF.loanaccountcode)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t01_asset_loanaccount_info
      select loanaccountcode,
             loanaccountnum,
             loanaccountname,
             loanstatus,
             projectcode,
             industrydetail,
             provincecode,
             cityno,
             regioncode,
             businesscondition,
             corpusamount,
             interest,
             disbursementfee,
             minquotedprice,
             maxquotedprice,
             loanaccountcosts,
             replayrate,
             memo,
             enteruser,
             entertime,
             lastupdateuser,
             lastupdatetime,
             loanmanager,
             evaluationuser,
             reclaimscale,
             currentscale,
             quotationscale,
             disposalyears,
             balancecost,
             currentbalance,
             deductionten,
             lasttimeloss,
             lastbalance,
             qualification,
             issolvency,
             ispay,
             lastamount,
             recoverablescale,
             recoverablebalancec,
             disposalmoney,
             lastbalanceall,
             abstract1,
             abstract2,
             abstract3,
             abstract4,
             abstract5,
             abstract6,
             abstract7,
             abstract8,
             abstract9,
             abstract10,
             setupdate,
             representative,
             registemoney,
             businesscope,
             address,
             cykind,
             relationcode,
             opertorvaluationdate,
             transferbalance,
             fxassetrate,
             schemeid,
             isalldeal,
             assetsource,
             assetsourcename,
             abstract11,
             abstract12,
             predisposalperiod,
             defaultinterest,
             otherfee,
             subcompanyreceivedate,
             subcompanyreceivemoney,
             litigationstatus,
             mindealprice,
             entertype,
             propertynature,
             escrowstatus,
             assetseller,
             baseday,
             margin_balance,
             recprecoverablescale,
             recprecoverablebalance,
             asset_category,
             source,
             is_continue_agency,
             continue_agency,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_asset_loanaccount_info
       where loanaccountcode not in
             (select loanaccountcode
                from (select loanaccountcode,
                             loanaccountnum,
                             loanaccountname,
                             loanstatus,
                             projectcode,
                             industrydetail,
                             provincecode,
                             cityno,
                             regioncode,
                             businesscondition,
                             corpusamount,
                             interest,
                             disbursementfee,
                             minquotedprice,
                             maxquotedprice,
                             loanaccountcosts,
                             replayrate,
                             memo,
                             enteruser,
                             entertime,
                             lastupdateuser,
                             lastupdatetime,
                             loanmanager,
                             evaluationuser,
                             reclaimscale,
                             currentscale,
                             quotationscale,
                             disposalyears,
                             balancecost,
                             currentbalance,
                             deductionten,
                             lasttimeloss,
                             lastbalance,
                             qualification,
                             issolvency,
                             ispay,
                             lastamount,
                             recoverablescale,
                             recoverablebalancec,
                             disposalmoney,
                             lastbalanceall,
                             abstract1,
                             abstract2,
                             abstract3,
                             abstract4,
                             abstract5,
                             abstract6,
                             abstract7,
                             abstract8,
                             abstract9,
                             abstract10,
                             setupdate,
                             representative,
                             registemoney,
                             businesscope,
                             address,
                             cykind,
                             relationcode,
                             opertorvaluationdate,
                             transferbalance,
                             fxassetrate,
                             schemeid,
                             isalldeal,
                             assetsource,
                             assetsourcename,
                             abstract11,
                             abstract12,
                             predisposalperiod,
                             defaultinterest,
                             otherfee,
                             subcompanyreceivedate,
                             subcompanyreceivemoney,
                             litigationstatus,
                             mindealprice,
                             entertype,
                             propertynature,
                             escrowstatus,
                             assetseller,
                             baseday,
                             margin_balance,
                             recprecoverablescale,
                             recprecoverablebalance,
                             asset_category,
                             source,
                             is_continue_agency,
                             continue_agency
                        from SRC_LAYER.aics_asset_loanaccount_info
                      intersect
                      select loanaccountcode,
                             loanaccountnum,
                             loanaccountname,
                             loanstatus,
                             projectcode,
                             industrydetail,
                             provincecode,
                             cityno,
                             regioncode,
                             businesscondition,
                             corpusamount,
                             interest,
                             disbursementfee,
                             minquotedprice,
                             maxquotedprice,
                             loanaccountcosts,
                             replayrate,
                             memo,
                             enteruser,
                             entertime,
                             lastupdateuser,
                             lastupdatetime,
                             loanmanager,
                             evaluationuser,
                             reclaimscale,
                             currentscale,
                             quotationscale,
                             disposalyears,
                             balancecost,
                             currentbalance,
                             deductionten,
                             lasttimeloss,
                             lastbalance,
                             qualification,
                             issolvency,
                             ispay,
                             lastamount,
                             recoverablescale,
                             recoverablebalancec,
                             disposalmoney,
                             lastbalanceall,
                             abstract1,
                             abstract2,
                             abstract3,
                             abstract4,
                             abstract5,
                             abstract6,
                             abstract7,
                             abstract8,
                             abstract9,
                             abstract10,
                             setupdate,
                             representative,
                             registemoney,
                             businesscope,
                             address,
                             cykind,
                             relationcode,
                             opertorvaluationdate,
                             transferbalance,
                             fxassetrate,
                             schemeid,
                             isalldeal,
                             assetsource,
                             assetsourcename,
                             abstract11,
                             abstract12,
                             predisposalperiod,
                             defaultinterest,
                             otherfee,
                             subcompanyreceivedate,
                             subcompanyreceivemoney,
                             litigationstatus,
                             mindealprice,
                             entertype,
                             propertynature,
                             escrowstatus,
                             assetseller,
                             baseday,
                             margin_balance,
                             recprecoverablescale,
                             recprecoverablebalance,
                             asset_category,
                             source,
                             is_continue_agency,
                             continue_agency
                        from STD_LAYER.t01_asset_loanaccount_info));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_asset_loanaccount_info',
               'STD_LAYER.t01_asset_loanaccount_info',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_asset_loanaccount_info',
                 'STD_LAYER.t01_asset_loanaccount_info',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_asset_loanaccount_info;

  --update_creditor_vary_relation
  procedure update_creditor_vary_relation is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t08_creditor_vary_relation
     where start_date = query_date;
    update STD_LAYER.t08_creditor_vary_relation
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t08_creditor_vary_relation HIS
    using (select relationid,
                  ijourid,
                  creditorcontractcode,
                  ofeesetcorpusamount,
                  ofeesetinterest
             from SRC_LAYER.aics_creditor_vary_relation
           minus
           select relationid,
                  ijourid,
                  creditorcontractcode,
                  ofeesetcorpusamount,
                  ofeesetinterest
           
             from STD_LAYER.t08_creditor_vary_relation) DIF
    on (HIS.relationid = DIF.relationid)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t08_creditor_vary_relation
      select relationid,
             ijourid,
             creditorcontractcode,
             ofeesetcorpusamount,
             ofeesetinterest,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_creditor_vary_relation
       where relationid not in
             (select relationid
                from (select relationid,
                             ijourid,
                             creditorcontractcode,
                             ofeesetcorpusamount,
                             ofeesetinterest
                        from SRC_LAYER.aics_creditor_vary_relation
                      intersect
                      select relationid,
                             ijourid,
                             creditorcontractcode,
                             ofeesetcorpusamount,
                             ofeesetinterest
                        from STD_LAYER.t08_creditor_vary_relation));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_creditor_vary_relation',
               'STD_LAYER.t08_creditor_vary_relation',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_creditor_vary_relation',
                 'STD_LAYER.t08_creditor_vary_relation',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_creditor_vary_relation;

  --update_customer_info
  procedure update_customer_info is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t01_customer_info where start_date = query_date;
    update STD_LAYER.t01_customer_info
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t01_customer_info HIS
    using (select customercode,
                  customername,
                  customerproperty,
                  certificatetype,
                  certificatecode,
                  customercity,
                  isvalid,
                  createuser,
                  createtime,
                  updateuser,
                  updatetime,
                  entscale,
                  serialno,
                  rejecttype,
                  setupdate,
                  businesscope,
                  area,
                  status,
                  tempcode,
                  rejectcode,
                  listedflag,
                  enablesocialcredit,
                  industrydetail,
                  cino,
                  register_place,
                  nature,
                  qualification,
                  employee_num,
                  credit_date,
                  advance_kind,
                  advance_reason,
                  color_flag,
                  risk_custom_flag,
                  financial_report_flag,
                  finace_impor_custom,
                  flat_custom_flag,
                  develop_borough_flag,
                  yjh_risk_predict_flag,
                  custom_industry_flag,
                  green_credit_flag,
                  land_agent_admittance_flag,
                  cust_state_cisborder,
                  road_belong_department,
                  qualification_level,
                  govern_invest_cust_type,
                  marketing_class,
                  business_country,
                  description,
                  contrast_class,
                  impor_shift_cust,
                  govern_area,
                  belong_area,
                  last_person,
                  last_person_area,
                  staff_code,
                  last_modify_time,
                  customer_status,
                  nature2
             from SRC_LAYER.Aics_Customer_Info
           minus
           select customercode,
                  customername,
                  customerproperty,
                  certificatetype,
                  certificatecode,
                  customercity,
                  isvalid,
                  createuser,
                  createtime,
                  updateuser,
                  updatetime,
                  entscale,
                  serialno,
                  rejecttype,
                  setupdate,
                  businesscope,
                  area,
                  status,
                  tempcode,
                  rejectcode,
                  listedflag,
                  enablesocialcredit,
                  industrydetail,
                  cino,
                  register_place,
                  nature,
                  qualification,
                  employee_num,
                  credit_date,
                  advance_kind,
                  advance_reason,
                  color_flag,
                  risk_custom_flag,
                  financial_report_flag,
                  finace_impor_custom,
                  flat_custom_flag,
                  develop_borough_flag,
                  yjh_risk_predict_flag,
                  custom_industry_flag,
                  green_credit_flag,
                  land_agent_admittance_flag,
                  cust_state_cisborder,
                  road_belong_department,
                  qualification_level,
                  govern_invest_cust_type,
                  marketing_class,
                  business_country,
                  description,
                  contrast_class,
                  impor_shift_cust,
                  govern_area,
                  belong_area,
                  last_person,
                  last_person_area,
                  staff_code,
                  last_modify_time,
                  customer_status,
                  nature2
           
             from STD_LAYER.t01_customer_info) DIF
    on (HIS.customercode = DIF.customercode)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t01_customer_info
      select customercode,
             customername,
             customerproperty,
             certificatetype,
             certificatecode,
             customercity,
             isvalid,
             createuser,
             createtime,
             updateuser,
             updatetime,
             entscale,
             serialno,
             rejecttype,
             setupdate,
             businesscope,
             area,
             status,
             tempcode,
             rejectcode,
             listedflag,
             enablesocialcredit,
             industrydetail,
             cino,
             register_place,
             nature,
             qualification,
             employee_num,
             credit_date,
             advance_kind,
             advance_reason,
             color_flag,
             risk_custom_flag,
             financial_report_flag,
             finace_impor_custom,
             flat_custom_flag,
             develop_borough_flag,
             yjh_risk_predict_flag,
             custom_industry_flag,
             green_credit_flag,
             land_agent_admittance_flag,
             cust_state_cisborder,
             road_belong_department,
             qualification_level,
             govern_invest_cust_type,
             marketing_class,
             business_country,
             description,
             contrast_class,
             impor_shift_cust,
             govern_area,
             belong_area,
             last_person,
             last_person_area,
             staff_code,
             last_modify_time,
             customer_status,
             nature2,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_customer_info
       where customercode not in
             (select customercode
                from (select customercode,
                             customername,
                             customerproperty,
                             certificatetype,
                             certificatecode,
                             customercity,
                             isvalid,
                             createuser,
                             createtime,
                             updateuser,
                             updatetime,
                             entscale,
                             serialno,
                             rejecttype,
                             setupdate,
                             businesscope,
                             area,
                             status,
                             tempcode,
                             rejectcode,
                             listedflag,
                             enablesocialcredit,
                             industrydetail,
                             cino,
                             register_place,
                             nature,
                             qualification,
                             employee_num,
                             credit_date,
                             advance_kind,
                             advance_reason,
                             color_flag,
                             risk_custom_flag,
                             financial_report_flag,
                             finace_impor_custom,
                             flat_custom_flag,
                             develop_borough_flag,
                             yjh_risk_predict_flag,
                             custom_industry_flag,
                             green_credit_flag,
                             land_agent_admittance_flag,
                             cust_state_cisborder,
                             road_belong_department,
                             qualification_level,
                             govern_invest_cust_type,
                             marketing_class,
                             business_country,
                             description,
                             contrast_class,
                             impor_shift_cust,
                             govern_area,
                             belong_area,
                             last_person,
                             last_person_area,
                             staff_code,
                             last_modify_time,
                             customer_status,
                             nature2
                        from SRC_LAYER.aics_customer_info
                      intersect
                      select customercode,
                             customername,
                             customerproperty,
                             certificatetype,
                             certificatecode,
                             customercity,
                             isvalid,
                             createuser,
                             createtime,
                             updateuser,
                             updatetime,
                             entscale,
                             serialno,
                             rejecttype,
                             setupdate,
                             businesscope,
                             area,
                             status,
                             tempcode,
                             rejectcode,
                             listedflag,
                             enablesocialcredit,
                             industrydetail,
                             cino,
                             register_place,
                             nature,
                             qualification,
                             employee_num,
                             credit_date,
                             advance_kind,
                             advance_reason,
                             color_flag,
                             risk_custom_flag,
                             financial_report_flag,
                             finace_impor_custom,
                             flat_custom_flag,
                             develop_borough_flag,
                             yjh_risk_predict_flag,
                             custom_industry_flag,
                             green_credit_flag,
                             land_agent_admittance_flag,
                             cust_state_cisborder,
                             road_belong_department,
                             qualification_level,
                             govern_invest_cust_type,
                             marketing_class,
                             business_country,
                             description,
                             contrast_class,
                             impor_shift_cust,
                             govern_area,
                             belong_area,
                             last_person,
                             last_person_area,
                             staff_code,
                             last_modify_time,
                             customer_status,
                             nature2
                        from STD_LAYER.t01_customer_info));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_customer_info',
               'STD_LAYER.t01_customer_info',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_customer_info',
                 'STD_LAYER.t01_customer_info',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_customer_info;

  --update_equity_assets_info
  procedure update_equity_assets_info is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t08_equity_assets_info
     where start_date = query_date;
    update STD_LAYER.t08_equity_assets_info
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t08_equity_assets_info HIS
    using (select equityassetno,
                  equityassetname,
                  projectcode,
                  assetholder,
                  equitynature,
                  equitybalance,
                  stockamount,
                  equityratio,
                  equitystatus,
                  checkflag,
                  markettype,
                  enterprise,
                  investindustry,
                  cykind,
                  investbalance,
                  remark,
                  heldhandlestatus,
                  rejecttype,
                  propertynature,
                  updateuser,
                  accountvalue,
                  equityassetcode,
                  shareholding,
                  stockcode,
                  releasedate,
                  stockname,
                  holdingnumber,
                  carrycost,
                  carrybalance,
                  latestbalance,
                  predictyield,
                  predictyieldlimit,
                  realinvestdate,
                  serialno,
                  maininvestpart,
                  process_instanceid
             from SRC_LAYER.aics_equity_assets_info
           minus
           select equityassetno,
                  equityassetname,
                  projectcode,
                  assetholder,
                  equitynature,
                  equitybalance,
                  stockamount,
                  equityratio,
                  equitystatus,
                  checkflag,
                  markettype,
                  enterprise,
                  investindustry,
                  cykind,
                  investbalance,
                  remark,
                  heldhandlestatus,
                  rejecttype,
                  propertynature,
                  updateuser,
                  accountvalue,
                  equityassetcode,
                  shareholding,
                  stockcode,
                  releasedate,
                  stockname,
                  holdingnumber,
                  carrycost,
                  carrybalance,
                  latestbalance,
                  predictyield,
                  predictyieldlimit,
                  realinvestdate,
                  serialno,
                  maininvestpart,
                  process_instanceid
           
             from STD_LAYER.t08_equity_assets_info) DIF
    on (HIS.equityassetno = DIF.equityassetno)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t08_equity_assets_info
      select equityassetno,
             equityassetname,
             projectcode,
             assetholder,
             equitynature,
             equitybalance,
             stockamount,
             equityratio,
             equitystatus,
             checkflag,
             markettype,
             enterprise,
             investindustry,
             cykind,
             investbalance,
             remark,
             heldhandlestatus,
             rejecttype,
             propertynature,
             updateuser,
             accountvalue,
             equityassetcode,
             shareholding,
             stockcode,
             releasedate,
             stockname,
             holdingnumber,
             carrycost,
             carrybalance,
             latestbalance,
             predictyield,
             predictyieldlimit,
             realinvestdate,
             serialno,
             maininvestpart,
             process_instanceid,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_equity_assets_info
       where equityassetno not in
             (select equityassetno
                from (select equityassetno,
                             equityassetname,
                             projectcode,
                             assetholder,
                             equitynature,
                             equitybalance,
                             stockamount,
                             equityratio,
                             equitystatus,
                             checkflag,
                             markettype,
                             enterprise,
                             investindustry,
                             cykind,
                             investbalance,
                             remark,
                             heldhandlestatus,
                             rejecttype,
                             propertynature,
                             updateuser,
                             accountvalue,
                             equityassetcode,
                             shareholding,
                             stockcode,
                             releasedate,
                             stockname,
                             holdingnumber,
                             carrycost,
                             carrybalance,
                             latestbalance,
                             predictyield,
                             predictyieldlimit,
                             realinvestdate,
                             serialno,
                             maininvestpart,
                             process_instanceid
                        from SRC_LAYER.aics_equity_assets_info
                      intersect
                      select equityassetno,
                             equityassetname,
                             projectcode,
                             assetholder,
                             equitynature,
                             equitybalance,
                             stockamount,
                             equityratio,
                             equitystatus,
                             checkflag,
                             markettype,
                             enterprise,
                             investindustry,
                             cykind,
                             investbalance,
                             remark,
                             heldhandlestatus,
                             rejecttype,
                             propertynature,
                             updateuser,
                             accountvalue,
                             equityassetcode,
                             shareholding,
                             stockcode,
                             releasedate,
                             stockname,
                             holdingnumber,
                             carrycost,
                             carrybalance,
                             latestbalance,
                             predictyield,
                             predictyieldlimit,
                             realinvestdate,
                             serialno,
                             maininvestpart,
                             process_instanceid
                        from STD_LAYER.t08_equity_assets_info));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_equity_assets_info',
               'STD_LAYER.t08_equity_assets_info',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_equity_assets_info',
                 'STD_LAYER.t08_equity_assets_info',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_equity_assets_info;

  --update_invest_contract
  procedure update_invest_contract is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t04_invest_contract
     where start_date = query_date;
    update STD_LAYER.t04_invest_contract
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t04_invest_contract HIS
    using (select contractid,
                  projectcode,
                  rivalid,
                  contractno,
                  contractname,
                  signdate,
                  begdate,
                  prestopdate,
                  cykind,
                  contractbalance,
                  industry,
                  stcokamount,
                  investratio,
                  isrepurchase,
                  remark,
                  repurchaser,
                  extendillustration2,
                  stock_price,
                  investfundname,
                  interest,
                  stopinterestday,
                  startcountday,
                  debtamount,
                  accrualtaxrate,
                  startorg,
                  ischeckbycondition,
                  checkcondition,
                  maininvestpart,
                  isenjoyvoteright,
                  issendhighsup,
                  assetrate,
                  transferor,
                  dealtype,
                  purchasebanlance,
                  transfermoney,
                  paymenttype,
                  fxassetrate,
                  otherremark,
                  profitlevel,
                  investplantype,
                  underdescr
             from SRC_LAYER.aics_invest_contract
           minus
           select contractid,
                  projectcode,
                  rivalid,
                  contractno,
                  contractname,
                  signdate,
                  begdate,
                  prestopdate,
                  cykind,
                  contractbalance,
                  industry,
                  stcokamount,
                  investratio,
                  isrepurchase,
                  remark,
                  repurchaser,
                  extendillustration2,
                  stock_price,
                  investfundname,
                  interest,
                  stopinterestday,
                  startcountday,
                  debtamount,
                  accrualtaxrate,
                  startorg,
                  ischeckbycondition,
                  checkcondition,
                  maininvestpart,
                  isenjoyvoteright,
                  issendhighsup,
                  assetrate,
                  transferor,
                  dealtype,
                  purchasebanlance,
                  transfermoney,
                  paymenttype,
                  fxassetrate,
                  otherremark,
                  profitlevel,
                  investplantype,
                  underdescr
           
             from STD_LAYER.t04_invest_contract) DIF
    on (HIS.contractid = DIF.contractid)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t04_invest_contract
      select contractid,
             projectcode,
             rivalid,
             contractno,
             contractname,
             signdate,
             begdate,
             prestopdate,
             cykind,
             contractbalance,
             industry,
             stcokamount,
             investratio,
             isrepurchase,
             remark,
             repurchaser,
             extendillustration2,
             stock_price,
             investfundname,
             interest,
             stopinterestday,
             startcountday,
             debtamount,
             accrualtaxrate,
             startorg,
             ischeckbycondition,
             checkcondition,
             maininvestpart,
             isenjoyvoteright,
             issendhighsup,
             assetrate,
             transferor,
             dealtype,
             purchasebanlance,
             transfermoney,
             paymenttype,
             fxassetrate,
             otherremark,
             profitlevel,
             investplantype,
             underdescr,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_invest_contract
       where contractid not in
             (select contractid
                from (select contractid,
                             projectcode,
                             rivalid,
                             contractno,
                             contractname,
                             signdate,
                             begdate,
                             prestopdate,
                             cykind,
                             contractbalance,
                             industry,
                             stcokamount,
                             investratio,
                             isrepurchase,
                             remark,
                             repurchaser,
                             extendillustration2,
                             stock_price,
                             investfundname,
                             interest,
                             stopinterestday,
                             startcountday,
                             debtamount,
                             accrualtaxrate,
                             startorg,
                             ischeckbycondition,
                             checkcondition,
                             maininvestpart,
                             isenjoyvoteright,
                             issendhighsup,
                             assetrate,
                             transferor,
                             dealtype,
                             purchasebanlance,
                             transfermoney,
                             paymenttype,
                             fxassetrate,
                             otherremark,
                             profitlevel,
                             investplantype,
                             underdescr
                        from SRC_LAYER.aics_invest_contract
                      intersect
                      select contractid,
                             projectcode,
                             rivalid,
                             contractno,
                             contractname,
                             signdate,
                             begdate,
                             prestopdate,
                             cykind,
                             contractbalance,
                             industry,
                             stcokamount,
                             investratio,
                             isrepurchase,
                             remark,
                             repurchaser,
                             extendillustration2,
                             stock_price,
                             investfundname,
                             interest,
                             stopinterestday,
                             startcountday,
                             debtamount,
                             accrualtaxrate,
                             startorg,
                             ischeckbycondition,
                             checkcondition,
                             maininvestpart,
                             isenjoyvoteright,
                             issendhighsup,
                             assetrate,
                             transferor,
                             dealtype,
                             purchasebanlance,
                             transfermoney,
                             paymenttype,
                             fxassetrate,
                             otherremark,
                             profitlevel,
                             investplantype,
                             underdescr
                        from STD_LAYER.t04_invest_contract));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_invest_contract',
               'STD_LAYER.t04_invest_contract',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_invest_contract',
                 'STD_LAYER.t04_invest_contract',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_invest_contract;

  --update_invest_fundvary
  procedure update_invest_fundvary is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t08_invest_fundvary
     where start_date = query_date;
    update STD_LAYER.t08_invest_fundvary
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t08_invest_fundvary HIS
    using (select ijourid,
                  batchid,
                  preoccurdate,
                  occurdate,
                  projectcode,
                  subprojectcode,
                  investcode,
                  contractid,
                  assetid,
                  fundacid,
                  rivalid,
                  accoid,
                  cykind,
                  busiflag,
                  investtype,
                  investway,
                  funddir,
                  stockdir,
                  repayway,
                  extflag,
                  preoccur_balance,
                  principal,
                  begindate,
                  enddate,
                  profit,
                  deduction,
                  occur_balance,
                  payway,
                  isinvalid,
                  remark,
                  checkflag,
                  cretaway,
                  createtime,
                  createuser,
                  updatetime,
                  updateuser,
                  stcokamount,
                  investratio,
                  instanceid,
                  delaydays,
                  paymenaccount,
                  deposittype,
                  deposittransfertype,
                  process_instanceid,
                  stockamount,
                  postflag,
                  realinvestdate,
                  equityratio
             from SRC_LAYER.aics_invest_fundvary
           minus
           select ijourid,
                  batchid,
                  preoccurdate,
                  occurdate,
                  projectcode,
                  subprojectcode,
                  investcode,
                  contractid,
                  assetid,
                  fundacid,
                  rivalid,
                  accoid,
                  cykind,
                  busiflag,
                  investtype,
                  investway,
                  funddir,
                  stockdir,
                  repayway,
                  extflag,
                  preoccur_balance,
                  principal,
                  begindate,
                  enddate,
                  profit,
                  deduction,
                  occur_balance,
                  payway,
                  isinvalid,
                  remark,
                  checkflag,
                  cretaway,
                  createtime,
                  createuser,
                  updatetime,
                  updateuser,
                  stcokamount,
                  investratio,
                  instanceid,
                  delaydays,
                  paymenaccount,
                  deposittype,
                  deposittransfertype,
                  process_instanceid,
                  stockamount,
                  postflag,
                  realinvestdate,
                  equityratio
           
             from STD_LAYER.t08_invest_fundvary) DIF
    on (HIS.ijourid = DIF.ijourid)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t08_invest_fundvary
      select ijourid,
             batchid,
             preoccurdate,
             occurdate,
             projectcode,
             subprojectcode,
             investcode,
             contractid,
             assetid,
             fundacid,
             rivalid,
             accoid,
             cykind,
             busiflag,
             investtype,
             investway,
             funddir,
             stockdir,
             repayway,
             extflag,
             preoccur_balance,
             principal,
             begindate,
             enddate,
             profit,
             deduction,
             occur_balance,
             payway,
             isinvalid,
             remark,
             checkflag,
             cretaway,
             createtime,
             createuser,
             updatetime,
             updateuser,
             stcokamount,
             investratio,
             instanceid,
             delaydays,
             paymenaccount,
             deposittype,
             deposittransfertype,
             process_instanceid,
             stockamount,
             postflag,
             realinvestdate,
             equityratio,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_invest_fundvary
       where ijourid not in
             (select ijourid
                from (select ijourid,
                             batchid,
                             preoccurdate,
                             occurdate,
                             projectcode,
                             subprojectcode,
                             investcode,
                             contractid,
                             assetid,
                             fundacid,
                             rivalid,
                             accoid,
                             cykind,
                             busiflag,
                             investtype,
                             investway,
                             funddir,
                             stockdir,
                             repayway,
                             extflag,
                             preoccur_balance,
                             principal,
                             begindate,
                             enddate,
                             profit,
                             deduction,
                             occur_balance,
                             payway,
                             isinvalid,
                             remark,
                             checkflag,
                             cretaway,
                             createtime,
                             createuser,
                             updatetime,
                             updateuser,
                             stcokamount,
                             investratio,
                             instanceid,
                             delaydays,
                             paymenaccount,
                             deposittype,
                             deposittransfertype,
                             process_instanceid,
                             stockamount,
                             postflag,
                             realinvestdate,
                             equityratio
                        from SRC_LAYER.aics_invest_fundvary
                      intersect
                      select ijourid,
                             batchid,
                             preoccurdate,
                             occurdate,
                             projectcode,
                             subprojectcode,
                             investcode,
                             contractid,
                             assetid,
                             fundacid,
                             rivalid,
                             accoid,
                             cykind,
                             busiflag,
                             investtype,
                             investway,
                             funddir,
                             stockdir,
                             repayway,
                             extflag,
                             preoccur_balance,
                             principal,
                             begindate,
                             enddate,
                             profit,
                             deduction,
                             occur_balance,
                             payway,
                             isinvalid,
                             remark,
                             checkflag,
                             cretaway,
                             createtime,
                             createuser,
                             updatetime,
                             updateuser,
                             stcokamount,
                             investratio,
                             instanceid,
                             delaydays,
                             paymenaccount,
                             deposittype,
                             deposittransfertype,
                             process_instanceid,
                             stockamount,
                             postflag,
                             realinvestdate,
                             equityratio
                        from STD_LAYER.t08_invest_fundvary));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_invest_fundvary',
               'STD_LAYER.t08_invest_fundvary',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_invest_fundvary',
                 'STD_LAYER.t08_invest_fundvary',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_invest_fundvary;

  --update_invest_profitdetail
  procedure update_invest_profitdetail is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t08_invest_profitdetail
     where start_date = query_date;
    update STD_LAYER.t08_invest_profitdetail
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t08_invest_profitdetail HIS
    using (select pkid,
                  ijourid,
                  projectcode,
                  subprojectcode,
                  investcode,
                  contractid,
                  assetid,
                  repayway,
                  extflag,
                  profitkind,
                  occur_invest,
                  bdate,
                  edate,
                  settldate,
                  calcway,
                  rate,
                  profit,
                  balance,
                  afflid,
                  modiflag,
                  status,
                  rateid,
                  planid,
                  remark,
                  remitstatus,
                  extid,
                  days,
                  ratedays,
                  loanaccountcode,
                  repay_confirmdetail_id
             from SRC_LAYER.aics_invest_profitdetail
           minus
           select pkid,
                  ijourid,
                  projectcode,
                  subprojectcode,
                  investcode,
                  contractid,
                  assetid,
                  repayway,
                  extflag,
                  profitkind,
                  occur_invest,
                  bdate,
                  edate,
                  settldate,
                  calcway,
                  rate,
                  profit,
                  balance,
                  afflid,
                  modiflag,
                  status,
                  rateid,
                  planid,
                  remark,
                  remitstatus,
                  extid,
                  days,
                  ratedays,
                  loanaccountcode,
                  repay_confirmdetail_id
           
             from STD_LAYER.t08_invest_profitdetail) DIF
    on (HIS.pkid = DIF.pkid)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t08_invest_profitdetail
      select pkid,
             ijourid,
             projectcode,
             subprojectcode,
             investcode,
             contractid,
             assetid,
             repayway,
             extflag,
             profitkind,
             occur_invest,
             bdate,
             edate,
             settldate,
             calcway,
             rate,
             profit,
             balance,
             afflid,
             modiflag,
             status,
             rateid,
             planid,
             remark,
             remitstatus,
             extid,
             days,
             ratedays,
             loanaccountcode,
             repay_confirmdetail_id,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_invest_profitdetail
       where pkid not in
             (select pkid
                from (select pkid,
                             ijourid,
                             projectcode,
                             subprojectcode,
                             investcode,
                             contractid,
                             assetid,
                             repayway,
                             extflag,
                             profitkind,
                             occur_invest,
                             bdate,
                             edate,
                             settldate,
                             calcway,
                             rate,
                             profit,
                             balance,
                             afflid,
                             modiflag,
                             status,
                             rateid,
                             planid,
                             remark,
                             remitstatus,
                             extid,
                             days,
                             ratedays,
                             loanaccountcode,
                             repay_confirmdetail_id
                        from SRC_LAYER.aics_invest_profitdetail
                      intersect
                      select pkid,
                             ijourid,
                             projectcode,
                             subprojectcode,
                             investcode,
                             contractid,
                             assetid,
                             repayway,
                             extflag,
                             profitkind,
                             occur_invest,
                             bdate,
                             edate,
                             settldate,
                             calcway,
                             rate,
                             profit,
                             balance,
                             afflid,
                             modiflag,
                             status,
                             rateid,
                             planid,
                             remark,
                             remitstatus,
                             extid,
                             days,
                             ratedays,
                             loanaccountcode,
                             repay_confirmdetail_id
                        from STD_LAYER.t08_invest_profitdetail));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_invest_profitdetail',
               'STD_LAYER.t08_invest_profitdetail',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_invest_profitdetail',
                 'STD_LAYER.t08_invest_profitdetail',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_invest_profitdetail;

  --update_project_info
  procedure update_project_info is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t02_project_info where start_date = query_date;
    update STD_LAYER.t02_project_info
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t02_project_info HIS
    using (select projectcode,
                  projectname,
                  projectnature,
                  projectphase,
                  risktype,
                  fdcbusitype,
                  projectstatus,
                  dptid,
                  depcode,
                  assetseller,
                  servicebank,
                  moneytype,
                  predictinvestdate,
                  trustmanager,
                  projectteammembers,
                  isperfectturnstock,
                  durdiligencelaunchorg,
                  pshorgno,
                  amccustomerno,
                  framesignedmoney,
                  applyinvestmoney,
                  producttype,
                  financingname,
                  belongtoindustry,
                  companynature,
                  creditrating,
                  istraded,
                  registeredcapital,
                  locatedarea,
                  predebtratio,
                  afterdebtratio,
                  extfield10,
                  predictinvestlimit,
                  investintentmemo,
                  channelcostmemo,
                  fundtrustee,
                  isneeddirector,
                  isneedsupervisor,
                  droptype,
                  dropdescribe,
                  predictyield,
                  predictyieldexplain,
                  debtsum,
                  debtcorpusamount,
                  debtinterest,
                  applyowninvestmoney,
                  isleavedebt,
                  leavedebtmoney,
                  leavedebtdescribe,
                  investedcompany,
                  financialproducttype,
                  financialproductcode,
                  prebalancesum,
                  timelimit,
                  distributionmode,
                  stockpremiumrate,
                  initstockprice,
                  parvaluerate,
                  redeemprice,
                  exchagnestockbeginday,
                  initpledgerate,
                  additionalguarantee,
                  lowrepairclause,
                  redemptionclause,
                  resaleclause,
                  isintermechanism,
                  servicecontentdescribe,
                  dbms_lob.substr(investtarget, 4000) as investtarget,
                  dbms_lob.substr(capital, 4000) as capital,
                  dbms_lob.substr(framework, 4000) as framework,
                  dbms_lob.substr(partyinfo, 4000) as partyinfo,
                  dbms_lob.substr(tasset, 4000) as tasset
             from SRC_LAYER.aics_project_info
           minus
           select projectcode,
                  projectname,
                  projectnature,
                  projectphase,
                  risktype,
                  fdcbusitype,
                  projectstatus,
                  dptid,
                  depcode,
                  assetseller,
                  servicebank,
                  moneytype,
                  predictinvestdate,
                  trustmanager,
                  projectteammembers,
                  isperfectturnstock,
                  durdiligencelaunchorg,
                  pshorgno,
                  amccustomerno,
                  framesignedmoney,
                  applyinvestmoney,
                  producttype,
                  financingname,
                  belongtoindustry,
                  companynature,
                  creditrating,
                  istraded,
                  registeredcapital,
                  locatedarea,
                  predebtratio,
                  afterdebtratio,
                  extfield10,
                  predictinvestlimit,
                  investintentmemo,
                  channelcostmemo,
                  fundtrustee,
                  isneeddirector,
                  isneedsupervisor,
                  droptype,
                  dropdescribe,
                  predictyield,
                  predictyieldexplain,
                  debtsum,
                  debtcorpusamount,
                  debtinterest,
                  applyowninvestmoney,
                  isleavedebt,
                  leavedebtmoney,
                  leavedebtdescribe,
                  investedcompany,
                  financialproducttype,
                  financialproductcode,
                  prebalancesum,
                  timelimit,
                  distributionmode,
                  stockpremiumrate,
                  initstockprice,
                  parvaluerate,
                  redeemprice,
                  exchagnestockbeginday,
                  initpledgerate,
                  additionalguarantee,
                  lowrepairclause,
                  redemptionclause,
                  resaleclause,
                  isintermechanism,
                  servicecontentdescribe,
                  dbms_lob.substr(investtarget, 4000) as investtarget,
                  dbms_lob.substr(capital, 4000) as capital,
                  dbms_lob.substr(framework, 4000) as framework,
                  dbms_lob.substr(partyinfo, 4000) as partyinfo,
                  dbms_lob.substr(tasset, 4000) as tasset
           
             from STD_LAYER.t02_project_info) DIF
    on (HIS.projectcode = DIF.projectcode)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t02_project_info
      select projectcode,
             projectname,
             projectnature,
             projectphase,
             risktype,
             fdcbusitype,
             projectstatus,
             dptid,
             depcode,
             assetseller,
             servicebank,
             moneytype,
             predictinvestdate,
             trustmanager,
             projectteammembers,
             isperfectturnstock,
             durdiligencelaunchorg,
             pshorgno,
             amccustomerno,
             framesignedmoney,
             applyinvestmoney,
             producttype,
             financingname,
             belongtoindustry,
             companynature,
             creditrating,
             istraded,
             registeredcapital,
             locatedarea,
             predebtratio,
             afterdebtratio,
             extfield10,
             predictinvestlimit,
             investintentmemo,
             channelcostmemo,
             fundtrustee,
             isneeddirector,
             isneedsupervisor,
             droptype,
             dropdescribe,
             predictyield,
             predictyieldexplain,
             debtsum,
             debtcorpusamount,
             debtinterest,
             applyowninvestmoney,
             isleavedebt,
             leavedebtmoney,
             leavedebtdescribe,
             investedcompany,
             financialproducttype,
             financialproductcode,
             prebalancesum,
             timelimit,
             distributionmode,
             stockpremiumrate,
             initstockprice,
             parvaluerate,
             redeemprice,
             exchagnestockbeginday,
             initpledgerate,
             additionalguarantee,
             lowrepairclause,
             redemptionclause,
             resaleclause,
             isintermechanism,
             servicecontentdescribe,
             investtarget,
             capital,
             framework,
             partyinfo,
             tasset,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_project_info
       where projectcode not in
             (select projectcode
                from (select projectcode,
                             projectname,
                             projectnature,
                             projectphase,
                             risktype,
                             fdcbusitype,
                             projectstatus,
                             dptid,
                             depcode,
                             assetseller,
                             servicebank,
                             moneytype,
                             predictinvestdate,
                             trustmanager,
                             projectteammembers,
                             isperfectturnstock,
                             durdiligencelaunchorg,
                             pshorgno,
                             amccustomerno,
                             framesignedmoney,
                             applyinvestmoney,
                             producttype,
                             financingname,
                             belongtoindustry,
                             companynature,
                             creditrating,
                             istraded,
                             registeredcapital,
                             locatedarea,
                             predebtratio,
                             afterdebtratio,
                             extfield10,
                             predictinvestlimit,
                             investintentmemo,
                             channelcostmemo,
                             fundtrustee,
                             isneeddirector,
                             isneedsupervisor,
                             droptype,
                             dropdescribe,
                             predictyield,
                             predictyieldexplain,
                             debtsum,
                             debtcorpusamount,
                             debtinterest,
                             applyowninvestmoney,
                             isleavedebt,
                             leavedebtmoney,
                             leavedebtdescribe,
                             investedcompany,
                             financialproducttype,
                             financialproductcode,
                             prebalancesum,
                             timelimit,
                             distributionmode,
                             stockpremiumrate,
                             initstockprice,
                             parvaluerate,
                             redeemprice,
                             exchagnestockbeginday,
                             initpledgerate,
                             additionalguarantee,
                             lowrepairclause,
                             redemptionclause,
                             resaleclause,
                             isintermechanism,
                             servicecontentdescribe,
                             dbms_lob.substr(investtarget, 4000) as investtarget,
                             dbms_lob.substr(capital, 4000) as capital,
                             dbms_lob.substr(framework, 4000) as framework,
                             dbms_lob.substr(partyinfo, 4000) as partyinfo,
                             dbms_lob.substr(tasset, 4000) as tasset
                        from SRC_LAYER.aics_project_info
                      intersect
                      select projectcode,
                             projectname,
                             projectnature,
                             projectphase,
                             risktype,
                             fdcbusitype,
                             projectstatus,
                             dptid,
                             depcode,
                             assetseller,
                             servicebank,
                             moneytype,
                             predictinvestdate,
                             trustmanager,
                             projectteammembers,
                             isperfectturnstock,
                             durdiligencelaunchorg,
                             pshorgno,
                             amccustomerno,
                             framesignedmoney,
                             applyinvestmoney,
                             producttype,
                             financingname,
                             belongtoindustry,
                             companynature,
                             creditrating,
                             istraded,
                             registeredcapital,
                             locatedarea,
                             predebtratio,
                             afterdebtratio,
                             extfield10,
                             predictinvestlimit,
                             investintentmemo,
                             channelcostmemo,
                             fundtrustee,
                             isneeddirector,
                             isneedsupervisor,
                             droptype,
                             dropdescribe,
                             predictyield,
                             predictyieldexplain,
                             debtsum,
                             debtcorpusamount,
                             debtinterest,
                             applyowninvestmoney,
                             isleavedebt,
                             leavedebtmoney,
                             leavedebtdescribe,
                             investedcompany,
                             financialproducttype,
                             financialproductcode,
                             prebalancesum,
                             timelimit,
                             distributionmode,
                             stockpremiumrate,
                             initstockprice,
                             parvaluerate,
                             redeemprice,
                             exchagnestockbeginday,
                             initpledgerate,
                             additionalguarantee,
                             lowrepairclause,
                             redemptionclause,
                             resaleclause,
                             isintermechanism,
                             servicecontentdescribe,
                             dbms_lob.substr(investtarget, 4000) as investtarget,
                             dbms_lob.substr(capital, 4000) as capital,
                             dbms_lob.substr(framework, 4000) as framework,
                             dbms_lob.substr(partyinfo, 4000) as partyinfo,
                             dbms_lob.substr(tasset, 4000) as tasset
                        from STD_LAYER.t02_project_info));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_project_info',
               'STD_LAYER.t02_project_info',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_project_info',
                 'STD_LAYER.t02_project_info',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_project_info;

  --update_repay_info
  procedure update_repay_info is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t05_repay_info where start_date = query_date;
    update STD_LAYER.t05_repay_info
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t05_repay_info HIS
    using (select id,
                  process_instanceid,
                  projectcode,
                  contractid,
                  loanaccountcode,
                  type,
                  rivalid,
                  accoid,
                  cykind,
                  preoccurdate,
                  preoccur_balance,
                  occur_balance,
                  payable,
                  purchase,
                  deposittype,
                  isdebts,
                  remark,
                  invoice,
                  payway,
                  paysource,
                  checkflag,
                  creater,
                  create_date,
                  isoutpace,
                  afflid,
                  isdebtsloan,
                  ouramount,
                  customerfund,
                  subjectno,
                  acquisitiontype,
                  contractstate,
                  contractcheck,
                  contractexamine,
                  approvestate,
                  approvecheck,
                  approveexamine,
                  approvepid,
                  contractpid,
                  paystatus,
                  acconame,
                  bankname,
                  bankacco,
                  taxamount,
                  usercode,
                  receiptcode,
                  receiptdate,
                  reimburseunit,
                  department,
                  pay_description,
                  errormsg,
                  batchno,
                  rincome,
                  rcapital,
                  repayplanid,
                  istocapitalsys,
                  amount_without_tax,
                  other_payname,
                  equity_invest_type,
                  payment_number_no,
                  payment_number_name,
                  fund_carry_out,
                  payment_company,
                  approve_no,
                  pay_category
             from SRC_LAYER.aics_repay_info
           minus
           select id,
                  process_instanceid,
                  projectcode,
                  contractid,
                  loanaccountcode,
                  type,
                  rivalid,
                  accoid,
                  cykind,
                  preoccurdate,
                  preoccur_balance,
                  occur_balance,
                  payable,
                  purchase,
                  deposittype,
                  isdebts,
                  remark,
                  invoice,
                  payway,
                  paysource,
                  checkflag,
                  creater,
                  create_date,
                  isoutpace,
                  afflid,
                  isdebtsloan,
                  ouramount,
                  customerfund,
                  subjectno,
                  acquisitiontype,
                  contractstate,
                  contractcheck,
                  contractexamine,
                  approvestate,
                  approvecheck,
                  approveexamine,
                  approvepid,
                  contractpid,
                  paystatus,
                  acconame,
                  bankname,
                  bankacco,
                  taxamount,
                  usercode,
                  receiptcode,
                  receiptdate,
                  reimburseunit,
                  department,
                  pay_description,
                  errormsg,
                  batchno,
                  rincome,
                  rcapital,
                  repayplanid,
                  istocapitalsys,
                  amount_without_tax,
                  other_payname,
                  equity_invest_type,
                  payment_number_no,
                  payment_number_name,
                  fund_carry_out,
                  payment_company,
                  approve_no,
                  pay_category
           
             from STD_LAYER.t05_repay_info) DIF
    on (HIS.id = DIF.id)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t05_repay_info
      select id,
             process_instanceid,
             projectcode,
             contractid,
             loanaccountcode,
             type,
             rivalid,
             accoid,
             cykind,
             preoccurdate,
             preoccur_balance,
             occur_balance,
             payable,
             purchase,
             deposittype,
             isdebts,
             remark,
             invoice,
             payway,
             paysource,
             checkflag,
             creater,
             create_date,
             isoutpace,
             afflid,
             isdebtsloan,
             ouramount,
             customerfund,
             subjectno,
             acquisitiontype,
             contractstate,
             contractcheck,
             contractexamine,
             approvestate,
             approvecheck,
             approveexamine,
             approvepid,
             contractpid,
             paystatus,
             acconame,
             bankname,
             bankacco,
             taxamount,
             usercode,
             receiptcode,
             receiptdate,
             reimburseunit,
             department,
             pay_description,
             errormsg,
             batchno,
             rincome,
             rcapital,
             repayplanid,
             istocapitalsys,
             amount_without_tax,
             other_payname,
             equity_invest_type,
             payment_number_no,
             payment_number_name,
             fund_carry_out,
             payment_company,
             approve_no,
             pay_category,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_repay_info
       where id not in (select id
                          from (select id,
                                       process_instanceid,
                                       projectcode,
                                       contractid,
                                       loanaccountcode,
                                       type,
                                       rivalid,
                                       accoid,
                                       cykind,
                                       preoccurdate,
                                       preoccur_balance,
                                       occur_balance,
                                       payable,
                                       purchase,
                                       deposittype,
                                       isdebts,
                                       remark,
                                       invoice,
                                       payway,
                                       paysource,
                                       checkflag,
                                       creater,
                                       create_date,
                                       isoutpace,
                                       afflid,
                                       isdebtsloan,
                                       ouramount,
                                       customerfund,
                                       subjectno,
                                       acquisitiontype,
                                       contractstate,
                                       contractcheck,
                                       contractexamine,
                                       approvestate,
                                       approvecheck,
                                       approveexamine,
                                       approvepid,
                                       contractpid,
                                       paystatus,
                                       acconame,
                                       bankname,
                                       bankacco,
                                       taxamount,
                                       usercode,
                                       receiptcode,
                                       receiptdate,
                                       reimburseunit,
                                       department,
                                       pay_description,
                                       errormsg,
                                       batchno,
                                       rincome,
                                       rcapital,
                                       repayplanid,
                                       istocapitalsys,
                                       amount_without_tax,
                                       other_payname,
                                       equity_invest_type,
                                       payment_number_no,
                                       payment_number_name,
                                       fund_carry_out,
                                       payment_company,
                                       approve_no,
                                       pay_category
                                  from SRC_LAYER.aics_repay_info
                                intersect
                                select id,
                                       process_instanceid,
                                       projectcode,
                                       contractid,
                                       loanaccountcode,
                                       type,
                                       rivalid,
                                       accoid,
                                       cykind,
                                       preoccurdate,
                                       preoccur_balance,
                                       occur_balance,
                                       payable,
                                       purchase,
                                       deposittype,
                                       isdebts,
                                       remark,
                                       invoice,
                                       payway,
                                       paysource,
                                       checkflag,
                                       creater,
                                       create_date,
                                       isoutpace,
                                       afflid,
                                       isdebtsloan,
                                       ouramount,
                                       customerfund,
                                       subjectno,
                                       acquisitiontype,
                                       contractstate,
                                       contractcheck,
                                       contractexamine,
                                       approvestate,
                                       approvecheck,
                                       approveexamine,
                                       approvepid,
                                       contractpid,
                                       paystatus,
                                       acconame,
                                       bankname,
                                       bankacco,
                                       taxamount,
                                       usercode,
                                       receiptcode,
                                       receiptdate,
                                       reimburseunit,
                                       department,
                                       pay_description,
                                       errormsg,
                                       batchno,
                                       rincome,
                                       rcapital,
                                       repayplanid,
                                       istocapitalsys,
                                       amount_without_tax,
                                       other_payname,
                                       equity_invest_type,
                                       payment_number_no,
                                       payment_number_name,
                                       fund_carry_out,
                                       payment_company,
                                       approve_no,
                                       pay_category
                                  from STD_LAYER.t05_repay_info));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_repay_info',
               'STD_LAYER.t05_repay_info',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_repay_info',
                 'STD_LAYER.t05_repay_info',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_repay_info;

  --update_asset_creditor_relation
  procedure update_asset_creditor_relation is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t04_asset_creditor_relation
     where start_date = query_date;
    update STD_LAYER.t04_asset_creditor_relation
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t04_asset_creditor_relation HIS
    using (select relationcode,
                  relationtype,
                  creditorcontractcode,
                  guaranteecontractcode
             from SRC_LAYER.aics_asset_creditor_relation
           minus
           select relationcode,
                  relationtype,
                  creditorcontractcode,
                  guaranteecontractcode
           
             from STD_LAYER.t04_asset_creditor_relation) DIF
    on (HIS.relationcode = DIF.relationcode)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t04_asset_creditor_relation
      select relationcode,
             relationtype,
             creditorcontractcode,
             guaranteecontractcode,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_asset_creditor_relation
       where relationcode not in
             (select relationcode
                from (select relationcode,
                             relationtype,
                             creditorcontractcode,
                             guaranteecontractcode
                        from SRC_LAYER.aics_asset_creditor_relation
                      intersect
                      select relationcode,
                             relationtype,
                             creditorcontractcode,
                             guaranteecontractcode
                        from STD_LAYER.t04_asset_creditor_relation));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_asset_creditor_relation',
               'STD_LAYER.t04_asset_creditor_relation',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_asset_creditor_relation',
                 'STD_LAYER.t04_asset_creditor_relation',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_asset_creditor_relation;

  --update_asset_creditorcontract
  procedure update_asset_creditorcontract is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t04_asset_creditorcontract
     where start_date = query_date;
    update STD_LAYER.t04_asset_creditorcontract
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t04_asset_creditorcontract HIS
    using (select creditorcontractcode,
                  creditorcontractnum,
                  loanano,
                  loanaccountcode,
                  headbank,
                  branchbank,
                  contractstartdate,
                  contractenddate,
                  corpusamount,
                  interest,
                  defaultinterest,
                  compoundinterest,
                  iscalcinterest,
                  contractsigndate,
                  isbantransfer,
                  lawdeaddate,
                  creditorcontractphase,
                  creditorcontractstatus,
                  rejecttype,
                  tempcode,
                  enteruser,
                  entertime,
                  lastupdateuser,
                  lastupdatetime,
                  credittype,
                  cykind,
                  propertynature,
                  escrowstatus,
                  contractloandate,
                  contractnum,
                  projectcode,
                  contractid,
                  creditorassettype,
                  creditorassetcode
             from SRC_LAYER.aics_asset_creditorcontract
           minus
           select creditorcontractcode,
                  creditorcontractnum,
                  loanano,
                  loanaccountcode,
                  headbank,
                  branchbank,
                  contractstartdate,
                  contractenddate,
                  corpusamount,
                  interest,
                  defaultinterest,
                  compoundinterest,
                  iscalcinterest,
                  contractsigndate,
                  isbantransfer,
                  lawdeaddate,
                  creditorcontractphase,
                  creditorcontractstatus,
                  rejecttype,
                  tempcode,
                  enteruser,
                  entertime,
                  lastupdateuser,
                  lastupdatetime,
                  credittype,
                  cykind,
                  propertynature,
                  escrowstatus,
                  contractloandate,
                  contractnum,
                  projectcode,
                  contractid,
                  creditorassettype,
                  creditorassetcode
           
             from STD_LAYER.t04_asset_creditorcontract) DIF
    on (HIS.creditorcontractcode = DIF.creditorcontractcode)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t04_asset_creditorcontract
      select creditorcontractcode,
             creditorcontractnum,
             loanano,
             loanaccountcode,
             headbank,
             branchbank,
             contractstartdate,
             contractenddate,
             corpusamount,
             interest,
             defaultinterest,
             compoundinterest,
             iscalcinterest,
             contractsigndate,
             isbantransfer,
             lawdeaddate,
             creditorcontractphase,
             creditorcontractstatus,
             rejecttype,
             tempcode,
             enteruser,
             entertime,
             lastupdateuser,
             lastupdatetime,
             credittype,
             cykind,
             propertynature,
             escrowstatus,
             contractloandate,
             contractnum,
             projectcode,
             contractid,
             creditorassettype,
             creditorassetcode,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_asset_creditorcontract
       where creditorcontractcode not in
             (select creditorcontractcode
                from (select creditorcontractcode,
                             creditorcontractnum,
                             loanano,
                             loanaccountcode,
                             headbank,
                             branchbank,
                             contractstartdate,
                             contractenddate,
                             corpusamount,
                             interest,
                             defaultinterest,
                             compoundinterest,
                             iscalcinterest,
                             contractsigndate,
                             isbantransfer,
                             lawdeaddate,
                             creditorcontractphase,
                             creditorcontractstatus,
                             rejecttype,
                             tempcode,
                             enteruser,
                             entertime,
                             lastupdateuser,
                             lastupdatetime,
                             credittype,
                             cykind,
                             propertynature,
                             escrowstatus,
                             contractloandate,
                             contractnum,
                             projectcode,
                             contractid,
                             creditorassettype,
                             creditorassetcode
                        from SRC_LAYER.aics_asset_creditorcontract
                      intersect
                      select creditorcontractcode,
                             creditorcontractnum,
                             loanano,
                             loanaccountcode,
                             headbank,
                             branchbank,
                             contractstartdate,
                             contractenddate,
                             corpusamount,
                             interest,
                             defaultinterest,
                             compoundinterest,
                             iscalcinterest,
                             contractsigndate,
                             isbantransfer,
                             lawdeaddate,
                             creditorcontractphase,
                             creditorcontractstatus,
                             rejecttype,
                             tempcode,
                             enteruser,
                             entertime,
                             lastupdateuser,
                             lastupdatetime,
                             credittype,
                             cykind,
                             propertynature,
                             escrowstatus,
                             contractloandate,
                             contractnum,
                             projectcode,
                             contractid,
                             creditorassettype,
                             creditorassetcode
                        from STD_LAYER.t04_asset_creditorcontract));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_asset_creditorcontract',
               'STD_LAYER.t04_asset_creditorcontract',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_asset_creditorcontract',
                 'STD_LAYER.t04_asset_creditorcontract',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_asset_creditorcontract;

  --update_asset_guaranteecontract
  procedure update_asset_guaranteecontract is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t04_asset_guaranteecontract
     where start_date = query_date;
    update STD_LAYER.t04_asset_guaranteecontract
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t04_asset_guaranteecontract HIS
    using (select guaranteecontractcode,
                  guaranteecontractno,
                  guaranteecontractnum,
                  guaranteetype,
                  relationcode,
                  guaranteeamount,
                  remainingguaranteeamount,
                  guaranteestartdate,
                  guaranteeenddate,
                  guaranteeperiod,
                  guaranteestatus,
                  enteruser,
                  entertime,
                  lastupdateuser,
                  lastupdatetime,
                  operatingstatus,
                  qualification,
                  recoverablebalancec,
                  disposalmoney,
                  disposalyears,
                  balancecost,
                  currentbalance,
                  deductionten,
                  lasttimeloss,
                  lastbalance,
                  isguaranteetype,
                  escrowstatus,
                  cykind,
                  limitationexpdate
             from SRC_LAYER.aics_asset_guaranteecontract
           minus
           select guaranteecontractcode,
                  guaranteecontractno,
                  guaranteecontractnum,
                  guaranteetype,
                  relationcode,
                  guaranteeamount,
                  remainingguaranteeamount,
                  guaranteestartdate,
                  guaranteeenddate,
                  guaranteeperiod,
                  guaranteestatus,
                  enteruser,
                  entertime,
                  lastupdateuser,
                  lastupdatetime,
                  operatingstatus,
                  qualification,
                  recoverablebalancec,
                  disposalmoney,
                  disposalyears,
                  balancecost,
                  currentbalance,
                  deductionten,
                  lasttimeloss,
                  lastbalance,
                  isguaranteetype,
                  escrowstatus,
                  cykind,
                  limitationexpdate
           
             from STD_LAYER.t04_asset_guaranteecontract) DIF
    on (HIS.guaranteecontractcode = DIF.guaranteecontractcode)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t04_asset_guaranteecontract
      select guaranteecontractcode,
             guaranteecontractno,
             guaranteecontractnum,
             guaranteetype,
             relationcode,
             guaranteeamount,
             remainingguaranteeamount,
             guaranteestartdate,
             guaranteeenddate,
             guaranteeperiod,
             guaranteestatus,
             enteruser,
             entertime,
             lastupdateuser,
             lastupdatetime,
             operatingstatus,
             qualification,
             recoverablebalancec,
             disposalmoney,
             disposalyears,
             balancecost,
             currentbalance,
             deductionten,
             lasttimeloss,
             lastbalance,
             isguaranteetype,
             escrowstatus,
             cykind,
             limitationexpdate,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_asset_guaranteecontract
       where guaranteecontractcode not in
             (select guaranteecontractcode
                from (select guaranteecontractcode,
                             guaranteecontractno,
                             guaranteecontractnum,
                             guaranteetype,
                             relationcode,
                             guaranteeamount,
                             remainingguaranteeamount,
                             guaranteestartdate,
                             guaranteeenddate,
                             guaranteeperiod,
                             guaranteestatus,
                             enteruser,
                             entertime,
                             lastupdateuser,
                             lastupdatetime,
                             operatingstatus,
                             qualification,
                             recoverablebalancec,
                             disposalmoney,
                             disposalyears,
                             balancecost,
                             currentbalance,
                             deductionten,
                             lasttimeloss,
                             lastbalance,
                             isguaranteetype,
                             escrowstatus,
                             cykind,
                             limitationexpdate
                        from SRC_LAYER.aics_asset_guaranteecontract
                      intersect
                      select guaranteecontractcode,
                             guaranteecontractno,
                             guaranteecontractnum,
                             guaranteetype,
                             relationcode,
                             guaranteeamount,
                             remainingguaranteeamount,
                             guaranteestartdate,
                             guaranteeenddate,
                             guaranteeperiod,
                             guaranteestatus,
                             enteruser,
                             entertime,
                             lastupdateuser,
                             lastupdatetime,
                             operatingstatus,
                             qualification,
                             recoverablebalancec,
                             disposalmoney,
                             disposalyears,
                             balancecost,
                             currentbalance,
                             deductionten,
                             lasttimeloss,
                             lastbalance,
                             isguaranteetype,
                             escrowstatus,
                             cykind,
                             limitationexpdate
                        from STD_LAYER.t04_asset_guaranteecontract));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_asset_guaranteecontract',
               'STD_LAYER.t04_asset_guaranteecontract',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_asset_guaranteecontract',
                 'STD_LAYER.t04_asset_guaranteecontract',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_asset_guaranteecontract;

  --update_asset_loanaccount
  procedure update_asset_loanaccount is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t01_asset_loanaccount
     where start_date = query_date;
    update STD_LAYER.t01_asset_loanaccount
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t01_asset_loanaccount HIS
    using (select projectcode,
                  subprojectcode,
                  loanaccountcode,
                  init_balance,
                  current_balance,
                  frozen_balance,
                  unfrozen_balance,
                  current_assetcost,
                  moneytype,
                  createuser,
                  createtime,
                  updateuser,
                  updatetime
             from SRC_LAYER.aics_asset_loanaccount
           minus
           select projectcode,
                  subprojectcode,
                  loanaccountcode,
                  init_balance,
                  current_balance,
                  frozen_balance,
                  unfrozen_balance,
                  current_assetcost,
                  moneytype,
                  createuser,
                  createtime,
                  updateuser,
                  updatetime
           
             from STD_LAYER.t01_asset_loanaccount) DIF
    on (HIS.projectcode = DIF.projectcode)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t01_asset_loanaccount
      select projectcode,
             subprojectcode,
             loanaccountcode,
             init_balance,
             current_balance,
             frozen_balance,
             unfrozen_balance,
             current_assetcost,
             moneytype,
             createuser,
             createtime,
             updateuser,
             updatetime,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_asset_loanaccount
       where projectcode not in
             (select projectcode
                from (select projectcode,
                             subprojectcode,
                             loanaccountcode,
                             init_balance,
                             current_balance,
                             frozen_balance,
                             unfrozen_balance,
                             current_assetcost,
                             moneytype,
                             createuser,
                             createtime,
                             updateuser,
                             updatetime
                        from SRC_LAYER.aics_asset_loanaccount
                      intersect
                      select projectcode,
                             subprojectcode,
                             loanaccountcode,
                             init_balance,
                             current_balance,
                             frozen_balance,
                             unfrozen_balance,
                             current_assetcost,
                             moneytype,
                             createuser,
                             createtime,
                             updateuser,
                             updatetime
                        from STD_LAYER.t01_asset_loanaccount));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_asset_loanaccount',
               'STD_LAYER.t01_asset_loanaccount',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_asset_loanaccount',
                 'STD_LAYER.t01_asset_loanaccount',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_asset_loanaccount;

  --update_asset_mortgagecontract
  procedure update_asset_mortgagecontract is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t04_asset_mortgagecontract
     where start_date = query_date;
    update STD_LAYER.t04_asset_mortgagecontract
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t04_asset_mortgagecontract HIS
    using (select mortgagecontractcode,
                  mortgagecontractno,
                  mortgagetype,
                  mortgagestartdate,
                  mortgageenddate,
                  mortgagorcode,
                  mortgagemaxmoney
             from SRC_LAYER.aics_asset_mortgagecontract
           minus
           select mortgagecontractcode,
                  mortgagecontractno,
                  mortgagetype,
                  mortgagestartdate,
                  mortgageenddate,
                  mortgagorcode,
                  mortgagemaxmoney
             from STD_LAYER.t04_asset_mortgagecontract) DIF
    on (HIS.mortgagecontractcode = DIF.mortgagecontractcode)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t04_asset_mortgagecontract
      select mortgagecontractcode,
             mortgagecontractno,
             mortgagetype,
             mortgagestartdate,
             mortgageenddate,
             mortgagorcode,
             mortgagemaxmoney,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_asset_mortgagecontract
       where mortgagecontractcode not in
             (select mortgagecontractcode
                from (select mortgagecontractcode,
                             mortgagecontractno,
                             mortgagetype,
                             mortgagestartdate,
                             mortgageenddate,
                             mortgagorcode,
                             mortgagemaxmoney
                        from SRC_LAYER.aics_asset_mortgagecontract
                      intersect
                      select mortgagecontractcode,
                             mortgagecontractno,
                             mortgagetype,
                             mortgagestartdate,
                             mortgageenddate,
                             mortgagorcode,
                             mortgagemaxmoney
                        from STD_LAYER.t04_asset_mortgagecontract));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_asset_mortgagecontract',
               'STD_LAYER.t04_asset_mortgagecontract',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_asset_mortgagecontract',
                 'STD_LAYER.t04_asset_mortgagecontract',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_asset_mortgagecontract;

  --update_asset_pawn_info
  procedure update_asset_pawn_info is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t05_asset_pawn_info
     where start_date = query_date;
    update STD_LAYER.t05_asset_pawn_info
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t05_asset_pawn_info HIS
    using (select pawncode,
                  pawnnum,
                  pawnname,
                  mortgagecontractcode,
                  provincecode,
                  cityno,
                  regioncode,
                  pawntype,
                  othercredentialsno,
                  originalcredentialsno,
                  pawnamount,
                  pawnstatus,
                  pawnarea,
                  houseare,
                  marketprice,
                  cashprice,
                  cashrate,
                  quoteprice,
                  buyprice,
                  enteruser,
                  entertime,
                  lastupdateuser,
                  lastupdatetime,
                  disposalyears,
                  balancecost,
                  currentbalance,
                  deductionten,
                  lasttimeloss,
                  lastbalance,
                  pawndetail,
                  recoverablebalance,
                  disposalmoney,
                  schemeid,
                  type,
                  place,
                  source,
                  valuationamount,
                  escrowstatus,
                  remark,
                  pawnregdate,
                  addrdetail,
                  cykind,
                  pawnquantity,
                  pawnunit,
                  recpmarketprice,
                  recpcashprice,
                  recpcashrate,
                  pawntypeex,
                  tempcode,
                  invest_date,
                  investor,
                  land_useage,
                  house_useage,
                  build_area,
                  completed_date,
                  floor_no,
                  near_status,
                  use_status,
                  rent,
                  traffic_status,
                  pawn_near,
                  near_roatype,
                  near_facility,
                  uptown_area,
                  uptown_type,
                  build_type,
                  factory_useage,
                  factory_near,
                  clean_status,
                  factory_area,
                  factory_type,
                  material_type,
                  floor_num,
                  direction,
                  decorate,
                  land_boundary,
                  floor_price,
                  pawn_owner,
                  pawn_brand,
                  pawn_spec,
                  plate_type,
                  plate_no,
                  new_ratio,
                  reg_no,
                  storage_place,
                  buy_price,
                  total_price,
                  health_status,
                  conserve_status,
                  market_status,
                  reg_dept,
                  impawn_no,
                  warehouse,
                  regulator,
                  safekeep_dept,
                  receipt_no,
                  warehouse_no,
                  goods_heap,
                  school_status,
                  afforest,
                  land_nature,
                  uptown_name,
                  factor_usestatus,
                  factor_rent,
                  factor_floornum,
                  factor_direction,
                  factor_decorate,
                  batch_no,
                  borrower,
                  borrowdept,
                  collateralstatus,
                  landcollateralid,
                  process_instanceid,
                  confirmstatus,
                  rejecttype,
                  guatway,
                  warning_line,
                  closing_line,
                  riskcontrol,
                  fundcode,
                  guarantor,
                  exchangetype,
                  stockcode,
                  unlockdate,
                  enterprisename,
                  storagemode,
                  innerid,
                  rate,
                  startdate,
                  beginamount,
                  dealdate,
                  lendamount,
                  isinsuranced,
                  insuranceenddate,
                  insurancecompany,
                  insuranceno,
                  insurancebalance,
                  insurancesituation,
                  currentamount,
                  initamount,
                  initvalue,
                  shareamount,
                  sharebalance,
                  rightsequence,
                  evaluatedate,
                  evaluateorg,
                  estexplain,
                  collateralid,
                  registrationauthority,
                  collateralcode,
                  registrationdate,
                  voucherenddate,
                  serialno,
                  confirm_user,
                  confirm_time,
                  projectcode,
                  collateralamount,
                  intendedreturndate,
                  returndate,
                  kind
             from SRC_LAYER.aics_asset_pawn_info
           minus
           select pawncode,
                  pawnnum,
                  pawnname,
                  mortgagecontractcode,
                  provincecode,
                  cityno,
                  regioncode,
                  pawntype,
                  othercredentialsno,
                  originalcredentialsno,
                  pawnamount,
                  pawnstatus,
                  pawnarea,
                  houseare,
                  marketprice,
                  cashprice,
                  cashrate,
                  quoteprice,
                  buyprice,
                  enteruser,
                  entertime,
                  lastupdateuser,
                  lastupdatetime,
                  disposalyears,
                  balancecost,
                  currentbalance,
                  deductionten,
                  lasttimeloss,
                  lastbalance,
                  pawndetail,
                  recoverablebalance,
                  disposalmoney,
                  schemeid,
                  type,
                  place,
                  source,
                  valuationamount,
                  escrowstatus,
                  remark,
                  pawnregdate,
                  addrdetail,
                  cykind,
                  pawnquantity,
                  pawnunit,
                  recpmarketprice,
                  recpcashprice,
                  recpcashrate,
                  pawntypeex,
                  tempcode,
                  invest_date,
                  investor,
                  land_useage,
                  house_useage,
                  build_area,
                  completed_date,
                  floor_no,
                  near_status,
                  use_status,
                  rent,
                  traffic_status,
                  pawn_near,
                  near_roatype,
                  near_facility,
                  uptown_area,
                  uptown_type,
                  build_type,
                  factory_useage,
                  factory_near,
                  clean_status,
                  factory_area,
                  factory_type,
                  material_type,
                  floor_num,
                  direction,
                  decorate,
                  land_boundary,
                  floor_price,
                  pawn_owner,
                  pawn_brand,
                  pawn_spec,
                  plate_type,
                  plate_no,
                  new_ratio,
                  reg_no,
                  storage_place,
                  buy_price,
                  total_price,
                  health_status,
                  conserve_status,
                  market_status,
                  reg_dept,
                  impawn_no,
                  warehouse,
                  regulator,
                  safekeep_dept,
                  receipt_no,
                  warehouse_no,
                  goods_heap,
                  school_status,
                  afforest,
                  land_nature,
                  uptown_name,
                  factor_usestatus,
                  factor_rent,
                  factor_floornum,
                  factor_direction,
                  factor_decorate,
                  batch_no,
                  borrower,
                  borrowdept,
                  collateralstatus,
                  landcollateralid,
                  process_instanceid,
                  confirmstatus,
                  rejecttype,
                  guatway,
                  warning_line,
                  closing_line,
                  riskcontrol,
                  fundcode,
                  guarantor,
                  exchangetype,
                  stockcode,
                  unlockdate,
                  enterprisename,
                  storagemode,
                  innerid,
                  rate,
                  startdate,
                  beginamount,
                  dealdate,
                  lendamount,
                  isinsuranced,
                  insuranceenddate,
                  insurancecompany,
                  insuranceno,
                  insurancebalance,
                  insurancesituation,
                  currentamount,
                  initamount,
                  initvalue,
                  shareamount,
                  sharebalance,
                  rightsequence,
                  evaluatedate,
                  evaluateorg,
                  estexplain,
                  collateralid,
                  registrationauthority,
                  collateralcode,
                  registrationdate,
                  voucherenddate,
                  serialno,
                  confirm_user,
                  confirm_time,
                  projectcode,
                  collateralamount,
                  intendedreturndate,
                  returndate,
                  kind
             from STD_LAYER.t05_asset_pawn_info) DIF
    on (HIS.pawncode = DIF.pawncode)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t05_asset_pawn_info
      select pawncode,
             pawnnum,
             pawnname,
             mortgagecontractcode,
             provincecode,
             cityno,
             regioncode,
             pawntype,
             othercredentialsno,
             originalcredentialsno,
             pawnamount,
             pawnstatus,
             pawnarea,
             houseare,
             marketprice,
             cashprice,
             cashrate,
             quoteprice,
             buyprice,
             enteruser,
             entertime,
             lastupdateuser,
             lastupdatetime,
             disposalyears,
             balancecost,
             currentbalance,
             deductionten,
             lasttimeloss,
             lastbalance,
             pawndetail,
             recoverablebalance,
             disposalmoney,
             schemeid,
             type,
             place,
             source,
             valuationamount,
             escrowstatus,
             remark,
             pawnregdate,
             addrdetail,
             cykind,
             pawnquantity,
             pawnunit,
             recpmarketprice,
             recpcashprice,
             recpcashrate,
             pawntypeex,
             tempcode,
             invest_date,
             investor,
             land_useage,
             house_useage,
             build_area,
             completed_date,
             floor_no,
             near_status,
             use_status,
             rent,
             traffic_status,
             pawn_near,
             near_roatype,
             near_facility,
             uptown_area,
             uptown_type,
             build_type,
             factory_useage,
             factory_near,
             clean_status,
             factory_area,
             factory_type,
             material_type,
             floor_num,
             direction,
             decorate,
             land_boundary,
             floor_price,
             pawn_owner,
             pawn_brand,
             pawn_spec,
             plate_type,
             plate_no,
             new_ratio,
             reg_no,
             storage_place,
             buy_price,
             total_price,
             health_status,
             conserve_status,
             market_status,
             reg_dept,
             impawn_no,
             warehouse,
             regulator,
             safekeep_dept,
             receipt_no,
             warehouse_no,
             goods_heap,
             school_status,
             afforest,
             land_nature,
             uptown_name,
             factor_usestatus,
             factor_rent,
             factor_floornum,
             factor_direction,
             factor_decorate,
             batch_no,
             borrower,
             borrowdept,
             collateralstatus,
             landcollateralid,
             process_instanceid,
             confirmstatus,
             rejecttype,
             guatway,
             warning_line,
             closing_line,
             riskcontrol,
             fundcode,
             guarantor,
             exchangetype,
             stockcode,
             unlockdate,
             enterprisename,
             storagemode,
             innerid,
             rate,
             startdate,
             beginamount,
             dealdate,
             lendamount,
             isinsuranced,
             insuranceenddate,
             insurancecompany,
             insuranceno,
             insurancebalance,
             insurancesituation,
             currentamount,
             initamount,
             initvalue,
             shareamount,
             sharebalance,
             rightsequence,
             evaluatedate,
             evaluateorg,
             estexplain,
             collateralid,
             registrationauthority,
             collateralcode,
             registrationdate,
             voucherenddate,
             serialno,
             confirm_user,
             confirm_time,
             projectcode,
             collateralamount,
             intendedreturndate,
             returndate,
             kind,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_asset_pawn_info
       where pawncode not in
             (select pawncode
                from (select pawncode,
                             pawnnum,
                             pawnname,
                             mortgagecontractcode,
                             provincecode,
                             cityno,
                             regioncode,
                             pawntype,
                             othercredentialsno,
                             originalcredentialsno,
                             pawnamount,
                             pawnstatus,
                             pawnarea,
                             houseare,
                             marketprice,
                             cashprice,
                             cashrate,
                             quoteprice,
                             buyprice,
                             enteruser,
                             entertime,
                             lastupdateuser,
                             lastupdatetime,
                             disposalyears,
                             balancecost,
                             currentbalance,
                             deductionten,
                             lasttimeloss,
                             lastbalance,
                             pawndetail,
                             recoverablebalance,
                             disposalmoney,
                             schemeid,
                             type,
                             place,
                             source,
                             valuationamount,
                             escrowstatus,
                             remark,
                             pawnregdate,
                             addrdetail,
                             cykind,
                             pawnquantity,
                             pawnunit,
                             recpmarketprice,
                             recpcashprice,
                             recpcashrate,
                             pawntypeex,
                             tempcode,
                             invest_date,
                             investor,
                             land_useage,
                             house_useage,
                             build_area,
                             completed_date,
                             floor_no,
                             near_status,
                             use_status,
                             rent,
                             traffic_status,
                             pawn_near,
                             near_roatype,
                             near_facility,
                             uptown_area,
                             uptown_type,
                             build_type,
                             factory_useage,
                             factory_near,
                             clean_status,
                             factory_area,
                             factory_type,
                             material_type,
                             floor_num,
                             direction,
                             decorate,
                             land_boundary,
                             floor_price,
                             pawn_owner,
                             pawn_brand,
                             pawn_spec,
                             plate_type,
                             plate_no,
                             new_ratio,
                             reg_no,
                             storage_place,
                             buy_price,
                             total_price,
                             health_status,
                             conserve_status,
                             market_status,
                             reg_dept,
                             impawn_no,
                             warehouse,
                             regulator,
                             safekeep_dept,
                             receipt_no,
                             warehouse_no,
                             goods_heap,
                             school_status,
                             afforest,
                             land_nature,
                             uptown_name,
                             factor_usestatus,
                             factor_rent,
                             factor_floornum,
                             factor_direction,
                             factor_decorate,
                             batch_no,
                             borrower,
                             borrowdept,
                             collateralstatus,
                             landcollateralid,
                             process_instanceid,
                             confirmstatus,
                             rejecttype,
                             guatway,
                             warning_line,
                             closing_line,
                             riskcontrol,
                             fundcode,
                             guarantor,
                             exchangetype,
                             stockcode,
                             unlockdate,
                             enterprisename,
                             storagemode,
                             innerid,
                             rate,
                             startdate,
                             beginamount,
                             dealdate,
                             lendamount,
                             isinsuranced,
                             insuranceenddate,
                             insurancecompany,
                             insuranceno,
                             insurancebalance,
                             insurancesituation,
                             currentamount,
                             initamount,
                             initvalue,
                             shareamount,
                             sharebalance,
                             rightsequence,
                             evaluatedate,
                             evaluateorg,
                             estexplain,
                             collateralid,
                             registrationauthority,
                             collateralcode,
                             registrationdate,
                             voucherenddate,
                             serialno,
                             confirm_user,
                             confirm_time,
                             projectcode,
                             collateralamount,
                             intendedreturndate,
                             returndate,
                             kind
                        from SRC_LAYER.aics_asset_pawn_info
                      intersect
                      select pawncode,
                             pawnnum,
                             pawnname,
                             mortgagecontractcode,
                             provincecode,
                             cityno,
                             regioncode,
                             pawntype,
                             othercredentialsno,
                             originalcredentialsno,
                             pawnamount,
                             pawnstatus,
                             pawnarea,
                             houseare,
                             marketprice,
                             cashprice,
                             cashrate,
                             quoteprice,
                             buyprice,
                             enteruser,
                             entertime,
                             lastupdateuser,
                             lastupdatetime,
                             disposalyears,
                             balancecost,
                             currentbalance,
                             deductionten,
                             lasttimeloss,
                             lastbalance,
                             pawndetail,
                             recoverablebalance,
                             disposalmoney,
                             schemeid,
                             type,
                             place,
                             source,
                             valuationamount,
                             escrowstatus,
                             remark,
                             pawnregdate,
                             addrdetail,
                             cykind,
                             pawnquantity,
                             pawnunit,
                             recpmarketprice,
                             recpcashprice,
                             recpcashrate,
                             pawntypeex,
                             tempcode,
                             invest_date,
                             investor,
                             land_useage,
                             house_useage,
                             build_area,
                             completed_date,
                             floor_no,
                             near_status,
                             use_status,
                             rent,
                             traffic_status,
                             pawn_near,
                             near_roatype,
                             near_facility,
                             uptown_area,
                             uptown_type,
                             build_type,
                             factory_useage,
                             factory_near,
                             clean_status,
                             factory_area,
                             factory_type,
                             material_type,
                             floor_num,
                             direction,
                             decorate,
                             land_boundary,
                             floor_price,
                             pawn_owner,
                             pawn_brand,
                             pawn_spec,
                             plate_type,
                             plate_no,
                             new_ratio,
                             reg_no,
                             storage_place,
                             buy_price,
                             total_price,
                             health_status,
                             conserve_status,
                             market_status,
                             reg_dept,
                             impawn_no,
                             warehouse,
                             regulator,
                             safekeep_dept,
                             receipt_no,
                             warehouse_no,
                             goods_heap,
                             school_status,
                             afforest,
                             land_nature,
                             uptown_name,
                             factor_usestatus,
                             factor_rent,
                             factor_floornum,
                             factor_direction,
                             factor_decorate,
                             batch_no,
                             borrower,
                             borrowdept,
                             collateralstatus,
                             landcollateralid,
                             process_instanceid,
                             confirmstatus,
                             rejecttype,
                             guatway,
                             warning_line,
                             closing_line,
                             riskcontrol,
                             fundcode,
                             guarantor,
                             exchangetype,
                             stockcode,
                             unlockdate,
                             enterprisename,
                             storagemode,
                             innerid,
                             rate,
                             startdate,
                             beginamount,
                             dealdate,
                             lendamount,
                             isinsuranced,
                             insuranceenddate,
                             insurancecompany,
                             insuranceno,
                             insurancebalance,
                             insurancesituation,
                             currentamount,
                             initamount,
                             initvalue,
                             shareamount,
                             sharebalance,
                             rightsequence,
                             evaluatedate,
                             evaluateorg,
                             estexplain,
                             collateralid,
                             registrationauthority,
                             collateralcode,
                             registrationdate,
                             voucherenddate,
                             serialno,
                             confirm_user,
                             confirm_time,
                             projectcode,
                             collateralamount,
                             intendedreturndate,
                             returndate,
                             kind
                        from STD_LAYER.t05_asset_pawn_info));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_asset_pawn_info',
               'STD_LAYER.t05_asset_pawn_info',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_asset_pawn_info',
                 'STD_LAYER.t05_asset_pawn_info',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_asset_pawn_info;

  --update_invest_floatrate
  procedure update_invest_floatrate is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t08_invest_floatrate
     where start_date = query_date;
    update STD_LAYER.t08_invest_floatrate
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t08_invest_floatrate HIS
    using (select contractid,
                  assetid,
                  rateid,
                  ratekind,
                  begindate,
                  enddate,
                  beginscale,
                  endscale,
                  rate,
                  calccycle,
                  ratedays
             from SRC_LAYER.aics_invest_floatrate
           minus
           select contractid,
                  assetid,
                  rateid,
                  ratekind,
                  begindate,
                  enddate,
                  beginscale,
                  endscale,
                  rate,
                  calccycle,
                  ratedays
             from STD_LAYER.t08_invest_floatrate) DIF
    on (HIS.contractid = DIF.contractid)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t08_invest_floatrate
      select contractid,
             assetid,
             rateid,
             ratekind,
             begindate,
             enddate,
             beginscale,
             endscale,
             rate,
             calccycle,
             ratedays,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_invest_floatrate
       where contractid not in
             (select contractid
                from (select contractid,
                             assetid,
                             rateid,
                             ratekind,
                             begindate,
                             enddate,
                             beginscale,
                             endscale,
                             rate,
                             calccycle,
                             ratedays
                        from SRC_LAYER.aics_invest_floatrate
                      intersect
                      select contractid,
                             assetid,
                             rateid,
                             ratekind,
                             begindate,
                             enddate,
                             beginscale,
                             endscale,
                             rate,
                             calccycle,
                             ratedays
                        from STD_LAYER.t08_invest_floatrate));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_invest_floatrate',
               'STD_LAYER.t08_invest_floatrate',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_invest_floatrate',
                 'STD_LAYER.t08_invest_floatrate',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_invest_floatrate;

  --update_invest_plandetail
  procedure update_invest_plandetail is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t05_invest_plandetail
     where start_date = query_date;
    update STD_LAYER.t05_invest_plandetail
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t05_invest_plandetail HIS
    using (select pkid,
                  planid,
                  contractid,
                  assetid,
                  pdate,
                  profitkind,
                  extflag,
                  balance,
                  invest,
                  rateid,
                  bdate,
                  edate,
                  settldate,
                  rate,
                  repayflag,
                  repaybal,
                  lastrepay,
                  days,
                  ratedays,
                  assetcode,
                  autobalance
             from SRC_LAYER.aics_invest_plandetail
           minus
           select pkid,
                  planid,
                  contractid,
                  assetid,
                  pdate,
                  profitkind,
                  extflag,
                  balance,
                  invest,
                  rateid,
                  bdate,
                  edate,
                  settldate,
                  rate,
                  repayflag,
                  repaybal,
                  lastrepay,
                  days,
                  ratedays,
                  assetcode,
                  autobalance
             from STD_LAYER.t05_invest_plandetail) DIF
    on (HIS.pkid = DIF.pkid)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t05_invest_plandetail
      select pkid,
             planid,
             contractid,
             assetid,
             pdate,
             profitkind,
             extflag,
             balance,
             invest,
             rateid,
             bdate,
             edate,
             settldate,
             rate,
             repayflag,
             repaybal,
             lastrepay,
             days,
             ratedays,
             assetcode,
             autobalance,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_invest_plandetail
       where pkid not in
             (select pkid
                from (select pkid,
                             planid,
                             contractid,
                             assetid,
                             pdate,
                             profitkind,
                             extflag,
                             balance,
                             invest,
                             rateid,
                             bdate,
                             edate,
                             settldate,
                             rate,
                             repayflag,
                             repaybal,
                             lastrepay,
                             days,
                             ratedays,
                             assetcode,
                             autobalance
                        from SRC_LAYER.aics_invest_plandetail
                      intersect
                      select pkid,
                             planid,
                             contractid,
                             assetid,
                             pdate,
                             profitkind,
                             extflag,
                             balance,
                             invest,
                             rateid,
                             bdate,
                             edate,
                             settldate,
                             rate,
                             repayflag,
                             repaybal,
                             lastrepay,
                             days,
                             ratedays,
                             assetcode,
                             autobalance
                        from STD_LAYER.t05_invest_plandetail));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_invest_plandetail',
               'STD_LAYER.t05_invest_plandetail',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_invest_plandetail',
                 'STD_LAYER.t05_invest_plandetail',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_invest_plandetail;

  --update_invest_plan
  procedure update_invest_plan is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t05_invest_plan where start_date = query_date;
    update STD_LAYER.t05_invest_plan
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t05_invest_plan HIS
    using (select planid,
                  pdate,
                  state,
                  dataflag,
                  create_date,
                  creater,
                  update_date,
                  updater,
                  equityplankind,
                  equityassetno,
                  reviewstatus,
                  bdate,
                  edate,
                  total_amount,
                  projectcode,
                  contractid,
                  assetid,
                  plantype,
                  repayway,
                  pcapital,
                  fundacid,
                  rivalid,
                  accoid,
                  pincome,
                  mcapital,
                  mincome,
                  isrecreate,
                  loanbalance,
                  contractstate,
                  repaymenttype
             from SRC_LAYER.aics_invest_plan
           minus
           select planid,
                  pdate,
                  state,
                  dataflag,
                  create_date,
                  creater,
                  update_date,
                  updater,
                  equityplankind,
                  equityassetno,
                  reviewstatus,
                  bdate,
                  edate,
                  total_amount,
                  projectcode,
                  contractid,
                  assetid,
                  plantype,
                  repayway,
                  pcapital,
                  fundacid,
                  rivalid,
                  accoid,
                  pincome,
                  mcapital,
                  mincome,
                  isrecreate,
                  loanbalance,
                  contractstate,
                  repaymenttype
             from STD_LAYER.t05_invest_plan) DIF
    on (HIS.planid = DIF.planid)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t05_invest_plan
      select planid,
             pdate,
             state,
             dataflag,
             create_date,
             creater,
             update_date,
             updater,
             equityplankind,
             equityassetno,
             reviewstatus,
             bdate,
             edate,
             total_amount,
             projectcode,
             contractid,
             assetid,
             plantype,
             repayway,
             pcapital,
             fundacid,
             rivalid,
             accoid,
             pincome,
             mcapital,
             mincome,
             isrecreate,
             loanbalance,
             contractstate,
             repaymenttype,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_invest_plan
       where planid not in
             (select planid
                from (select planid,
                             pdate,
                             state,
                             dataflag,
                             create_date,
                             creater,
                             update_date,
                             updater,
                             equityplankind,
                             equityassetno,
                             reviewstatus,
                             bdate,
                             edate,
                             total_amount,
                             projectcode,
                             contractid,
                             assetid,
                             plantype,
                             repayway,
                             pcapital,
                             fundacid,
                             rivalid,
                             accoid,
                             pincome,
                             mcapital,
                             mincome,
                             isrecreate,
                             loanbalance,
                             contractstate,
                             repaymenttype
                        from SRC_LAYER.aics_invest_plan
                      intersect
                      select planid,
                             pdate,
                             state,
                             dataflag,
                             create_date,
                             creater,
                             update_date,
                             updater,
                             equityplankind,
                             equityassetno,
                             reviewstatus,
                             bdate,
                             edate,
                             total_amount,
                             projectcode,
                             contractid,
                             assetid,
                             plantype,
                             repayway,
                             pcapital,
                             fundacid,
                             rivalid,
                             accoid,
                             pincome,
                             mcapital,
                             mincome,
                             isrecreate,
                             loanbalance,
                             contractstate,
                             repaymenttype
                        from STD_LAYER.t05_invest_plan));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_invest_plan',
               'STD_LAYER.t05_invest_plan',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_invest_plan',
                 'STD_LAYER.t05_invest_plan',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_invest_plan;

  --update_invest_rate
  procedure update_invest_rate is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t04_invest_rate where start_date = query_date;
    update STD_LAYER.t04_invest_rate
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t04_invest_rate HIS
    using (select rateid,
                  contractid,
                  assetid,
                  ratekind,
                  cykind,
                  calccycle,
                  ratetype,
                  bdate,
                  edate,
                  beginsacle,
                  endsacle,
                  basekind,
                  floatcond,
                  floatway,
                  changekind,
                  changefreq,
                  changedate,
                  lowrate,
                  highrate,
                  rate,
                  settlefreq,
                  isadvance,
                  firstpaydate,
                  nextbdate,
                  nextedate,
                  nextpaydate
             from SRC_LAYER.aics_invest_rate
           minus
           select rateid,
                  contractid,
                  assetid,
                  ratekind,
                  cykind,
                  calccycle,
                  ratetype,
                  bdate,
                  edate,
                  beginsacle,
                  endsacle,
                  basekind,
                  floatcond,
                  floatway,
                  changekind,
                  changefreq,
                  changedate,
                  lowrate,
                  highrate,
                  rate,
                  settlefreq,
                  isadvance,
                  firstpaydate,
                  nextbdate,
                  nextedate,
                  nextpaydate
             from STD_LAYER.t04_invest_rate) DIF
    on (HIS.rateid = DIF.rateid)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t04_invest_rate
      select rateid,
             contractid,
             assetid,
             ratekind,
             cykind,
             calccycle,
             ratetype,
             bdate,
             edate,
             beginsacle,
             endsacle,
             basekind,
             floatcond,
             floatway,
             changekind,
             changefreq,
             changedate,
             lowrate,
             highrate,
             rate,
             settlefreq,
             isadvance,
             firstpaydate,
             nextbdate,
             nextedate,
             nextpaydate,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_invest_rate
       where rateid not in
             (select rateid
                from (select rateid,
                             contractid,
                             assetid,
                             ratekind,
                             cykind,
                             calccycle,
                             ratetype,
                             bdate,
                             edate,
                             beginsacle,
                             endsacle,
                             basekind,
                             floatcond,
                             floatway,
                             changekind,
                             changefreq,
                             changedate,
                             lowrate,
                             highrate,
                             rate,
                             settlefreq,
                             isadvance,
                             firstpaydate,
                             nextbdate,
                             nextedate,
                             nextpaydate
                        from SRC_LAYER.aics_invest_rate
                      intersect
                      select rateid,
                             contractid,
                             assetid,
                             ratekind,
                             cykind,
                             calccycle,
                             ratetype,
                             bdate,
                             edate,
                             beginsacle,
                             endsacle,
                             basekind,
                             floatcond,
                             floatway,
                             changekind,
                             changefreq,
                             changedate,
                             lowrate,
                             highrate,
                             rate,
                             settlefreq,
                             isadvance,
                             firstpaydate,
                             nextbdate,
                             nextedate,
                             nextpaydate
                        from STD_LAYER.t04_invest_rate));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_invest_rate',
               'STD_LAYER.t04_invest_rate',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_invest_rate',
                 'STD_LAYER.t04_invest_rate',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_invest_rate;

  --update_repay_confirm
  procedure update_repay_confirm is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t05_repay_confirm where start_date = query_date;
    update STD_LAYER.t05_repay_confirm
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t05_repay_confirm HIS
    using (select confirmid,
                  approveid,
                  arrivalid,
                  projectcode,
                  repay_type,
                  end_data_date,
                  liquidate_unit,
                  liquidate_type,
                  pay_type,
                  plan_name,
                  isloan,
                  source,
                  source_code,
                  service_free,
                  bail_type,
                  payer_name,
                  contract_type,
                  contract_id,
                  delist,
                  isbailtofee,
                  distributionorder,
                  status,
                  userid,
                  orgid,
                  confirm_date,
                  process_instanceid,
                  isdirect,
                  repay_nature,
                  out_tax,
                  summarymoney,
                  service_free2,
                  amount,
                  inputtype,
                  vouchers_state,
                  incometax_type,
                  associated_asset_id,
                  debt_settlement,
                  approve_no
             from SRC_LAYER.aics_repay_confirm
           minus
           select confirmid,
                  approveid,
                  arrivalid,
                  projectcode,
                  repay_type,
                  end_data_date,
                  liquidate_unit,
                  liquidate_type,
                  pay_type,
                  plan_name,
                  isloan,
                  source,
                  source_code,
                  service_free,
                  bail_type,
                  payer_name,
                  contract_type,
                  contract_id,
                  delist,
                  isbailtofee,
                  distributionorder,
                  status,
                  userid,
                  orgid,
                  confirm_date,
                  process_instanceid,
                  isdirect,
                  repay_nature,
                  out_tax,
                  summarymoney,
                  service_free2,
                  amount,
                  inputtype,
                  vouchers_state,
                  incometax_type,
                  associated_asset_id,
                  debt_settlement,
                  approve_no
             from STD_LAYER.t05_repay_confirm) DIF
    on (HIS.confirmid = DIF.confirmid)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t05_repay_confirm
      select confirmid,
             approveid,
             arrivalid,
             projectcode,
             repay_type,
             end_data_date,
             liquidate_unit,
             liquidate_type,
             pay_type,
             plan_name,
             isloan,
             source,
             source_code,
             service_free,
             bail_type,
             payer_name,
             contract_type,
             contract_id,
             delist,
             isbailtofee,
             distributionorder,
             status,
             userid,
             orgid,
             confirm_date,
             process_instanceid,
             isdirect,
             repay_nature,
             out_tax,
             summarymoney,
             service_free2,
             amount,
             inputtype,
             vouchers_state,
             incometax_type,
             associated_asset_id,
             debt_settlement,
             approve_no,
             sysdate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_repay_confirm
       where confirmid not in
             (select confirmid
                from (select confirmid,
                             approveid,
                             arrivalid,
                             projectcode,
                             repay_type,
                             end_data_date,
                             liquidate_unit,
                             liquidate_type,
                             pay_type,
                             plan_name,
                             isloan,
                             source,
                             source_code,
                             service_free,
                             bail_type,
                             payer_name,
                             contract_type,
                             contract_id,
                             delist,
                             isbailtofee,
                             distributionorder,
                             status,
                             userid,
                             orgid,
                             confirm_date,
                             process_instanceid,
                             isdirect,
                             repay_nature,
                             out_tax,
                             summarymoney,
                             service_free2,
                             amount,
                             inputtype,
                             vouchers_state,
                             incometax_type,
                             associated_asset_id,
                             debt_settlement,
                             approve_no
                        from SRC_LAYER.aics_repay_confirm
                      intersect
                      select confirmid,
                             approveid,
                             arrivalid,
                             projectcode,
                             repay_type,
                             end_data_date,
                             liquidate_unit,
                             liquidate_type,
                             pay_type,
                             plan_name,
                             isloan,
                             source,
                             source_code,
                             service_free,
                             bail_type,
                             payer_name,
                             contract_type,
                             contract_id,
                             delist,
                             isbailtofee,
                             distributionorder,
                             status,
                             userid,
                             orgid,
                             confirm_date,
                             process_instanceid,
                             isdirect,
                             repay_nature,
                             out_tax,
                             summarymoney,
                             service_free2,
                             amount,
                             inputtype,
                             vouchers_state,
                             incometax_type,
                             associated_asset_id,
                             debt_settlement,
                             approve_no
                        from STD_LAYER.t05_repay_confirm));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_repay_confirm',
               'STD_LAYER.t05_repay_confirm',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_repay_confirm',
                 'STD_LAYER.t05_repay_confirm',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_repay_confirm;

  --update_deposits_loans_deal
  procedure update_deposits_loans_deal is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t08_deposits_loans_deal
     where start_date = query_date;
    update STD_LAYER.t08_deposits_loans_deal
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t08_deposits_loans_deal HIS
    using (select br,
                  dealno,
                  buis_module,
                  cost,
                  product,
                  prodtype,
                  dl_ps,
                  dealdate,
                  vdate,
                  tenor,
                  tenor_unit,
                  mdate,
                  cust,
                  cust_acct,
                  ccy,
                  amt,
                  ratecode,
                  intrate,
                  int_amt,
                  basis,
                  acrfrstlst,
                  dealtext,
                  status,
                  reversal_status,
                  trad,
                  createuser,
                  createtime,
                  reviewuser,
                  reviewtime,
                  reversaluser,
                  reversaltime,
                  lstmntuser,
                  lstmnttime,
                  fedealno,
                  settlement_path
             from SRC_LAYER.aics_deposits_loans_deal
           minus
           select br,
                  dealno,
                  buis_module,
                  cost,
                  product,
                  prodtype,
                  dl_ps,
                  dealdate,
                  vdate,
                  tenor,
                  tenor_unit,
                  mdate,
                  cust,
                  cust_acct,
                  ccy,
                  amt,
                  ratecode,
                  intrate,
                  int_amt,
                  basis,
                  acrfrstlst,
                  dealtext,
                  status,
                  reversal_status,
                  trad,
                  createuser,
                  createtime,
                  reviewuser,
                  reviewtime,
                  reversaluser,
                  reversaltime,
                  lstmntuser,
                  lstmnttime,
                  fedealno,
                  settlement_path
             from STD_LAYER.t08_deposits_loans_deal) DIF
    on (HIS.dealno = DIF.dealno)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t08_deposits_loans_deal
      select br,
             dealno,
             buis_module,
             cost,
             product,
             prodtype,
             dl_ps,
             dealdate,
             vdate,
             tenor,
             tenor_unit,
             mdate,
             cust,
             cust_acct,
             ccy,
             amt,
             ratecode,
             intrate,
             int_amt,
             basis,
             acrfrstlst,
             dealtext,
             status,
             reversal_status,
             trad,
             createuser,
             createtime,
             reviewuser,
             reviewtime,
             reversaluser,
             reversaltime,
             lstmntuser,
             lstmnttime,
             fedealno,
             settlement_path,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd'),
             null,
             null,
             null,
             null
        from SRC_LAYER.aics_deposits_loans_deal
       where dealno not in
             (select dealno
                from (select br,
                             dealno,
                             buis_module,
                             cost,
                             product,
                             prodtype,
                             dl_ps,
                             dealdate,
                             vdate,
                             tenor,
                             tenor_unit,
                             mdate,
                             cust,
                             cust_acct,
                             ccy,
                             amt,
                             ratecode,
                             intrate,
                             int_amt,
                             basis,
                             acrfrstlst,
                             dealtext,
                             status,
                             reversal_status,
                             trad,
                             createuser,
                             createtime,
                             reviewuser,
                             reviewtime,
                             reversaluser,
                             reversaltime,
                             lstmntuser,
                             lstmnttime,
                             fedealno,
                             settlement_path
                        from SRC_LAYER.aics_deposits_loans_deal
                      intersect
                      select br,
                             dealno,
                             buis_module,
                             cost,
                             product,
                             prodtype,
                             dl_ps,
                             dealdate,
                             vdate,
                             tenor,
                             tenor_unit,
                             mdate,
                             cust,
                             cust_acct,
                             ccy,
                             amt,
                             ratecode,
                             intrate,
                             int_amt,
                             basis,
                             acrfrstlst,
                             dealtext,
                             status,
                             reversal_status,
                             trad,
                             createuser,
                             createtime,
                             reviewuser,
                             reviewtime,
                             reversaluser,
                             reversaltime,
                             lstmntuser,
                             lstmnttime,
                             fedealno,
                             settlement_path
                        from STD_LAYER.t08_deposits_loans_deal));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_deposits_loans_deal',
               'STD_LAYER.t08_deposits_loans_deal',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_deposits_loans_deal',
                 'STD_LAYER.t08_deposits_loans_deal',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_deposits_loans_deal;

  --update_repo_deal_order
  procedure update_repo_deal_order is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t05_repo_deal_order
     where start_date = query_date;
    update STD_LAYER.t05_repo_deal_order
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t05_repo_deal_order HIS
    using (select br,
                  orderno,
                  order_headno,
                  buis_module,
                  dealdate,
                  end_dealdate,
                  market,
                  product,
                  ps,
                  security,
                  quantity,
                  ccy,
                  tenor,
                  amount,
                  amount_max,
                  reporate,
                  reporate_max,
                  costcentertype,
                  costcenter,
                  status,
                  createuser,
                  createtime,
                  verifyuser,
                  verifytime,
                  lstmntuser,
                  lstmnttime
             from SRC_LAYER.aics_repo_deal_order
           minus
           select br,
                  orderno,
                  order_headno,
                  buis_module,
                  dealdate,
                  end_dealdate,
                  market,
                  product,
                  ps,
                  security,
                  quantity,
                  ccy,
                  tenor,
                  amount,
                  amount_max,
                  reporate,
                  reporate_max,
                  costcentertype,
                  costcenter,
                  status,
                  createuser,
                  createtime,
                  verifyuser,
                  verifytime,
                  lstmntuser,
                  lstmnttime
             from STD_LAYER.t05_repo_deal_order) DIF
    on (HIS.orderno = DIF.orderno)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t05_repo_deal_order
      select br,
             orderno,
             order_headno,
             buis_module,
             dealdate,
             end_dealdate,
             market,
             product,
             ps,
             security,
             quantity,
             ccy,
             tenor,
             amount,
             amount_max,
             reporate,
             reporate_max,
             costcentertype,
             costcenter,
             status,
             createuser,
             createtime,
             verifyuser,
             verifytime,
             lstmntuser,
             lstmnttime,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_repo_deal_order
       where orderno not in
             (select orderno
                from (select br,
                             orderno,
                             order_headno,
                             buis_module,
                             dealdate,
                             end_dealdate,
                             market,
                             product,
                             ps,
                             security,
                             quantity,
                             ccy,
                             tenor,
                             amount,
                             amount_max,
                             reporate,
                             reporate_max,
                             costcentertype,
                             costcenter,
                             status,
                             createuser,
                             createtime,
                             verifyuser,
                             verifytime,
                             lstmntuser,
                             lstmnttime
                        from SRC_LAYER.aics_repo_deal_order
                      intersect
                      select br,
                             orderno,
                             order_headno,
                             buis_module,
                             dealdate,
                             end_dealdate,
                             market,
                             product,
                             ps,
                             security,
                             quantity,
                             ccy,
                             tenor,
                             amount,
                             amount_max,
                             reporate,
                             reporate_max,
                             costcentertype,
                             costcenter,
                             status,
                             createuser,
                             createtime,
                             verifyuser,
                             verifytime,
                             lstmntuser,
                             lstmnttime
                        from STD_LAYER.t05_repo_deal_order));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_repo_deal_order',
               'STD_LAYER.t05_repo_deal_order',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_repo_deal_order',
                 'STD_LAYER.t05_repo_deal_order',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_repo_deal_order;

  --update_security_deal
  procedure update_security_deal is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t05_security_deal where start_date = query_date;
    update STD_LAYER.t05_security_deal
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t05_security_deal HIS
    using (select dealno,
                  ps,
                  ccy,
                  amount,
                  prinamt,
                  quantity,
                  price,
                  custcode,
                  dealdate,
                  vdate,
                  ratecode,
                  rate,
                  contractid,
                  fedealno,
                  faceamount,
                  fixrate,
                  security,
                  costcentertype,
                  costcenter,
                  deptid,
                  createuser,
                  createtime,
                  reviewuser,
                  reviewtime,
                  reversaluser,
                  reversaltime,
                  reversal_reason,
                  lstmntuser,
                  lstmnttime,
                  status,
                  posflag,
                  glno,
                  account,
                  extfiled1,
                  reversal_status,
                  tempcode,
                  reject_remark,
                  ps_type,
                  mdate,
                  acup_postdate,
                  frozen,
                  frozenunit,
                  dealphase,
                  br,
                  settlement_path,
                  buis_module,
                  agreementid,
                  product,
                  prodtype,
                  marketissue,
                  feeaimt,
                  taxamt,
                  trftfeeamt,
                  totalamt,
                  settlement,
                  auto_verify,
                  full_price,
                  average_cost,
                  auto_settlement
             from SRC_LAYER.aics_security_deal
           minus
           select dealno,
                  ps,
                  ccy,
                  amount,
                  prinamt,
                  quantity,
                  price,
                  custcode,
                  dealdate,
                  vdate,
                  ratecode,
                  rate,
                  contractid,
                  fedealno,
                  faceamount,
                  fixrate,
                  security,
                  costcentertype,
                  costcenter,
                  deptid,
                  createuser,
                  createtime,
                  reviewuser,
                  reviewtime,
                  reversaluser,
                  reversaltime,
                  reversal_reason,
                  lstmntuser,
                  lstmnttime,
                  status,
                  posflag,
                  glno,
                  account,
                  extfiled1,
                  reversal_status,
                  tempcode,
                  reject_remark,
                  ps_type,
                  mdate,
                  acup_postdate,
                  frozen,
                  frozenunit,
                  dealphase,
                  br,
                  settlement_path,
                  buis_module,
                  agreementid,
                  product,
                  prodtype,
                  marketissue,
                  feeaimt,
                  taxamt,
                  trftfeeamt,
                  totalamt,
                  settlement,
                  auto_verify,
                  full_price,
                  average_cost,
                  auto_settlement
             from STD_LAYER.t05_security_deal) DIF
    on (HIS.dealno = DIF.dealno)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t05_security_deal
      select dealno,
             ps,
             ccy,
             amount,
             prinamt,
             quantity,
             price,
             custcode,
             dealdate,
             vdate,
             ratecode,
             rate,
             contractid,
             fedealno,
             faceamount,
             fixrate,
             security,
             costcentertype,
             costcenter,
             deptid,
             createuser,
             createtime,
             reviewuser,
             reviewtime,
             reversaluser,
             reversaltime,
             reversal_reason,
             lstmntuser,
             lstmnttime,
             status,
             posflag,
             glno,
             account,
             extfiled1,
             reversal_status,
             tempcode,
             reject_remark,
             ps_type,
             mdate,
             acup_postdate,
             frozen,
             frozenunit,
             dealphase,
             br,
             settlement_path,
             buis_module,
             agreementid,
             product,
             prodtype,
             marketissue,
             feeaimt,
             taxamt,
             trftfeeamt,
             totalamt,
             settlement,
             auto_verify,
             full_price,
             average_cost,
             auto_settlement,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_security_deal
       where dealno not in
             (select dealno
                from (select dealno,
                             ps,
                             ccy,
                             amount,
                             prinamt,
                             quantity,
                             price,
                             custcode,
                             dealdate,
                             vdate,
                             ratecode,
                             rate,
                             contractid,
                             fedealno,
                             faceamount,
                             fixrate,
                             security,
                             costcentertype,
                             costcenter,
                             deptid,
                             createuser,
                             createtime,
                             reviewuser,
                             reviewtime,
                             reversaluser,
                             reversaltime,
                             reversal_reason,
                             lstmntuser,
                             lstmnttime,
                             status,
                             posflag,
                             glno,
                             account,
                             extfiled1,
                             reversal_status,
                             tempcode,
                             reject_remark,
                             ps_type,
                             mdate,
                             acup_postdate,
                             frozen,
                             frozenunit,
                             dealphase,
                             br,
                             settlement_path,
                             buis_module,
                             agreementid,
                             product,
                             prodtype,
                             marketissue,
                             feeaimt,
                             taxamt,
                             trftfeeamt,
                             totalamt,
                             settlement,
                             auto_verify,
                             full_price,
                             average_cost,
                             auto_settlement
                        from SRC_LAYER.aics_security_deal
                      intersect
                      select dealno,
                             ps,
                             ccy,
                             amount,
                             prinamt,
                             quantity,
                             price,
                             custcode,
                             dealdate,
                             vdate,
                             ratecode,
                             rate,
                             contractid,
                             fedealno,
                             faceamount,
                             fixrate,
                             security,
                             costcentertype,
                             costcenter,
                             deptid,
                             createuser,
                             createtime,
                             reviewuser,
                             reviewtime,
                             reversaluser,
                             reversaltime,
                             reversal_reason,
                             lstmntuser,
                             lstmnttime,
                             status,
                             posflag,
                             glno,
                             account,
                             extfiled1,
                             reversal_status,
                             tempcode,
                             reject_remark,
                             ps_type,
                             mdate,
                             acup_postdate,
                             frozen,
                             frozenunit,
                             dealphase,
                             br,
                             settlement_path,
                             buis_module,
                             agreementid,
                             product,
                             prodtype,
                             marketissue,
                             feeaimt,
                             taxamt,
                             trftfeeamt,
                             totalamt,
                             settlement,
                             auto_verify,
                             full_price,
                             average_cost,
                             auto_settlement
                        from STD_LAYER.t05_security_deal));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_security_deal',
               'STD_LAYER.t05_security_deal',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_security_deal',
                 'STD_LAYER.t05_security_deal',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_security_deal;

  --update_security_master
  procedure update_security_master is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t05_security_master
     where start_date = query_date;
    update STD_LAYER.t05_security_master
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t05_security_master HIS
    using (select security,
                  name,
                  type,
                  ccy,
                  par_value,
                  price,
                  issdate,
                  vdate,
                  mdate,
                  ratecode,
                  fixrate,
                  issuer,
                  master_desc,
                  status,
                  createuser,
                  createtime,
                  lstmntuser,
                  lstmnttime,
                  feno,
                  isuse,
                  intsecid,
                  marketissue,
                  custodian,
                  basis,
                  firstintpaydate,
                  intpmtfreq,
                  intpayrule,
                  firstprinpayday,
                  prinpmtfreq,
                  settdays,
                  sic,
                  sectype,
                  guarantee,
                  conversion_star,
                  conversion_end,
                  calldate,
                  callprice,
                  call_desc,
                  putbackdate,
                  putbackprice,
                  putback_desc,
                  linksecid,
                  listedsector,
                  rateadjustdate,
                  category,
                  fund_manager,
                  trustee,
                  prinpmt_type,
                  fullname,
                  source,
                  verifyuser,
                  verifytime,
                  auto_verify,
                  reject_remark,
                  domestic,
                  totalissue,
                  a_totalshare,
                  a_totalfloatshare,
                  h_totalshare,
                  h_totalfloatshare,
                  area,
                  rejectuser,
                  rejecttime,
                  pubpvt,
                  name_allfirstletter,
                  industrywind,
                  mkt_security,
                  price_client_code
             from SRC_LAYER.aics_security_master
           minus
           select security,
                  name,
                  type,
                  ccy,
                  par_value,
                  price,
                  issdate,
                  vdate,
                  mdate,
                  ratecode,
                  fixrate,
                  issuer,
                  master_desc,
                  status,
                  createuser,
                  createtime,
                  lstmntuser,
                  lstmnttime,
                  feno,
                  isuse,
                  intsecid,
                  marketissue,
                  custodian,
                  basis,
                  firstintpaydate,
                  intpmtfreq,
                  intpayrule,
                  firstprinpayday,
                  prinpmtfreq,
                  settdays,
                  sic,
                  sectype,
                  guarantee,
                  conversion_star,
                  conversion_end,
                  calldate,
                  callprice,
                  call_desc,
                  putbackdate,
                  putbackprice,
                  putback_desc,
                  linksecid,
                  listedsector,
                  rateadjustdate,
                  category,
                  fund_manager,
                  trustee,
                  prinpmt_type,
                  fullname,
                  source,
                  verifyuser,
                  verifytime,
                  auto_verify,
                  reject_remark,
                  domestic,
                  totalissue,
                  a_totalshare,
                  a_totalfloatshare,
                  h_totalshare,
                  h_totalfloatshare,
                  area,
                  rejectuser,
                  rejecttime,
                  pubpvt,
                  name_allfirstletter,
                  industrywind,
                  mkt_security,
                  price_client_code
             from STD_LAYER.t05_security_master) DIF
    on (HIS.security = DIF.security)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t05_security_master
      select security,
             name,
             type,
             ccy,
             par_value,
             price,
             issdate,
             vdate,
             mdate,
             ratecode,
             fixrate,
             issuer,
             master_desc,
             status,
             createuser,
             createtime,
             lstmntuser,
             lstmnttime,
             feno,
             isuse,
             intsecid,
             marketissue,
             custodian,
             basis,
             firstintpaydate,
             intpmtfreq,
             intpayrule,
             firstprinpayday,
             prinpmtfreq,
             settdays,
             sic,
             sectype,
             guarantee,
             conversion_star,
             conversion_end,
             calldate,
             callprice,
             call_desc,
             putbackdate,
             putbackprice,
             putback_desc,
             linksecid,
             listedsector,
             rateadjustdate,
             category,
             fund_manager,
             trustee,
             prinpmt_type,
             fullname,
             source,
             verifyuser,
             verifytime,
             auto_verify,
             reject_remark,
             domestic,
             totalissue,
             a_totalshare,
             a_totalfloatshare,
             h_totalshare,
             h_totalfloatshare,
             area,
             rejectuser,
             rejecttime,
             pubpvt,
             name_allfirstletter,
             industrywind,
             mkt_security,
             price_client_code,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_security_master
       where security not in
             (select security
                from (select security,
                             name,
                             type,
                             ccy,
                             par_value,
                             price,
                             issdate,
                             vdate,
                             mdate,
                             ratecode,
                             fixrate,
                             issuer,
                             master_desc,
                             status,
                             createuser,
                             createtime,
                             lstmntuser,
                             lstmnttime,
                             feno,
                             isuse,
                             intsecid,
                             marketissue,
                             custodian,
                             basis,
                             firstintpaydate,
                             intpmtfreq,
                             intpayrule,
                             firstprinpayday,
                             prinpmtfreq,
                             settdays,
                             sic,
                             sectype,
                             guarantee,
                             conversion_star,
                             conversion_end,
                             calldate,
                             callprice,
                             call_desc,
                             putbackdate,
                             putbackprice,
                             putback_desc,
                             linksecid,
                             listedsector,
                             rateadjustdate,
                             category,
                             fund_manager,
                             trustee,
                             prinpmt_type,
                             fullname,
                             source,
                             verifyuser,
                             verifytime,
                             auto_verify,
                             reject_remark,
                             domestic,
                             totalissue,
                             a_totalshare,
                             a_totalfloatshare,
                             h_totalshare,
                             h_totalfloatshare,
                             area,
                             rejectuser,
                             rejecttime,
                             pubpvt,
                             name_allfirstletter,
                             industrywind,
                             mkt_security,
                             price_client_code
                        from SRC_LAYER.aics_security_master
                      intersect
                      select security,
                             name,
                             type,
                             ccy,
                             par_value,
                             price,
                             issdate,
                             vdate,
                             mdate,
                             ratecode,
                             fixrate,
                             issuer,
                             master_desc,
                             status,
                             createuser,
                             createtime,
                             lstmntuser,
                             lstmnttime,
                             feno,
                             isuse,
                             intsecid,
                             marketissue,
                             custodian,
                             basis,
                             firstintpaydate,
                             intpmtfreq,
                             intpayrule,
                             firstprinpayday,
                             prinpmtfreq,
                             settdays,
                             sic,
                             sectype,
                             guarantee,
                             conversion_star,
                             conversion_end,
                             calldate,
                             callprice,
                             call_desc,
                             putbackdate,
                             putbackprice,
                             putback_desc,
                             linksecid,
                             listedsector,
                             rateadjustdate,
                             category,
                             fund_manager,
                             trustee,
                             prinpmt_type,
                             fullname,
                             source,
                             verifyuser,
                             verifytime,
                             auto_verify,
                             reject_remark,
                             domestic,
                             totalissue,
                             a_totalshare,
                             a_totalfloatshare,
                             h_totalshare,
                             h_totalfloatshare,
                             area,
                             rejectuser,
                             rejecttime,
                             pubpvt,
                             name_allfirstletter,
                             industrywind,
                             mkt_security,
                             price_client_code
                        from STD_LAYER.t05_security_master));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_security_master',
               'STD_LAYER.t05_security_master',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_security_master',
                 'STD_LAYER.t05_security_master',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_security_master;

  --update_security_position
  procedure update_security_position is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t05_security_position
     where start_date = query_date;
    update STD_LAYER.t05_security_position
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t05_security_position HIS
    using (select security,
                  quantity,
                  average_cost,
                  principal,
                  profit,
                  purch_avg_cost,
                  purch_quantity,
                  purch_amount,
                  sale_avg_cost,
                  sale_quantity,
                  sale_amount,
                  costcentertype,
                  costcenter,
                  td_intamt,
                  pye_intamt,
                  td_salegain,
                  pye_salegain,
                  td_profit,
                  pye_profit,
                  yield_quantity,
                  amortizedamt,
                  unamortizedamt,
                  frozent_qty,
                  pye_yield_quantity,
                  br,
                  buis_module,
                  product,
                  prodtype,
                  ccy,
                  feeamt,
                  finance_principal,
                  entrydate
             from SRC_LAYER.aics_security_position
           minus
           select security,
                  quantity,
                  average_cost,
                  principal,
                  profit,
                  purch_avg_cost,
                  purch_quantity,
                  purch_amount,
                  sale_avg_cost,
                  sale_quantity,
                  sale_amount,
                  costcentertype,
                  costcenter,
                  td_intamt,
                  pye_intamt,
                  td_salegain,
                  pye_salegain,
                  td_profit,
                  pye_profit,
                  yield_quantity,
                  amortizedamt,
                  unamortizedamt,
                  frozent_qty,
                  pye_yield_quantity,
                  br,
                  buis_module,
                  product,
                  prodtype,
                  ccy,
                  feeamt,
                  finance_principal,
                  entrydate
             from STD_LAYER.t05_security_position) DIF
    on (HIS.security = DIF.security)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t05_security_position
      select security,
             quantity,
             average_cost,
             principal,
             profit,
             purch_avg_cost,
             purch_quantity,
             purch_amount,
             sale_avg_cost,
             sale_quantity,
             sale_amount,
             costcentertype,
             costcenter,
             td_intamt,
             pye_intamt,
             td_salegain,
             pye_salegain,
             td_profit,
             pye_profit,
             yield_quantity,
             amortizedamt,
             unamortizedamt,
             frozent_qty,
             pye_yield_quantity,
             br,
             buis_module,
             product,
             prodtype,
             ccy,
             feeamt,
             finance_principal,
             entrydate,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_security_position
       where security not in
             (select security
                from (select security,
                             quantity,
                             average_cost,
                             principal,
                             profit,
                             purch_avg_cost,
                             purch_quantity,
                             purch_amount,
                             sale_avg_cost,
                             sale_quantity,
                             sale_amount,
                             costcentertype,
                             costcenter,
                             td_intamt,
                             pye_intamt,
                             td_salegain,
                             pye_salegain,
                             td_profit,
                             pye_profit,
                             yield_quantity,
                             amortizedamt,
                             unamortizedamt,
                             frozent_qty,
                             pye_yield_quantity,
                             br,
                             buis_module,
                             product,
                             prodtype,
                             ccy,
                             feeamt,
                             finance_principal,
                             entrydate
                        from SRC_LAYER.aics_security_position
                      intersect
                      select security,
                             quantity,
                             average_cost,
                             principal,
                             profit,
                             purch_avg_cost,
                             purch_quantity,
                             purch_amount,
                             sale_avg_cost,
                             sale_quantity,
                             sale_amount,
                             costcentertype,
                             costcenter,
                             td_intamt,
                             pye_intamt,
                             td_salegain,
                             pye_salegain,
                             td_profit,
                             pye_profit,
                             yield_quantity,
                             amortizedamt,
                             unamortizedamt,
                             frozent_qty,
                             pye_yield_quantity,
                             br,
                             buis_module,
                             product,
                             prodtype,
                             ccy,
                             feeamt,
                             finance_principal,
                             entrydate
                        from STD_LAYER.t05_security_position));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_security_position',
               'STD_LAYER.t05_security_position',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_security_position',
                 'STD_LAYER.t05_security_position',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_security_position;

  --update_security_rate_adjust
  procedure update_security_rate_adjust is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t05_security_rate_adjust
     where start_date = query_date;
    update STD_LAYER.t05_security_rate_adjust
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t05_security_rate_adjust HIS
    using (select security,
                  dealdate,
                  fixrate,
                  intpmtfreq,
                  adj_fixrate,
                  is_adj_intpmtfreq,
                  adj_intpmtfreq,
                  eff_rule,
                  effdate,
                  createuser,
                  createtime,
                  lstmntuser,
                  lstmnttime,
                  adj_rateid
             from SRC_LAYER.aics_security_rate_adjust
           minus
           select security,
                  dealdate,
                  fixrate,
                  intpmtfreq,
                  adj_fixrate,
                  is_adj_intpmtfreq,
                  adj_intpmtfreq,
                  eff_rule,
                  effdate,
                  createuser,
                  createtime,
                  lstmntuser,
                  lstmnttime,
                  adj_rateid
             from STD_LAYER.t05_security_rate_adjust) DIF
    on (HIS.security = DIF.security)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t05_security_rate_adjust
      select security,
             dealdate,
             fixrate,
             intpmtfreq,
             adj_fixrate,
             is_adj_intpmtfreq,
             adj_intpmtfreq,
             eff_rule,
             effdate,
             createuser,
             createtime,
             lstmntuser,
             lstmnttime,
             adj_rateid,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_security_rate_adjust
       where security not in
             (select security
                from (select security,
                             dealdate,
                             fixrate,
                             intpmtfreq,
                             adj_fixrate,
                             is_adj_intpmtfreq,
                             adj_intpmtfreq,
                             eff_rule,
                             effdate,
                             createuser,
                             createtime,
                             lstmntuser,
                             lstmnttime,
                             adj_rateid
                        from SRC_LAYER.aics_security_rate_adjust
                      intersect
                      select security,
                             dealdate,
                             fixrate,
                             intpmtfreq,
                             adj_fixrate,
                             is_adj_intpmtfreq,
                             adj_intpmtfreq,
                             eff_rule,
                             effdate,
                             createuser,
                             createtime,
                             lstmntuser,
                             lstmnttime,
                             adj_rateid
                        from STD_LAYER.t05_security_rate_adjust));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_security_rate_adjust',
               'STD_LAYER.t05_security_rate_adjust',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_security_rate_adjust',
                 'STD_LAYER.t05_security_rate_adjust',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_security_rate_adjust;

  --update_repo_deal
  procedure update_repo_deal is
    query_date date;
  begin
    -- save query_date from etl_control
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.t05_repo_deal where start_date = query_date;
    update STD_LAYER.t05_repo_deal
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
  
    merge into STD_LAYER.t05_repo_deal HIS
    using (select br,
                  dealno,
                  buis_module,
                  trader,
                  market,
                  product,
                  security,
                  ps,
                  ratecode,
                  reporate,
                  cust,
                  ccy,
                  quantity,
                  faceamount,
                  amount,
                  totlint,
                  dealdate,
                  settdays,
                  vdate,
                  tenor,
                  mdate,
                  basis,
                  feeccy,
                  feeamt,
                  settle_acct_type,
                  settle_acct,
                  v_settlement,
                  m_settlement,
                  costcenter,
                  status,
                  mstatus,
                  reversal_status,
                  fedealno,
                  createuser,
                  createtime,
                  reviewuser,
                  reviewtime,
                  reversaluser,
                  reversaltime,
                  reversareason,
                  lstmntuser,
                  lstmnttime,
                  settlement_path
             from SRC_LAYER.aics_repo_deal
           minus
           select br,
                  dealno,
                  buis_module,
                  trader,
                  market,
                  product,
                  security,
                  ps,
                  ratecode,
                  reporate,
                  cust,
                  ccy,
                  quantity,
                  faceamount,
                  amount,
                  totlint,
                  dealdate,
                  settdays,
                  vdate,
                  tenor,
                  mdate,
                  basis,
                  feeccy,
                  feeamt,
                  settle_acct_type,
                  settle_acct,
                  v_settlement,
                  m_settlement,
                  costcenter,
                  status,
                  mstatus,
                  reversal_status,
                  fedealno,
                  createuser,
                  createtime,
                  reviewuser,
                  reviewtime,
                  reversaluser,
                  reversaltime,
                  reversareason,
                  lstmntuser,
                  lstmnttime,
                  settlement_path
             from STD_LAYER.t05_repo_deal) DIF
    on (HIS.dealno = DIF.dealno)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records
    insert into STD_LAYER.t05_repo_deal
      select br,
             dealno,
             buis_module,
             trader,
             market,
             product,
             security,
             ps,
             ratecode,
             reporate,
             cust,
             ccy,
             quantity,
             faceamount,
             amount,
             totlint,
             dealdate,
             settdays,
             vdate,
             tenor,
             mdate,
             basis,
             feeccy,
             feeamt,
             settle_acct_type,
             settle_acct,
             v_settlement,
             m_settlement,
             costcenter,
             status,
             mstatus,
             reversal_status,
             fedealno,
             createuser,
             createtime,
             reviewuser,
             reviewtime,
             reversaluser,
             reversaltime,
             reversareason,
             lstmntuser,
             lstmnttime,
             settlement_path,
             datadate,
             to_date('9999-12-31', 'yyyy/mm/dd')
        from SRC_LAYER.aics_repo_deal
       where dealno not in
             (select dealno
                from (select br,
                             dealno,
                             buis_module,
                             trader,
                             market,
                             product,
                             security,
                             ps,
                             ratecode,
                             reporate,
                             cust,
                             ccy,
                             quantity,
                             faceamount,
                             amount,
                             totlint,
                             dealdate,
                             settdays,
                             vdate,
                             tenor,
                             mdate,
                             basis,
                             feeccy,
                             feeamt,
                             settle_acct_type,
                             settle_acct,
                             v_settlement,
                             m_settlement,
                             costcenter,
                             status,
                             mstatus,
                             reversal_status,
                             fedealno,
                             createuser,
                             createtime,
                             reviewuser,
                             reviewtime,
                             reversaluser,
                             reversaltime,
                             reversareason,
                             lstmntuser,
                             lstmnttime,
                             settlement_path
                        from SRC_LAYER.aics_repo_deal
                      intersect
                      select br,
                             dealno,
                             buis_module,
                             trader,
                             market,
                             product,
                             security,
                             ps,
                             ratecode,
                             reporate,
                             cust,
                             ccy,
                             quantity,
                             faceamount,
                             amount,
                             totlint,
                             dealdate,
                             settdays,
                             vdate,
                             tenor,
                             mdate,
                             basis,
                             feeccy,
                             feeamt,
                             settle_acct_type,
                             settle_acct,
                             v_settlement,
                             m_settlement,
                             costcenter,
                             status,
                             mstatus,
                             reversal_status,
                             fedealno,
                             createuser,
                             createtime,
                             reviewuser,
                             reviewtime,
                             reversaluser,
                             reversaltime,
                             reversareason,
                             lstmntuser,
                             lstmnttime,
                             settlement_path
                        from STD_LAYER.t05_repo_deal));
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.aics_repo_deal',
               'STD_LAYER.t05_repo_deal',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.aics_repo_deal',
                 'STD_LAYER.t05_repo_deal',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_repo_deal;

  -- update log in etl_control
  procedure update_log(source_sheet      varchar2,
                       target_sheet      varchar2,
                       query_date        date,
                       success_status    varchar2,
                       exception_message varchar2 default NULL) is
  begin
    insert into etl_control.etl_control_log
      (etl_modle,
       etl_source,
       etl_target,
       data_date,
       etl_date,
       is_success,
       exceptionerrormsg)
    values
      ('STD_LAYER',
       source_sheet,
       target_sheet,
       query_date,
       sysdate,
       success_status,
       exception_message);
    commit;
  end update_log;

end ETL_process_aics;
/
