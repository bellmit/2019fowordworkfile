create or replace package ETL_process_entry is
  procedure update_data_header;
  procedure update_gl_ledgers;
  procedure update_gl_code_combinations;
  procedure update_gl_balances;
  procedure update_fnd_id_flex_segments;
  procedure update_fnd_flex_value_sets;
  procedure update_fnd_flex_values;
  procedure update_ap_invoice_lines_all;
  procedure update_ap_invoice_distributions_all;
  procedure update_ap_invoices_all;
  procedure update_ap_suppliers;
  procedure update_log(source_sheet      varchar2,
                       target_sheet      varchar2,
                       query_date        date,
                       success_status    varchar2,
                       exception_message varchar2 DEFAULT NULL);

end ETL_process_entry;
/
create or replace package body ETL_process_entry is
  -- append data_header
  procedure update_data_header is
    query_date date;
  
  begin
    -- save query_date from etl_control 
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from DATA_HEADER where data_date = query_date;
  
    -- insert from src_layer
    insert into STD_LAYER.DATA_HEADER
      select report_id,
             report_flag,
             period_date,
             data_date,
             line_count_num,
             sysdate,
             ds_header_sequence.nextval
        from SRC_LAYER.EBS_DATA_HEADER;
    commit;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.EBS_DATA_HEADER',
               'STD_LAYER.DATA_HEADER',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.EBS_DATA_HEADER',
                 'STD_LAYER.DATA_HEADER',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
  end update_data_header;

  -- append gl_ledgers
  procedure update_gl_ledgers is
    query_date date;
  begin
    -- save query_date from etl_control 
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.T08_GL_LEDGERS where start_date = query_date;
    update STD_LAYER.T08_GL_LEDGERS
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
    -- update end_date for the same ledger_id
    merge into STD_LAYER.T08_GL_LEDGERS HIS
    using (select report_id,
                  ledger_id,
                  name,
                  short_name,
                  description,
                  ledger_category_code,
                  alc_ledger_type_code,
                  object_type_code,
                  le_ledger_type_code,
                  completion_status_code,
                  configuration_id,
                  chart_of_accounts_id,
                  currency_code,
                  period_set_name,
                  accounted_period_type,
                  first_ledger_period_name,
                  ret_earn_code_combination_id,
                  suspense_allowed_flag,
                  allow_intercompany_post_flag,
                  track_rounding_imbalance_flag,
                  enable_average_balances_flag,
                  cum_trans_code_combination_id,
                  res_encumb_code_combination_id,
                  net_income_code_combination_id,
                  rounding_code_combination_id,
                  enable_budgetary_control_flag,
                  require_budget_journals_flag,
                  enable_je_approval_flag,
                  enable_automatic_tax_flag,
                  consolidation_ledger_flag,
                  translate_eod_flag,
                  translate_qatd_flag,
                  translate_yatd_flag,
                  transaction_calendar_id,
                  daily_translation_rate_type,
                  automatically_created_flag,
                  bal_seg_value_option_code,
                  bal_seg_column_name,
                  mgt_seg_value_option_code,
                  mgt_seg_column_name,
                  bal_seg_value_set_id,
                  mgt_seg_value_set_id,
                  implicit_access_set_id,
                  criteria_set_id,
                  future_enterable_periods_limit,
                  ledger_attributes,
                  implicit_ledger_set_id,
                  latest_opened_period_name,
                  latest_encumbrance_year,
                  period_average_rate_type,
                  period_end_rate_type,
                  budget_period_avg_rate_type,
                  budget_period_end_rate_type,
                  sla_accounting_method_code,
                  sla_accounting_method_type,
                  sla_description_language,
                  sla_entered_cur_bal_sus_ccid,
                  sla_sequencing_flag,
                  sla_bal_by_ledger_curr_flag,
                  sla_ledger_cur_bal_sus_ccid,
                  enable_secondary_track_flag,
                  enable_reval_ss_track_flag,
                  last_update_date,
                  last_updated_by,
                  creation_date,
                  created_by,
                  last_update_login,
                  context,
                  attribute1,
                  attribute2,
                  attribute3,
                  attribute4,
                  attribute5,
                  attribute6,
                  attribute7,
                  attribute8,
                  attribute9,
                  attribute10,
                  attribute11,
                  attribute12,
                  attribute13,
                  attribute14,
                  attribute15,
                  enable_reconciliation_flag,
                  create_je_flag,
                  sla_ledger_cash_basis_flag,
                  complete_flag,
                  commitment_budget_flag,
                  net_closing_bal_flag,
                  automate_sec_jrnl_rev_flag
             from SRC_LAYER.EBS_GL_LEDGERS
           minus
           select report_id,
                  ledger_id,
                  name,
                  short_name,
                  description,
                  ledger_category_code,
                  alc_ledger_type_code,
                  object_type_code,
                  le_ledger_type_code,
                  completion_status_code,
                  configuration_id,
                  chart_of_accounts_id,
                  currency_code,
                  period_set_name,
                  accounted_period_type,
                  first_ledger_period_name,
                  ret_earn_code_combination_id,
                  suspense_allowed_flag,
                  allow_intercompany_post_flag,
                  track_rounding_imbalance_flag,
                  enable_average_balances_flag,
                  cum_trans_code_combination_id,
                  res_encumb_code_combination_id,
                  net_income_code_combination_id,
                  rounding_code_combination_id,
                  enable_budgetary_control_flag,
                  require_budget_journals_flag,
                  enable_je_approval_flag,
                  enable_automatic_tax_flag,
                  consolidation_ledger_flag,
                  translate_eod_flag,
                  translate_qatd_flag,
                  translate_yatd_flag,
                  transaction_calendar_id,
                  daily_translation_rate_type,
                  automatically_created_flag,
                  bal_seg_value_option_code,
                  bal_seg_column_name,
                  mgt_seg_value_option_code,
                  mgt_seg_column_name,
                  bal_seg_value_set_id,
                  mgt_seg_value_set_id,
                  implicit_access_set_id,
                  criteria_set_id,
                  future_enterable_periods_limit,
                  ledger_attributes,
                  implicit_ledger_set_id,
                  latest_opened_period_name,
                  latest_encumbrance_year,
                  period_average_rate_type,
                  period_end_rate_type,
                  budget_period_avg_rate_type,
                  budget_period_end_rate_type,
                  sla_accounting_method_code,
                  sla_accounting_method_type,
                  sla_description_language,
                  sla_entered_cur_bal_sus_ccid,
                  sla_sequencing_flag,
                  sla_bal_by_ledger_curr_flag,
                  sla_ledger_cur_bal_sus_ccid,
                  enable_secondary_track_flag,
                  enable_reval_ss_track_flag,
                  last_update_date,
                  last_updated_by,
                  creation_date,
                  created_by,
                  last_update_login,
                  context,
                  attribute1,
                  attribute2,
                  attribute3,
                  attribute4,
                  attribute5,
                  attribute6,
                  attribute7,
                  attribute8,
                  attribute9,
                  attribute10,
                  attribute11,
                  attribute12,
                  attribute13,
                  attribute14,
                  attribute15,
                  enable_reconciliation_flag,
                  create_je_flag,
                  sla_ledger_cash_basis_flag,
                  complete_flag,
                  commitment_budget_flag,
                  net_closing_bal_flag,
                  automate_sec_jrnl_rev_flag
           
             from STD_LAYER.T08_GL_LEDGERS) DIF
    on (HIS.ledger_id = DIF.ledger_id)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records 
    insert into STD_LAYER.T08_GL_LEDGERS
      select report_id,
             ledger_id,
             name,
             short_name,
             description,
             ledger_category_code,
             alc_ledger_type_code,
             object_type_code,
             le_ledger_type_code,
             completion_status_code,
             configuration_id,
             chart_of_accounts_id,
             currency_code,
             period_set_name,
             accounted_period_type,
             first_ledger_period_name,
             ret_earn_code_combination_id,
             suspense_allowed_flag,
             allow_intercompany_post_flag,
             track_rounding_imbalance_flag,
             enable_average_balances_flag,
             cum_trans_code_combination_id,
             res_encumb_code_combination_id,
             net_income_code_combination_id,
             rounding_code_combination_id,
             enable_budgetary_control_flag,
             require_budget_journals_flag,
             enable_je_approval_flag,
             enable_automatic_tax_flag,
             consolidation_ledger_flag,
             translate_eod_flag,
             translate_qatd_flag,
             translate_yatd_flag,
             transaction_calendar_id,
             daily_translation_rate_type,
             automatically_created_flag,
             bal_seg_value_option_code,
             bal_seg_column_name,
             mgt_seg_value_option_code,
             mgt_seg_column_name,
             bal_seg_value_set_id,
             mgt_seg_value_set_id,
             implicit_access_set_id,
             criteria_set_id,
             future_enterable_periods_limit,
             ledger_attributes,
             implicit_ledger_set_id,
             latest_opened_period_name,
             latest_encumbrance_year,
             period_average_rate_type,
             period_end_rate_type,
             budget_period_avg_rate_type,
             budget_period_end_rate_type,
             sla_accounting_method_code,
             sla_accounting_method_type,
             sla_description_language,
             sla_entered_cur_bal_sus_ccid,
             sla_sequencing_flag,
             sla_bal_by_ledger_curr_flag,
             sla_ledger_cur_bal_sus_ccid,
             enable_secondary_track_flag,
             enable_reval_ss_track_flag,
             last_update_date,
             last_updated_by,
             creation_date,
             created_by,
             last_update_login,
             context,
             attribute1,
             attribute2,
             attribute3,
             attribute4,
             attribute5,
             attribute6,
             attribute7,
             attribute8,
             attribute9,
             attribute10,
             attribute11,
             attribute12,
             attribute13,
             attribute14,
             attribute15,
             enable_reconciliation_flag,
             create_je_flag,
             sla_ledger_cash_basis_flag,
             complete_flag,
             commitment_budget_flag,
             net_closing_bal_flag,
             automate_sec_jrnl_rev_flag,
             sysdate,
             data_date,
             to_date('9999-12-31', 'yyyy/mm/dd'),
             -1,
             DS_LINE_SEQUENCE.nextval
        from SRC_LAYER.EBS_GL_LEDGERS
       where ledger_id not in
             (select ledger_id
                from (select report_id,
                             ledger_id,
                             name,
                             short_name,
                             description,
                             ledger_category_code,
                             alc_ledger_type_code,
                             object_type_code,
                             le_ledger_type_code,
                             completion_status_code,
                             configuration_id,
                             chart_of_accounts_id,
                             currency_code,
                             period_set_name,
                             accounted_period_type,
                             first_ledger_period_name,
                             ret_earn_code_combination_id,
                             suspense_allowed_flag,
                             allow_intercompany_post_flag,
                             track_rounding_imbalance_flag,
                             enable_average_balances_flag,
                             cum_trans_code_combination_id,
                             res_encumb_code_combination_id,
                             net_income_code_combination_id,
                             rounding_code_combination_id,
                             enable_budgetary_control_flag,
                             require_budget_journals_flag,
                             enable_je_approval_flag,
                             enable_automatic_tax_flag,
                             consolidation_ledger_flag,
                             translate_eod_flag,
                             translate_qatd_flag,
                             translate_yatd_flag,
                             transaction_calendar_id,
                             daily_translation_rate_type,
                             automatically_created_flag,
                             bal_seg_value_option_code,
                             bal_seg_column_name,
                             mgt_seg_value_option_code,
                             mgt_seg_column_name,
                             bal_seg_value_set_id,
                             mgt_seg_value_set_id,
                             implicit_access_set_id,
                             criteria_set_id,
                             future_enterable_periods_limit,
                             ledger_attributes,
                             implicit_ledger_set_id,
                             latest_opened_period_name,
                             latest_encumbrance_year,
                             period_average_rate_type,
                             period_end_rate_type,
                             budget_period_avg_rate_type,
                             budget_period_end_rate_type,
                             sla_accounting_method_code,
                             sla_accounting_method_type,
                             sla_description_language,
                             sla_entered_cur_bal_sus_ccid,
                             sla_sequencing_flag,
                             sla_bal_by_ledger_curr_flag,
                             sla_ledger_cur_bal_sus_ccid,
                             enable_secondary_track_flag,
                             enable_reval_ss_track_flag,
                             last_update_date,
                             last_updated_by,
                             creation_date,
                             created_by,
                             last_update_login,
                             context,
                             attribute1,
                             attribute2,
                             attribute3,
                             attribute4,
                             attribute5,
                             attribute6,
                             attribute7,
                             attribute8,
                             attribute9,
                             attribute10,
                             attribute11,
                             attribute12,
                             attribute13,
                             attribute14,
                             attribute15,
                             enable_reconciliation_flag,
                             create_je_flag,
                             sla_ledger_cash_basis_flag,
                             complete_flag,
                             commitment_budget_flag,
                             net_closing_bal_flag,
                             automate_sec_jrnl_rev_flag
                        from SRC_LAYER.EBS_GL_LEDGERS
                      intersect
                      select report_id,
                             ledger_id,
                             name,
                             short_name,
                             description,
                             ledger_category_code,
                             alc_ledger_type_code,
                             object_type_code,
                             le_ledger_type_code,
                             completion_status_code,
                             configuration_id,
                             chart_of_accounts_id,
                             currency_code,
                             period_set_name,
                             accounted_period_type,
                             first_ledger_period_name,
                             ret_earn_code_combination_id,
                             suspense_allowed_flag,
                             allow_intercompany_post_flag,
                             track_rounding_imbalance_flag,
                             enable_average_balances_flag,
                             cum_trans_code_combination_id,
                             res_encumb_code_combination_id,
                             net_income_code_combination_id,
                             rounding_code_combination_id,
                             enable_budgetary_control_flag,
                             require_budget_journals_flag,
                             enable_je_approval_flag,
                             enable_automatic_tax_flag,
                             consolidation_ledger_flag,
                             translate_eod_flag,
                             translate_qatd_flag,
                             translate_yatd_flag,
                             transaction_calendar_id,
                             daily_translation_rate_type,
                             automatically_created_flag,
                             bal_seg_value_option_code,
                             bal_seg_column_name,
                             mgt_seg_value_option_code,
                             mgt_seg_column_name,
                             bal_seg_value_set_id,
                             mgt_seg_value_set_id,
                             implicit_access_set_id,
                             criteria_set_id,
                             future_enterable_periods_limit,
                             ledger_attributes,
                             implicit_ledger_set_id,
                             latest_opened_period_name,
                             latest_encumbrance_year,
                             period_average_rate_type,
                             period_end_rate_type,
                             budget_period_avg_rate_type,
                             budget_period_end_rate_type,
                             sla_accounting_method_code,
                             sla_accounting_method_type,
                             sla_description_language,
                             sla_entered_cur_bal_sus_ccid,
                             sla_sequencing_flag,
                             sla_bal_by_ledger_curr_flag,
                             sla_ledger_cur_bal_sus_ccid,
                             enable_secondary_track_flag,
                             enable_reval_ss_track_flag,
                             last_update_date,
                             last_updated_by,
                             creation_date,
                             created_by,
                             last_update_login,
                             context,
                             attribute1,
                             attribute2,
                             attribute3,
                             attribute4,
                             attribute5,
                             attribute6,
                             attribute7,
                             attribute8,
                             attribute9,
                             attribute10,
                             attribute11,
                             attribute12,
                             attribute13,
                             attribute14,
                             attribute15,
                             enable_reconciliation_flag,
                             create_je_flag,
                             sla_ledger_cash_basis_flag,
                             complete_flag,
                             commitment_budget_flag,
                             net_closing_bal_flag,
                             automate_sec_jrnl_rev_flag
                        from STD_LAYER.T08_GL_LEDGERS));
    commit;
    -- set header_id linked with header table
    merge into STD_LAYER.T08_GL_LEDGERS a
    using (select * from STD_LAYER.DATA_HEADER) b
    on (a.start_date = b.data_date and b.report_flag = 'gl_ledgers')
    when matched then
      update set header_id = b.header_id;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.EBS_GL_LEDGERS',
               'STD_LAYER.T08_GL_LEDGERS',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.EBS_GL_LEDGERS',
                 'STD_LAYER.T08_GL_LEDGERS',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
    
  end update_gl_ledgers;

  -- append GL_CODE_COMBINATIONS
  procedure update_gl_code_combinations is
    query_date date;
  begin
    -- save query_date from etl_control 
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.T08_GL_CODE_COMBINATIONS
     where start_date = query_date;
    update STD_LAYER.T08_GL_CODE_COMBINATIONS
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
    -- update end_date for the CODE_COMBINATION_ID 
    merge into STD_LAYER.T08_GL_CODE_COMBINATIONS HIS
    using (select report_id,
                  code_combination_id,
                  last_update_date,
                  last_updated_by,
                  chart_of_accounts_id,
                  detail_posting_allowed_flag,
                  detail_budgeting_allowed_flag,
                  account_type,
                  enabled_flag,
                  summary_flag,
                  segment1,
                  segment2,
                  segment3,
                  segment4,
                  segment5,
                  segment6,
                  segment7,
                  segment8,
                  segment9,
                  segment10,
                  segment11,
                  segment12,
                  segment13,
                  segment14,
                  segment15,
                  segment16,
                  segment17,
                  segment18,
                  segment19,
                  segment20,
                  segment21,
                  segment22,
                  segment23,
                  segment24,
                  segment25,
                  segment26,
                  segment27,
                  segment28,
                  segment29,
                  segment30,
                  description,
                  template_id,
                  allocation_create_flag,
                  start_date_active,
                  end_date_active,
                  attribute1,
                  attribute2,
                  attribute3,
                  attribute4,
                  attribute5,
                  attribute6,
                  attribute7,
                  attribute8,
                  attribute9,
                  attribute10,
                  context,
                  segment_attribute1,
                  segment_attribute2,
                  segment_attribute3,
                  segment_attribute4,
                  segment_attribute5,
                  segment_attribute6,
                  segment_attribute7,
                  segment_attribute8,
                  segment_attribute9,
                  segment_attribute10,
                  segment_attribute11,
                  segment_attribute12,
                  segment_attribute13,
                  segment_attribute14,
                  segment_attribute15,
                  segment_attribute16,
                  segment_attribute17,
                  segment_attribute18,
                  segment_attribute19,
                  segment_attribute20,
                  segment_attribute21,
                  segment_attribute22,
                  segment_attribute23,
                  segment_attribute24,
                  segment_attribute25,
                  segment_attribute26,
                  segment_attribute27,
                  segment_attribute28,
                  segment_attribute29,
                  segment_attribute30,
                  segment_attribute31,
                  segment_attribute32,
                  segment_attribute33,
                  segment_attribute34,
                  segment_attribute35,
                  segment_attribute36,
                  segment_attribute37,
                  segment_attribute38,
                  segment_attribute39,
                  segment_attribute40,
                  segment_attribute41,
                  segment_attribute42,
                  reference1,
                  reference2,
                  reference3,
                  reference4,
                  reference5,
                  jgzz_recon_flag,
                  jgzz_recon_context,
                  preserve_flag,
                  refresh_flag,
                  igi_balanced_budget_flag,
                  company_cost_center_org_id,
                  revaluation_id,
                  ledger_segment,
                  ledger_type_code,
                  alternate_code_combination_id
             from SRC_LAYER.EBS_GL_CODE_COMBINATIONS
           minus
           select report_id,
                  code_combination_id,
                  last_update_date,
                  last_updated_by,
                  chart_of_accounts_id,
                  detail_posting_allowed_flag,
                  detail_budgeting_allowed_flag,
                  account_type,
                  enabled_flag,
                  summary_flag,
                  segment1,
                  segment2,
                  segment3,
                  segment4,
                  segment5,
                  segment6,
                  segment7,
                  segment8,
                  segment9,
                  segment10,
                  segment11,
                  segment12,
                  segment13,
                  segment14,
                  segment15,
                  segment16,
                  segment17,
                  segment18,
                  segment19,
                  segment20,
                  segment21,
                  segment22,
                  segment23,
                  segment24,
                  segment25,
                  segment26,
                  segment27,
                  segment28,
                  segment29,
                  segment30,
                  description,
                  template_id,
                  allocation_create_flag,
                  start_date_active,
                  end_date_active,
                  attribute1,
                  attribute2,
                  attribute3,
                  attribute4,
                  attribute5,
                  attribute6,
                  attribute7,
                  attribute8,
                  attribute9,
                  attribute10,
                  context,
                  segment_attribute1,
                  segment_attribute2,
                  segment_attribute3,
                  segment_attribute4,
                  segment_attribute5,
                  segment_attribute6,
                  segment_attribute7,
                  segment_attribute8,
                  segment_attribute9,
                  segment_attribute10,
                  segment_attribute11,
                  segment_attribute12,
                  segment_attribute13,
                  segment_attribute14,
                  segment_attribute15,
                  segment_attribute16,
                  segment_attribute17,
                  segment_attribute18,
                  segment_attribute19,
                  segment_attribute20,
                  segment_attribute21,
                  segment_attribute22,
                  segment_attribute23,
                  segment_attribute24,
                  segment_attribute25,
                  segment_attribute26,
                  segment_attribute27,
                  segment_attribute28,
                  segment_attribute29,
                  segment_attribute30,
                  segment_attribute31,
                  segment_attribute32,
                  segment_attribute33,
                  segment_attribute34,
                  segment_attribute35,
                  segment_attribute36,
                  segment_attribute37,
                  segment_attribute38,
                  segment_attribute39,
                  segment_attribute40,
                  segment_attribute41,
                  segment_attribute42,
                  reference1,
                  reference2,
                  reference3,
                  reference4,
                  reference5,
                  jgzz_recon_flag,
                  jgzz_recon_context,
                  preserve_flag,
                  refresh_flag,
                  igi_balanced_budget_flag,
                  company_cost_center_org_id,
                  revaluation_id,
                  ledger_segment,
                  ledger_type_code,
                  alternate_code_combination_id
           
             from STD_LAYER.T08_GL_CODE_COMBINATIONS) DIF
    on (HIS.code_combination_id = DIF.code_combination_id)
    when matched then
      update set HIS.end_date = query_date;
    -- insert the nonredundant(new) records 
    insert into STD_LAYER.T08_GL_CODE_COMBINATIONS
      select report_id,
             code_combination_id,
             last_update_date,
             last_updated_by,
             chart_of_accounts_id,
             detail_posting_allowed_flag,
             detail_budgeting_allowed_flag,
             account_type,
             enabled_flag,
             summary_flag,
             segment1,
             segment2,
             segment3,
             segment4,
             segment5,
             segment6,
             segment7,
             segment8,
             segment9,
             segment10,
             segment11,
             segment12,
             segment13,
             segment14,
             segment15,
             segment16,
             segment17,
             segment18,
             segment19,
             segment20,
             segment21,
             segment22,
             segment23,
             segment24,
             segment25,
             segment26,
             segment27,
             segment28,
             segment29,
             segment30,
             description,
             template_id,
             allocation_create_flag,
             start_date_active,
             end_date_active,
             attribute1,
             attribute2,
             attribute3,
             attribute4,
             attribute5,
             attribute6,
             attribute7,
             attribute8,
             attribute9,
             attribute10,
             context,
             segment_attribute1,
             segment_attribute2,
             segment_attribute3,
             segment_attribute4,
             segment_attribute5,
             segment_attribute6,
             segment_attribute7,
             segment_attribute8,
             segment_attribute9,
             segment_attribute10,
             segment_attribute11,
             segment_attribute12,
             segment_attribute13,
             segment_attribute14,
             segment_attribute15,
             segment_attribute16,
             segment_attribute17,
             segment_attribute18,
             segment_attribute19,
             segment_attribute20,
             segment_attribute21,
             segment_attribute22,
             segment_attribute23,
             segment_attribute24,
             segment_attribute25,
             segment_attribute26,
             segment_attribute27,
             segment_attribute28,
             segment_attribute29,
             segment_attribute30,
             segment_attribute31,
             segment_attribute32,
             segment_attribute33,
             segment_attribute34,
             segment_attribute35,
             segment_attribute36,
             segment_attribute37,
             segment_attribute38,
             segment_attribute39,
             segment_attribute40,
             segment_attribute41,
             segment_attribute42,
             reference1,
             reference2,
             reference3,
             reference4,
             reference5,
             jgzz_recon_flag,
             jgzz_recon_context,
             preserve_flag,
             refresh_flag,
             igi_balanced_budget_flag,
             company_cost_center_org_id,
             revaluation_id,
             ledger_segment,
             ledger_type_code,
             alternate_code_combination_id,
             sysdate,
             data_date,
             to_date('9999-12-31', 'yyyy/mm/dd'),
             -1,
             ds_line_sequence.nextval
        from SRC_LAYER.EBS_GL_CODE_COMBINATIONS
       where code_combination_id not in
             (select code_combination_id
                from (select report_id,
                             code_combination_id,
                             last_update_date,
                             last_updated_by,
                             chart_of_accounts_id,
                             detail_posting_allowed_flag,
                             detail_budgeting_allowed_flag,
                             account_type,
                             enabled_flag,
                             summary_flag,
                             segment1,
                             segment2,
                             segment3,
                             segment4,
                             segment5,
                             segment6,
                             segment7,
                             segment8,
                             segment9,
                             segment10,
                             segment11,
                             segment12,
                             segment13,
                             segment14,
                             segment15,
                             segment16,
                             segment17,
                             segment18,
                             segment19,
                             segment20,
                             segment21,
                             segment22,
                             segment23,
                             segment24,
                             segment25,
                             segment26,
                             segment27,
                             segment28,
                             segment29,
                             segment30,
                             description,
                             template_id,
                             allocation_create_flag,
                             start_date_active,
                             end_date_active,
                             attribute1,
                             attribute2,
                             attribute3,
                             attribute4,
                             attribute5,
                             attribute6,
                             attribute7,
                             attribute8,
                             attribute9,
                             attribute10,
                             context,
                             segment_attribute1,
                             segment_attribute2,
                             segment_attribute3,
                             segment_attribute4,
                             segment_attribute5,
                             segment_attribute6,
                             segment_attribute7,
                             segment_attribute8,
                             segment_attribute9,
                             segment_attribute10,
                             segment_attribute11,
                             segment_attribute12,
                             segment_attribute13,
                             segment_attribute14,
                             segment_attribute15,
                             segment_attribute16,
                             segment_attribute17,
                             segment_attribute18,
                             segment_attribute19,
                             segment_attribute20,
                             segment_attribute21,
                             segment_attribute22,
                             segment_attribute23,
                             segment_attribute24,
                             segment_attribute25,
                             segment_attribute26,
                             segment_attribute27,
                             segment_attribute28,
                             segment_attribute29,
                             segment_attribute30,
                             segment_attribute31,
                             segment_attribute32,
                             segment_attribute33,
                             segment_attribute34,
                             segment_attribute35,
                             segment_attribute36,
                             segment_attribute37,
                             segment_attribute38,
                             segment_attribute39,
                             segment_attribute40,
                             segment_attribute41,
                             segment_attribute42,
                             reference1,
                             reference2,
                             reference3,
                             reference4,
                             reference5,
                             jgzz_recon_flag,
                             jgzz_recon_context,
                             preserve_flag,
                             refresh_flag,
                             igi_balanced_budget_flag,
                             company_cost_center_org_id,
                             revaluation_id,
                             ledger_segment,
                             ledger_type_code,
                             alternate_code_combination_id
                        from src_layer.ebs_gl_code_combinations
                      intersect
                      select report_id,
                             code_combination_id,
                             last_update_date,
                             last_updated_by,
                             chart_of_accounts_id,
                             detail_posting_allowed_flag,
                             detail_budgeting_allowed_flag,
                             account_type,
                             enabled_flag,
                             summary_flag,
                             segment1,
                             segment2,
                             segment3,
                             segment4,
                             segment5,
                             segment6,
                             segment7,
                             segment8,
                             segment9,
                             segment10,
                             segment11,
                             segment12,
                             segment13,
                             segment14,
                             segment15,
                             segment16,
                             segment17,
                             segment18,
                             segment19,
                             segment20,
                             segment21,
                             segment22,
                             segment23,
                             segment24,
                             segment25,
                             segment26,
                             segment27,
                             segment28,
                             segment29,
                             segment30,
                             description,
                             template_id,
                             allocation_create_flag,
                             start_date_active,
                             end_date_active,
                             attribute1,
                             attribute2,
                             attribute3,
                             attribute4,
                             attribute5,
                             attribute6,
                             attribute7,
                             attribute8,
                             attribute9,
                             attribute10,
                             context,
                             segment_attribute1,
                             segment_attribute2,
                             segment_attribute3,
                             segment_attribute4,
                             segment_attribute5,
                             segment_attribute6,
                             segment_attribute7,
                             segment_attribute8,
                             segment_attribute9,
                             segment_attribute10,
                             segment_attribute11,
                             segment_attribute12,
                             segment_attribute13,
                             segment_attribute14,
                             segment_attribute15,
                             segment_attribute16,
                             segment_attribute17,
                             segment_attribute18,
                             segment_attribute19,
                             segment_attribute20,
                             segment_attribute21,
                             segment_attribute22,
                             segment_attribute23,
                             segment_attribute24,
                             segment_attribute25,
                             segment_attribute26,
                             segment_attribute27,
                             segment_attribute28,
                             segment_attribute29,
                             segment_attribute30,
                             segment_attribute31,
                             segment_attribute32,
                             segment_attribute33,
                             segment_attribute34,
                             segment_attribute35,
                             segment_attribute36,
                             segment_attribute37,
                             segment_attribute38,
                             segment_attribute39,
                             segment_attribute40,
                             segment_attribute41,
                             segment_attribute42,
                             reference1,
                             reference2,
                             reference3,
                             reference4,
                             reference5,
                             jgzz_recon_flag,
                             jgzz_recon_context,
                             preserve_flag,
                             refresh_flag,
                             igi_balanced_budget_flag,
                             company_cost_center_org_id,
                             revaluation_id,
                             ledger_segment,
                             ledger_type_code,
                             alternate_code_combination_id
                        from STD_LAYER.T08_GL_CODE_COMBINATIONS));
    commit;
    -- set header_id linked with header table
    merge into STD_LAYER.T08_GL_CODE_COMBINATIONS a
    using (select * from STD_LAYER.DATA_HEADER) b
    on (a.start_date = b.data_date and b.report_flag = 'gl_code_combinations')
    when matched then
      update set header_id = b.header_id;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.EBS_GL_CODE_COMBINATIONS',
               'STD_LAYER.T08_GL_CODE_COMBINATIONS',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.EBS_GL_CODE_COMBINATIONS',
                 'STD_LAYER.T08_GL_CODE_COMBINATIONS',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
    
  end update_gl_code_combinations;

  -- append gl_balances
  procedure update_gl_balances is
    query_date date;
  begin
    -- save query_date from etl_control 
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.T08_GL_BALANCES where start_date = query_date;
    update STD_LAYER.T08_GL_BALANCES
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
    -- update end_date for the CODE_COMBINATION_ID 
    merge into STD_LAYER.T08_GL_BALANCES HIS
    using (select report_id,
                  ledger_id,
                  code_combination_id,
                  currency_code,
                  period_name,
                  actual_flag,
                  last_update_date,
                  last_updated_by,
                  budget_version_id,
                  encumbrance_type_id,
                  translated_flag,
                  revaluation_status,
                  period_type,
                  period_year,
                  period_num,
                  period_net_dr,
                  period_net_cr,
                  period_to_date_adb,
                  quarter_to_date_dr,
                  quarter_to_date_cr,
                  quarter_to_date_adb,
                  year_to_date_adb,
                  project_to_date_dr,
                  project_to_date_cr,
                  project_to_date_adb,
                  begin_balance_dr,
                  begin_balance_cr,
                  period_net_dr_beq,
                  period_net_cr_beq,
                  begin_balance_dr_beq,
                  begin_balance_cr_beq,
                  template_id,
                  encumbrance_doc_id,
                  encumbrance_line_num,
                  quarter_to_date_dr_beq,
                  quarter_to_date_cr_beq,
                  project_to_date_dr_beq,
                  project_to_date_cr_beq
             from SRC_LAYER.EBS_GL_BALANCES
           minus
           select report_id,
                  ledger_id,
                  code_combination_id,
                  currency_code,
                  period_name,
                  actual_flag,
                  last_update_date,
                  last_updated_by,
                  budget_version_id,
                  encumbrance_type_id,
                  translated_flag,
                  revaluation_status,
                  period_type,
                  period_year,
                  period_num,
                  period_net_dr,
                  period_net_cr,
                  period_to_date_adb,
                  quarter_to_date_dr,
                  quarter_to_date_cr,
                  quarter_to_date_adb,
                  year_to_date_adb,
                  project_to_date_dr,
                  project_to_date_cr,
                  project_to_date_adb,
                  begin_balance_dr,
                  begin_balance_cr,
                  period_net_dr_beq,
                  period_net_cr_beq,
                  begin_balance_dr_beq,
                  begin_balance_cr_beq,
                  template_id,
                  encumbrance_doc_id,
                  encumbrance_line_num,
                  quarter_to_date_dr_beq,
                  quarter_to_date_cr_beq,
                  project_to_date_dr_beq,
                  project_to_date_cr_beq
           
             from STD_LAYER.T08_GL_BALANCES) DIF
    on (HIS.ledger_id = DIF.ledger_id and HIS.code_combination_id = DIF.code_combination_id)
    when matched then
      update set HIS.end_date = query_date;
  
    -- insert the nonredundant(new) records 
  
    insert into STD_LAYER.T08_GL_BALANCES
      with intersect_query as
       (select report_id,
               ledger_id,
               code_combination_id,
               currency_code,
               period_name,
               actual_flag,
               last_update_date,
               last_updated_by,
               budget_version_id,
               encumbrance_type_id,
               translated_flag,
               revaluation_status,
               period_type,
               period_year,
               period_num,
               period_net_dr,
               period_net_cr,
               period_to_date_adb,
               quarter_to_date_dr,
               quarter_to_date_cr,
               quarter_to_date_adb,
               year_to_date_adb,
               project_to_date_dr,
               project_to_date_cr,
               project_to_date_adb,
               begin_balance_dr,
               begin_balance_cr,
               period_net_dr_beq,
               period_net_cr_beq,
               begin_balance_dr_beq,
               begin_balance_cr_beq,
               template_id,
               encumbrance_doc_id,
               encumbrance_line_num,
               quarter_to_date_dr_beq,
               quarter_to_date_cr_beq,
               project_to_date_dr_beq,
               project_to_date_cr_beq
          from src_layer.ebs_GL_BALANCES
        intersect
        select report_id,
               ledger_id,
               code_combination_id,
               currency_code,
               period_name,
               actual_flag,
               last_update_date,
               last_updated_by,
               budget_version_id,
               encumbrance_type_id,
               translated_flag,
               revaluation_status,
               period_type,
               period_year,
               period_num,
               period_net_dr,
               period_net_cr,
               period_to_date_adb,
               quarter_to_date_dr,
               quarter_to_date_cr,
               quarter_to_date_adb,
               year_to_date_adb,
               project_to_date_dr,
               project_to_date_cr,
               project_to_date_adb,
               begin_balance_dr,
               begin_balance_cr,
               period_net_dr_beq,
               period_net_cr_beq,
               begin_balance_dr_beq,
               begin_balance_cr_beq,
               template_id,
               encumbrance_doc_id,
               encumbrance_line_num,
               quarter_to_date_dr_beq,
               quarter_to_date_cr_beq,
               project_to_date_dr_beq,
               project_to_date_cr_beq
          from STD_LAYER.T08_GL_BALANCES)
      select report_id,
             ledger_id,
             code_combination_id,
             currency_code,
             period_name,
             actual_flag,
             last_update_date,
             last_updated_by,
             budget_version_id,
             encumbrance_type_id,
             translated_flag,
             revaluation_status,
             period_type,
             period_year,
             period_num,
             period_net_dr,
             period_net_cr,
             period_to_date_adb,
             quarter_to_date_dr,
             quarter_to_date_cr,
             quarter_to_date_adb,
             year_to_date_adb,
             project_to_date_dr,
             project_to_date_cr,
             project_to_date_adb,
             begin_balance_dr,
             begin_balance_cr,
             period_net_dr_beq,
             period_net_cr_beq,
             begin_balance_dr_beq,
             begin_balance_cr_beq,
             template_id,
             encumbrance_doc_id,
             encumbrance_line_num,
             quarter_to_date_dr_beq,
             quarter_to_date_cr_beq,
             project_to_date_dr_beq,
             project_to_date_cr_beq,
             sysdate,
             data_date,
             to_date('9999-12-31', 'yyyy/mm/dd'),
             -1,
             ds_line_sequence.nextval
        from SRC_LAYER.EBS_GL_BALANCES
       where ledger_id not in (select ledger_id from intersect_query)
         and code_combination_id not in
             (select code_combination_id from intersect_query);
    commit;
    -- set header_id linked with header table
    merge into STD_LAYER.T08_GL_BALANCES a
    using (select * from STD_LAYER.DATA_HEADER) b
    on (a.start_date = b.data_date and b.report_flag = 'gl_balances')
    when matched then
      update set header_id = b.header_id;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.EBS_GL_BALANCES',
               'STD_LAYER.T08_GL_BALANCES',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.EBS_GL_BALANCES',
                 'STD_LAYER.T08_GL_BALANCES',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
    
  end update_gl_balances;

  -- update fnd_id_flex_segments
  procedure update_fnd_id_flex_segments is
    query_date date;
  begin
    -- save query_date from etl_control 
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.T08_FND_ID_FLEX_SEGMENTS
     where start_date = query_date;
    update STD_LAYER.T08_FND_ID_FLEX_SEGMENTS
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
    -- update end_date for the FND_ID_FLEX_SEGMENTS 
    merge into STD_LAYER.T08_FND_ID_FLEX_SEGMENTS HIS
    using (select report_id,
                  application_id,
                  id_flex_code,
                  id_flex_num,
                  application_column_name,
                  segment_name,
                  last_update_date,
                  last_updated_by,
                  creation_date,
                  created_by,
                  last_update_login,
                  segment_num,
                  application_column_index_flag,
                  enabled_flag,
                  required_flag,
                  display_flag,
                  display_size,
                  security_enabled_flag,
                  maximum_description_len,
                  concatenation_description_len,
                  flex_value_set_id,
                  range_code,
                  default_type,
                  default_value,
                  runtime_property_function,
                  additional_where_clause,
                  zd_edition_name,
                  zd_sync
             from SRC_LAYER.EBS_FND_ID_FLEX_SEGMENTS
           minus
           select report_id,
                  application_id,
                  id_flex_code,
                  id_flex_num,
                  application_column_name,
                  segment_name,
                  last_update_date,
                  last_updated_by,
                  creation_date,
                  created_by,
                  last_update_login,
                  segment_num,
                  application_column_index_flag,
                  enabled_flag,
                  required_flag,
                  display_flag,
                  display_size,
                  security_enabled_flag,
                  maximum_description_len,
                  concatenation_description_len,
                  flex_value_set_id,
                  range_code,
                  default_type,
                  default_value,
                  runtime_property_function,
                  additional_where_clause,
                  zd_edition_name,
                  zd_sync
             from STD_LAYER.T08_FND_ID_FLEX_SEGMENTS) DIF
    on (HIS.application_id = DIF.application_id)
    when matched then
      update set HIS.end_date = query_date;
  
    -- insert the nonredundant(new) records 
  
    insert into STD_LAYER.T08_FND_ID_FLEX_SEGMENTS
      with intersect_query as
       (select report_id,
               application_id,
               id_flex_code,
               id_flex_num,
               application_column_name,
               segment_name,
               last_update_date,
               last_updated_by,
               creation_date,
               created_by,
               last_update_login,
               segment_num,
               application_column_index_flag,
               enabled_flag,
               required_flag,
               display_flag,
               display_size,
               security_enabled_flag,
               maximum_description_len,
               concatenation_description_len,
               flex_value_set_id,
               range_code,
               default_type,
               default_value,
               runtime_property_function,
               additional_where_clause,
               zd_edition_name,
               zd_sync
          from src_layer.ebs_FND_ID_FLEX_SEGMENTS
        intersect
        select report_id,
               application_id,
               id_flex_code,
               id_flex_num,
               application_column_name,
               segment_name,
               last_update_date,
               last_updated_by,
               creation_date,
               created_by,
               last_update_login,
               segment_num,
               application_column_index_flag,
               enabled_flag,
               required_flag,
               display_flag,
               display_size,
               security_enabled_flag,
               maximum_description_len,
               concatenation_description_len,
               flex_value_set_id,
               range_code,
               default_type,
               default_value,
               runtime_property_function,
               additional_where_clause,
               zd_edition_name,
               zd_sync
          from STD_LAYER.T08_FND_ID_FLEX_SEGMENTS)
      select report_id,
             application_id,
             id_flex_code,
             id_flex_num,
             application_column_name,
             segment_name,
             last_update_date,
             last_updated_by,
             creation_date,
             created_by,
             last_update_login,
             segment_num,
             application_column_index_flag,
             enabled_flag,
             required_flag,
             display_flag,
             display_size,
             security_enabled_flag,
             maximum_description_len,
             concatenation_description_len,
             flex_value_set_id,
             range_code,
             default_type,
             default_value,
             runtime_property_function,
             additional_where_clause,
             zd_edition_name,
             zd_sync,
             sysdate,
             data_date,
             to_date('9999-12-31', 'yyyy/mm/dd'),
             -1,
             ds_line_sequence.nextval
        from SRC_LAYER.EBS_FND_ID_FLEX_SEGMENTS
       where application_id not in
             (select application_id from intersect_query);
    commit;
    -- set header_id linked with header table
    merge into STD_LAYER.T08_FND_ID_FLEX_SEGMENTS a
    using (select * from STD_LAYER.DATA_HEADER) b
    on (a.start_date = b.data_date and b.report_flag = 'fnd_id_flex_segments')
    when matched then
      update set header_id = b.header_id;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.EBS_FND_ID_FLEX_SEGMENTS',
               'STD_LAYER.T08_FND_ID_FLEX_SEGMENTS',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.EBS_FND_ID_FLEX_SEGMENTS',
                 'STD_LAYER.T08_FND_ID_FLEX_SEGMENTS',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
    
  end update_fnd_id_flex_segments;

  -- update fnd_flex_value_sets
  procedure update_fnd_flex_value_sets is
    query_date date;
  begin
    -- save query_date from etl_control 
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.T08_FND_FLEX_VALUE_SETS
     where start_date = query_date;
    update STD_LAYER.T08_FND_FLEX_VALUE_SETS
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
    -- update end_date for the FND_FLEX_VALUE_SETS 
    merge into STD_LAYER.T08_FND_FLEX_VALUE_SETS HIS
    using (select report_id,
                  flex_value_set_id,
                  flex_value_set_name,
                  last_update_date,
                  last_updated_by,
                  creation_date,
                  created_by,
                  last_update_login,
                  validation_type,
                  protected_flag,
                  security_enabled_flag,
                  longlist_flag,
                  format_type,
                  maximum_size,
                  alphanumeric_allowed_flag,
                  uppercase_only_flag,
                  numeric_mode_enabled_flag,
                  description,
                  dependant_default_value,
                  dependant_default_meaning,
                  parent_flex_value_set_id,
                  minimum_value,
                  maximum_value,
                  number_precision,
                  zd_edition_name,
                  zd_sync
             from SRC_LAYER.EBS_FND_FLEX_VALUE_SETS
           minus
           select report_id,
                  flex_value_set_id,
                  flex_value_set_name,
                  last_update_date,
                  last_updated_by,
                  creation_date,
                  created_by,
                  last_update_login,
                  validation_type,
                  protected_flag,
                  security_enabled_flag,
                  longlist_flag,
                  format_type,
                  maximum_size,
                  alphanumeric_allowed_flag,
                  uppercase_only_flag,
                  numeric_mode_enabled_flag,
                  description,
                  dependant_default_value,
                  dependant_default_meaning,
                  parent_flex_value_set_id,
                  minimum_value,
                  maximum_value,
                  number_precision,
                  zd_edition_name,
                  zd_sync
             from STD_LAYER.T08_FND_FLEX_VALUE_SETS) DIF
    on (HIS.flex_value_set_id = DIF.flex_value_set_id)
    when matched then
      update set HIS.end_date = query_date;
  
    -- insert the nonredundant(new) records 
  
    insert into STD_LAYER.T08_FND_FLEX_VALUE_SETS
      with intersect_query as
       (select report_id,
               flex_value_set_id,
               flex_value_set_name,
               last_update_date,
               last_updated_by,
               creation_date,
               created_by,
               last_update_login,
               validation_type,
               protected_flag,
               security_enabled_flag,
               longlist_flag,
               format_type,
               maximum_size,
               alphanumeric_allowed_flag,
               uppercase_only_flag,
               numeric_mode_enabled_flag,
               description,
               dependant_default_value,
               dependant_default_meaning,
               parent_flex_value_set_id,
               minimum_value,
               maximum_value,
               number_precision,
               zd_edition_name,
               zd_sync
          from src_layer.ebs_FND_FLEX_VALUE_SETS
        intersect
        select report_id,
               flex_value_set_id,
               flex_value_set_name,
               last_update_date,
               last_updated_by,
               creation_date,
               created_by,
               last_update_login,
               validation_type,
               protected_flag,
               security_enabled_flag,
               longlist_flag,
               format_type,
               maximum_size,
               alphanumeric_allowed_flag,
               uppercase_only_flag,
               numeric_mode_enabled_flag,
               description,
               dependant_default_value,
               dependant_default_meaning,
               parent_flex_value_set_id,
               minimum_value,
               maximum_value,
               number_precision,
               zd_edition_name,
               zd_sync
          from STD_LAYER.T08_FND_FLEX_VALUE_SETS)
      select report_id,
             flex_value_set_id,
             flex_value_set_name,
             last_update_date,
             last_updated_by,
             creation_date,
             created_by,
             last_update_login,
             validation_type,
             protected_flag,
             security_enabled_flag,
             longlist_flag,
             format_type,
             maximum_size,
             alphanumeric_allowed_flag,
             uppercase_only_flag,
             numeric_mode_enabled_flag,
             description,
             dependant_default_value,
             dependant_default_meaning,
             parent_flex_value_set_id,
             minimum_value,
             maximum_value,
             number_precision,
             zd_edition_name,
             zd_sync,
             sysdate,
             data_date,
             to_date('9999-12-31', 'yyyy/mm/dd'),
             -1,
             ds_line_sequence.nextval
        from SRC_LAYER.EBS_FND_FLEX_VALUE_SETS
       where flex_value_set_id not in
             (select flex_value_set_id from intersect_query);
    commit;
    -- set header_id linked with header table
    merge into STD_LAYER.T08_FND_FLEX_VALUE_SETS a
    using (select * from STD_LAYER.DATA_HEADER) b
    on (a.start_date = b.data_date and b.report_flag = 'fnd_flex_value_sets')
    when matched then
      update set header_id = b.header_id;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.EBS_FND_FLEX_VALUE_SETS',
               'STD_LAYER.T08_FND_FLEX_VALUE_SETS',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.EBS_FND_FLEX_VALUE_SETS',
                 'STD_LAYER.T08_FND_FLEX_VALUE_SETS',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
    
  end update_fnd_flex_value_sets;

  -- update fnd_flex_value
  procedure update_fnd_flex_values is
    query_date date;
  begin
    -- save query_date from etl_control 
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.T08_FND_FLEX_VALUES
     where start_date = query_date;
    update STD_LAYER.T08_FND_FLEX_VALUES
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
    -- update end_date for the FND_FLEX_VALUES 
    merge into STD_LAYER.T08_FND_FLEX_VALUES HIS
    using (select report_id,
                  flex_value_set_id,
                  flex_value_id,
                  flex_value,
                  last_update_date,
                  last_updated_by,
                  creation_date,
                  created_by,
                  last_update_login,
                  enabled_flag,
                  summary_flag,
                  start_date_active,
                  end_date_active,
                  parent_flex_value_low,
                  parent_flex_value_high,
                  structured_hierarchy_level,
                  hierarchy_level,
                  compiled_value_attributes,
                  value_category,
                  attribute1,
                  attribute2,
                  attribute3,
                  attribute4,
                  attribute5,
                  attribute6,
                  attribute7,
                  attribute8,
                  attribute9,
                  attribute10,
                  attribute11,
                  attribute12,
                  attribute13,
                  attribute14,
                  attribute15,
                  attribute16,
                  attribute17,
                  attribute18,
                  attribute19,
                  attribute20,
                  attribute21,
                  attribute22,
                  attribute23,
                  attribute24,
                  attribute25,
                  attribute26,
                  attribute27,
                  attribute28,
                  attribute29,
                  attribute30,
                  attribute31,
                  attribute32,
                  attribute33,
                  attribute34,
                  attribute35,
                  attribute36,
                  attribute37,
                  attribute38,
                  attribute39,
                  attribute40,
                  attribute41,
                  attribute42,
                  attribute43,
                  attribute44,
                  attribute45,
                  attribute46,
                  attribute47,
                  attribute48,
                  attribute49,
                  attribute50,
                  attribute_sort_order,
                  zd_edition_name,
                  zd_sync
             from SRC_LAYER.EBS_FND_FLEX_VALUES
           minus
           select report_id,
                  flex_value_set_id,
                  flex_value_id,
                  flex_value,
                  last_update_date,
                  last_updated_by,
                  creation_date,
                  created_by,
                  last_update_login,
                  enabled_flag,
                  summary_flag,
                  start_date_active,
                  end_date_active,
                  parent_flex_value_low,
                  parent_flex_value_high,
                  structured_hierarchy_level,
                  hierarchy_level,
                  compiled_value_attributes,
                  value_category,
                  attribute1,
                  attribute2,
                  attribute3,
                  attribute4,
                  attribute5,
                  attribute6,
                  attribute7,
                  attribute8,
                  attribute9,
                  attribute10,
                  attribute11,
                  attribute12,
                  attribute13,
                  attribute14,
                  attribute15,
                  attribute16,
                  attribute17,
                  attribute18,
                  attribute19,
                  attribute20,
                  attribute21,
                  attribute22,
                  attribute23,
                  attribute24,
                  attribute25,
                  attribute26,
                  attribute27,
                  attribute28,
                  attribute29,
                  attribute30,
                  attribute31,
                  attribute32,
                  attribute33,
                  attribute34,
                  attribute35,
                  attribute36,
                  attribute37,
                  attribute38,
                  attribute39,
                  attribute40,
                  attribute41,
                  attribute42,
                  attribute43,
                  attribute44,
                  attribute45,
                  attribute46,
                  attribute47,
                  attribute48,
                  attribute49,
                  attribute50,
                  attribute_sort_order,
                  zd_edition_name,
                  zd_sync
             from STD_LAYER.T08_FND_FLEX_VALUES) DIF
    on (HIS.flex_value_set_id = DIF.flex_value_set_id and HIS.flex_value_id = DIF.flex_value_id)
    when matched then
      update set HIS.end_date = query_date;
  
    -- insert the nonredundant(new) records 
  
    insert into STD_LAYER.T08_FND_FLEX_VALUES
      with intersect_query as
       (select report_id,
               flex_value_set_id,
               flex_value_id,
               flex_value,
               last_update_date,
               last_updated_by,
               creation_date,
               created_by,
               last_update_login,
               enabled_flag,
               summary_flag,
               start_date_active,
               end_date_active,
               parent_flex_value_low,
               parent_flex_value_high,
               structured_hierarchy_level,
               hierarchy_level,
               compiled_value_attributes,
               value_category,
               attribute1,
               attribute2,
               attribute3,
               attribute4,
               attribute5,
               attribute6,
               attribute7,
               attribute8,
               attribute9,
               attribute10,
               attribute11,
               attribute12,
               attribute13,
               attribute14,
               attribute15,
               attribute16,
               attribute17,
               attribute18,
               attribute19,
               attribute20,
               attribute21,
               attribute22,
               attribute23,
               attribute24,
               attribute25,
               attribute26,
               attribute27,
               attribute28,
               attribute29,
               attribute30,
               attribute31,
               attribute32,
               attribute33,
               attribute34,
               attribute35,
               attribute36,
               attribute37,
               attribute38,
               attribute39,
               attribute40,
               attribute41,
               attribute42,
               attribute43,
               attribute44,
               attribute45,
               attribute46,
               attribute47,
               attribute48,
               attribute49,
               attribute50,
               attribute_sort_order,
               zd_edition_name,
               zd_sync
          from src_layer.ebs_FND_FLEX_VALUES
        intersect
        select report_id,
               flex_value_set_id,
               flex_value_id,
               flex_value,
               last_update_date,
               last_updated_by,
               creation_date,
               created_by,
               last_update_login,
               enabled_flag,
               summary_flag,
               start_date_active,
               end_date_active,
               parent_flex_value_low,
               parent_flex_value_high,
               structured_hierarchy_level,
               hierarchy_level,
               compiled_value_attributes,
               value_category,
               attribute1,
               attribute2,
               attribute3,
               attribute4,
               attribute5,
               attribute6,
               attribute7,
               attribute8,
               attribute9,
               attribute10,
               attribute11,
               attribute12,
               attribute13,
               attribute14,
               attribute15,
               attribute16,
               attribute17,
               attribute18,
               attribute19,
               attribute20,
               attribute21,
               attribute22,
               attribute23,
               attribute24,
               attribute25,
               attribute26,
               attribute27,
               attribute28,
               attribute29,
               attribute30,
               attribute31,
               attribute32,
               attribute33,
               attribute34,
               attribute35,
               attribute36,
               attribute37,
               attribute38,
               attribute39,
               attribute40,
               attribute41,
               attribute42,
               attribute43,
               attribute44,
               attribute45,
               attribute46,
               attribute47,
               attribute48,
               attribute49,
               attribute50,
               attribute_sort_order,
               zd_edition_name,
               zd_sync
          from STD_LAYER.T08_FND_FLEX_VALUES)
      select report_id,
             flex_value_set_id,
             flex_value_id,
             flex_value,
             last_update_date,
             last_updated_by,
             creation_date,
             created_by,
             last_update_login,
             enabled_flag,
             summary_flag,
             start_date_active,
             end_date_active,
             parent_flex_value_low,
             parent_flex_value_high,
             structured_hierarchy_level,
             hierarchy_level,
             compiled_value_attributes,
             value_category,
             attribute1,
             attribute2,
             attribute3,
             attribute4,
             attribute5,
             attribute6,
             attribute7,
             attribute8,
             attribute9,
             attribute10,
             attribute11,
             attribute12,
             attribute13,
             attribute14,
             attribute15,
             attribute16,
             attribute17,
             attribute18,
             attribute19,
             attribute20,
             attribute21,
             attribute22,
             attribute23,
             attribute24,
             attribute25,
             attribute26,
             attribute27,
             attribute28,
             attribute29,
             attribute30,
             attribute31,
             attribute32,
             attribute33,
             attribute34,
             attribute35,
             attribute36,
             attribute37,
             attribute38,
             attribute39,
             attribute40,
             attribute41,
             attribute42,
             attribute43,
             attribute44,
             attribute45,
             attribute46,
             attribute47,
             attribute48,
             attribute49,
             attribute50,
             attribute_sort_order,
             zd_edition_name,
             zd_sync,
             sysdate,
             data_date,
             to_date('9999-12-31', 'yyyy/mm/dd'),
             -1,
             ds_line_sequence.nextval
        from SRC_LAYER.EBS_FND_FLEX_VALUES
       where flex_value_set_id not in
             (select flex_value_set_id from intersect_query)
         and flex_value_id not in
             (select flex_value_id from intersect_query);
    commit;
    -- set header_id linked with header table
    merge into STD_LAYER.T08_FND_FLEX_VALUES a
    using (select * from STD_LAYER.DATA_HEADER) b
    on (a.start_date = b.data_date and b.report_flag = 'fnd_flex_values')
    when matched then
      update set header_id = b.header_id;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.EBS_FND_FLEX_VALUES',
               'STD_LAYER.T08_FND_FLEX_VALUES',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.EBS_FND_FLEX_VALUES',
                 'STD_LAYER.T08_FND_FLEX_VALUES',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
    
  end update_fnd_flex_values;
  -- update ap_invoice_lines_all
  procedure update_ap_invoice_lines_all is
    query_date date;
  begin
    -- save query_date from etl_control 
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.T05_AP_INVOICE_LINES_ALL
     where start_date = query_date;
    update STD_LAYER.T05_AP_INVOICE_LINES_ALL
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
    -- update end_date for the AP_INVOICE_LINES_ALL
    merge into STD_LAYER.T05_AP_INVOICE_LINES_ALL HIS
    using (select report_id,
                  invoice_id,
                  line_number,
                  line_type_lookup_code,
                  requester_id,
                  description,
                  line_source,
                  org_id,
                  line_group_number,
                  inventory_item_id,
                  item_description,
                  serial_number,
                  manufacturer,
                  model_number,
                  warranty_number,
                  generate_dists,
                  match_type,
                  distribution_set_id,
                  account_segment,
                  balancing_segment,
                  cost_center_segment,
                  overlay_dist_code_concat,
                  default_dist_ccid,
                  prorate_across_all_items,
                  accounting_date,
                  period_name,
                  deferred_acctg_flag,
                  def_acctg_start_date,
                  def_acctg_end_date,
                  def_acctg_number_of_periods,
                  def_acctg_period_type,
                  set_of_books_id,
                  amount,
                  base_amount,
                  rounding_amt,
                  quantity_invoiced,
                  unit_meas_lookup_code,
                  unit_price,
                  wfapproval_status,
                  ussgl_transaction_code,
                  discarded_flag,
                  original_amount,
                  original_base_amount,
                  original_rounding_amt,
                  cancelled_flag,
                  income_tax_region,
                  type_1099,
                  stat_amount,
                  prepay_invoice_id,
                  prepay_line_number,
                  invoice_includes_prepay_flag,
                  corrected_inv_id,
                  corrected_line_number,
                  po_header_id,
                  po_line_id,
                  po_release_id,
                  po_line_location_id,
                  po_distribution_id,
                  rcv_transaction_id,
                  final_match_flag,
                  assets_tracking_flag,
                  asset_book_type_code,
                  asset_category_id,
                  project_id,
                  task_id,
                  expenditure_type,
                  expenditure_item_date,
                  expenditure_organization_id,
                  pa_quantity,
                  pa_cc_ar_invoice_id,
                  pa_cc_ar_invoice_line_num,
                  pa_cc_processed_code,
                  award_id,
                  awt_group_id,
                  reference_1,
                  reference_2,
                  receipt_verified_flag,
                  receipt_required_flag,
                  receipt_missing_flag,
                  justification,
                  expense_group,
                  start_expense_date,
                  end_expense_date,
                  receipt_currency_code,
                  receipt_conversion_rate,
                  receipt_currency_amount,
                  daily_amount,
                  web_parameter_id,
                  adjustment_reason,
                  merchant_document_number,
                  merchant_name,
                  merchant_reference,
                  merchant_tax_reg_number,
                  merchant_taxpayer_id,
                  country_of_supply,
                  credit_card_trx_id,
                  company_prepaid_invoice_id,
                  cc_reversal_flag,
                  creation_date,
                  created_by,
                  last_updated_by,
                  last_update_date,
                  last_update_login,
                  program_application_id,
                  program_id,
                  program_update_date,
                  request_id,
                  attribute_category,
                  attribute1,
                  attribute2,
                  attribute3,
                  attribute4,
                  attribute5,
                  attribute6,
                  attribute7,
                  attribute8,
                  attribute9,
                  attribute10,
                  attribute11,
                  attribute12,
                  attribute13,
                  attribute14,
                  attribute15,
                  global_attribute_category,
                  global_attribute1,
                  global_attribute2,
                  global_attribute3,
                  global_attribute4,
                  global_attribute5,
                  global_attribute6,
                  global_attribute7,
                  global_attribute8,
                  global_attribute9,
                  global_attribute10,
                  global_attribute11,
                  global_attribute12,
                  global_attribute13,
                  global_attribute14,
                  global_attribute15,
                  global_attribute16,
                  global_attribute17,
                  global_attribute18,
                  global_attribute19,
                  global_attribute20,
                  line_selected_for_appl_flag,
                  prepay_appl_request_id,
                  application_id,
                  product_table,
                  reference_key1,
                  reference_key2,
                  reference_key3,
                  reference_key4,
                  reference_key5,
                  purchasing_category_id,
                  cost_factor_id,
                  control_amount,
                  assessable_value,
                  total_rec_tax_amount,
                  total_nrec_tax_amount,
                  total_rec_tax_amt_funcl_curr,
                  total_nrec_tax_amt_funcl_curr,
                  included_tax_amount,
                  primary_intended_use,
                  tax_already_calculated_flag,
                  ship_to_location_id,
                  product_type,
                  product_category,
                  product_fisc_classification,
                  user_defined_fisc_class,
                  trx_business_category,
                  summary_tax_line_id,
                  tax_regime_code,
                  tax,
                  tax_jurisdiction_code,
                  tax_status_code,
                  tax_rate_id,
                  tax_rate_code,
                  tax_rate,
                  tax_code_id,
                  historical_flag,
                  tax_classification_code,
                  source_application_id,
                  source_event_class_code,
                  source_entity_code,
                  source_trx_id,
                  source_line_id,
                  source_trx_level_type,
                  retained_amount,
                  retained_amount_remaining,
                  retained_invoice_id,
                  retained_line_number,
                  line_selected_for_release_flag,
                  line_owner_role,
                  disputable_flag,
                  rcv_shipment_line_id,
                  ail_invoice_id,
                  ail_distribution_line_number,
                  ail_invoice_id2,
                  ail_distribution_line_number2,
                  ail_invoice_id3,
                  ail_distribution_line_number3,
                  ail_invoice_id4,
                  pay_awt_group_id,
                  merchant_name#1
             from SRC_LAYER.EBS_AP_INVOICE_LINES_ALL
           minus
           select report_id,
                  invoice_id,
                  line_number,
                  line_type_lookup_code,
                  requester_id,
                  description,
                  line_source,
                  org_id,
                  line_group_number,
                  inventory_item_id,
                  item_description,
                  serial_number,
                  manufacturer,
                  model_number,
                  warranty_number,
                  generate_dists,
                  match_type,
                  distribution_set_id,
                  account_segment,
                  balancing_segment,
                  cost_center_segment,
                  overlay_dist_code_concat,
                  default_dist_ccid,
                  prorate_across_all_items,
                  accounting_date,
                  period_name,
                  deferred_acctg_flag,
                  def_acctg_start_date,
                  def_acctg_end_date,
                  def_acctg_number_of_periods,
                  def_acctg_period_type,
                  set_of_books_id,
                  amount,
                  base_amount,
                  rounding_amt,
                  quantity_invoiced,
                  unit_meas_lookup_code,
                  unit_price,
                  wfapproval_status,
                  ussgl_transaction_code,
                  discarded_flag,
                  original_amount,
                  original_base_amount,
                  original_rounding_amt,
                  cancelled_flag,
                  income_tax_region,
                  type_1099,
                  stat_amount,
                  prepay_invoice_id,
                  prepay_line_number,
                  invoice_includes_prepay_flag,
                  corrected_inv_id,
                  corrected_line_number,
                  po_header_id,
                  po_line_id,
                  po_release_id,
                  po_line_location_id,
                  po_distribution_id,
                  rcv_transaction_id,
                  final_match_flag,
                  assets_tracking_flag,
                  asset_book_type_code,
                  asset_category_id,
                  project_id,
                  task_id,
                  expenditure_type,
                  expenditure_item_date,
                  expenditure_organization_id,
                  pa_quantity,
                  pa_cc_ar_invoice_id,
                  pa_cc_ar_invoice_line_num,
                  pa_cc_processed_code,
                  award_id,
                  awt_group_id,
                  reference_1,
                  reference_2,
                  receipt_verified_flag,
                  receipt_required_flag,
                  receipt_missing_flag,
                  justification,
                  expense_group,
                  start_expense_date,
                  end_expense_date,
                  receipt_currency_code,
                  receipt_conversion_rate,
                  receipt_currency_amount,
                  daily_amount,
                  web_parameter_id,
                  adjustment_reason,
                  merchant_document_number,
                  merchant_name,
                  merchant_reference,
                  merchant_tax_reg_number,
                  merchant_taxpayer_id,
                  country_of_supply,
                  credit_card_trx_id,
                  company_prepaid_invoice_id,
                  cc_reversal_flag,
                  creation_date,
                  created_by,
                  last_updated_by,
                  last_update_date,
                  last_update_login,
                  program_application_id,
                  program_id,
                  program_update_date,
                  request_id,
                  attribute_category,
                  attribute1,
                  attribute2,
                  attribute3,
                  attribute4,
                  attribute5,
                  attribute6,
                  attribute7,
                  attribute8,
                  attribute9,
                  attribute10,
                  attribute11,
                  attribute12,
                  attribute13,
                  attribute14,
                  attribute15,
                  global_attribute_category,
                  global_attribute1,
                  global_attribute2,
                  global_attribute3,
                  global_attribute4,
                  global_attribute5,
                  global_attribute6,
                  global_attribute7,
                  global_attribute8,
                  global_attribute9,
                  global_attribute10,
                  global_attribute11,
                  global_attribute12,
                  global_attribute13,
                  global_attribute14,
                  global_attribute15,
                  global_attribute16,
                  global_attribute17,
                  global_attribute18,
                  global_attribute19,
                  global_attribute20,
                  line_selected_for_appl_flag,
                  prepay_appl_request_id,
                  application_id,
                  product_table,
                  reference_key1,
                  reference_key2,
                  reference_key3,
                  reference_key4,
                  reference_key5,
                  purchasing_category_id,
                  cost_factor_id,
                  control_amount,
                  assessable_value,
                  total_rec_tax_amount,
                  total_nrec_tax_amount,
                  total_rec_tax_amt_funcl_curr,
                  total_nrec_tax_amt_funcl_curr,
                  included_tax_amount,
                  primary_intended_use,
                  tax_already_calculated_flag,
                  ship_to_location_id,
                  product_type,
                  product_category,
                  product_fisc_classification,
                  user_defined_fisc_class,
                  trx_business_category,
                  summary_tax_line_id,
                  tax_regime_code,
                  tax,
                  tax_jurisdiction_code,
                  tax_status_code,
                  tax_rate_id,
                  tax_rate_code,
                  tax_rate,
                  tax_code_id,
                  historical_flag,
                  tax_classification_code,
                  source_application_id,
                  source_event_class_code,
                  source_entity_code,
                  source_trx_id,
                  source_line_id,
                  source_trx_level_type,
                  retained_amount,
                  retained_amount_remaining,
                  retained_invoice_id,
                  retained_line_number,
                  line_selected_for_release_flag,
                  line_owner_role,
                  disputable_flag,
                  rcv_shipment_line_id,
                  ail_invoice_id,
                  ail_distribution_line_number,
                  ail_invoice_id2,
                  ail_distribution_line_number2,
                  ail_invoice_id3,
                  ail_distribution_line_number3,
                  ail_invoice_id4,
                  pay_awt_group_id,
                  merchant_name#1
             from STD_LAYER.T05_AP_INVOICE_LINES_ALL) DIF
    on (HIS.invoice_id = DIF.invoice_id and HIS.line_number = DIF.line_number)
    when matched then
      update set HIS.end_date = query_date;
  
    -- insert the nonredundant(new) records 
  
    insert into STD_LAYER.T05_AP_INVOICE_LINES_ALL
      with intersect_query as
       (select report_id,
               invoice_id,
               line_number,
               line_type_lookup_code,
               requester_id,
               description,
               line_source,
               org_id,
               line_group_number,
               inventory_item_id,
               item_description,
               serial_number,
               manufacturer,
               model_number,
               warranty_number,
               generate_dists,
               match_type,
               distribution_set_id,
               account_segment,
               balancing_segment,
               cost_center_segment,
               overlay_dist_code_concat,
               default_dist_ccid,
               prorate_across_all_items,
               accounting_date,
               period_name,
               deferred_acctg_flag,
               def_acctg_start_date,
               def_acctg_end_date,
               def_acctg_number_of_periods,
               def_acctg_period_type,
               set_of_books_id,
               amount,
               base_amount,
               rounding_amt,
               quantity_invoiced,
               unit_meas_lookup_code,
               unit_price,
               wfapproval_status,
               ussgl_transaction_code,
               discarded_flag,
               original_amount,
               original_base_amount,
               original_rounding_amt,
               cancelled_flag,
               income_tax_region,
               type_1099,
               stat_amount,
               prepay_invoice_id,
               prepay_line_number,
               invoice_includes_prepay_flag,
               corrected_inv_id,
               corrected_line_number,
               po_header_id,
               po_line_id,
               po_release_id,
               po_line_location_id,
               po_distribution_id,
               rcv_transaction_id,
               final_match_flag,
               assets_tracking_flag,
               asset_book_type_code,
               asset_category_id,
               project_id,
               task_id,
               expenditure_type,
               expenditure_item_date,
               expenditure_organization_id,
               pa_quantity,
               pa_cc_ar_invoice_id,
               pa_cc_ar_invoice_line_num,
               pa_cc_processed_code,
               award_id,
               awt_group_id,
               reference_1,
               reference_2,
               receipt_verified_flag,
               receipt_required_flag,
               receipt_missing_flag,
               justification,
               expense_group,
               start_expense_date,
               end_expense_date,
               receipt_currency_code,
               receipt_conversion_rate,
               receipt_currency_amount,
               daily_amount,
               web_parameter_id,
               adjustment_reason,
               merchant_document_number,
               merchant_name,
               merchant_reference,
               merchant_tax_reg_number,
               merchant_taxpayer_id,
               country_of_supply,
               credit_card_trx_id,
               company_prepaid_invoice_id,
               cc_reversal_flag,
               creation_date,
               created_by,
               last_updated_by,
               last_update_date,
               last_update_login,
               program_application_id,
               program_id,
               program_update_date,
               request_id,
               attribute_category,
               attribute1,
               attribute2,
               attribute3,
               attribute4,
               attribute5,
               attribute6,
               attribute7,
               attribute8,
               attribute9,
               attribute10,
               attribute11,
               attribute12,
               attribute13,
               attribute14,
               attribute15,
               global_attribute_category,
               global_attribute1,
               global_attribute2,
               global_attribute3,
               global_attribute4,
               global_attribute5,
               global_attribute6,
               global_attribute7,
               global_attribute8,
               global_attribute9,
               global_attribute10,
               global_attribute11,
               global_attribute12,
               global_attribute13,
               global_attribute14,
               global_attribute15,
               global_attribute16,
               global_attribute17,
               global_attribute18,
               global_attribute19,
               global_attribute20,
               line_selected_for_appl_flag,
               prepay_appl_request_id,
               application_id,
               product_table,
               reference_key1,
               reference_key2,
               reference_key3,
               reference_key4,
               reference_key5,
               purchasing_category_id,
               cost_factor_id,
               control_amount,
               assessable_value,
               total_rec_tax_amount,
               total_nrec_tax_amount,
               total_rec_tax_amt_funcl_curr,
               total_nrec_tax_amt_funcl_curr,
               included_tax_amount,
               primary_intended_use,
               tax_already_calculated_flag,
               ship_to_location_id,
               product_type,
               product_category,
               product_fisc_classification,
               user_defined_fisc_class,
               trx_business_category,
               summary_tax_line_id,
               tax_regime_code,
               tax,
               tax_jurisdiction_code,
               tax_status_code,
               tax_rate_id,
               tax_rate_code,
               tax_rate,
               tax_code_id,
               historical_flag,
               tax_classification_code,
               source_application_id,
               source_event_class_code,
               source_entity_code,
               source_trx_id,
               source_line_id,
               source_trx_level_type,
               retained_amount,
               retained_amount_remaining,
               retained_invoice_id,
               retained_line_number,
               line_selected_for_release_flag,
               line_owner_role,
               disputable_flag,
               rcv_shipment_line_id,
               ail_invoice_id,
               ail_distribution_line_number,
               ail_invoice_id2,
               ail_distribution_line_number2,
               ail_invoice_id3,
               ail_distribution_line_number3,
               ail_invoice_id4,
               pay_awt_group_id,
               merchant_name#1
          from src_layer.ebs_AP_INVOICE_LINES_ALL
        intersect
        select report_id,
               invoice_id,
               line_number,
               line_type_lookup_code,
               requester_id,
               description,
               line_source,
               org_id,
               line_group_number,
               inventory_item_id,
               item_description,
               serial_number,
               manufacturer,
               model_number,
               warranty_number,
               generate_dists,
               match_type,
               distribution_set_id,
               account_segment,
               balancing_segment,
               cost_center_segment,
               overlay_dist_code_concat,
               default_dist_ccid,
               prorate_across_all_items,
               accounting_date,
               period_name,
               deferred_acctg_flag,
               def_acctg_start_date,
               def_acctg_end_date,
               def_acctg_number_of_periods,
               def_acctg_period_type,
               set_of_books_id,
               amount,
               base_amount,
               rounding_amt,
               quantity_invoiced,
               unit_meas_lookup_code,
               unit_price,
               wfapproval_status,
               ussgl_transaction_code,
               discarded_flag,
               original_amount,
               original_base_amount,
               original_rounding_amt,
               cancelled_flag,
               income_tax_region,
               type_1099,
               stat_amount,
               prepay_invoice_id,
               prepay_line_number,
               invoice_includes_prepay_flag,
               corrected_inv_id,
               corrected_line_number,
               po_header_id,
               po_line_id,
               po_release_id,
               po_line_location_id,
               po_distribution_id,
               rcv_transaction_id,
               final_match_flag,
               assets_tracking_flag,
               asset_book_type_code,
               asset_category_id,
               project_id,
               task_id,
               expenditure_type,
               expenditure_item_date,
               expenditure_organization_id,
               pa_quantity,
               pa_cc_ar_invoice_id,
               pa_cc_ar_invoice_line_num,
               pa_cc_processed_code,
               award_id,
               awt_group_id,
               reference_1,
               reference_2,
               receipt_verified_flag,
               receipt_required_flag,
               receipt_missing_flag,
               justification,
               expense_group,
               start_expense_date,
               end_expense_date,
               receipt_currency_code,
               receipt_conversion_rate,
               receipt_currency_amount,
               daily_amount,
               web_parameter_id,
               adjustment_reason,
               merchant_document_number,
               merchant_name,
               merchant_reference,
               merchant_tax_reg_number,
               merchant_taxpayer_id,
               country_of_supply,
               credit_card_trx_id,
               company_prepaid_invoice_id,
               cc_reversal_flag,
               creation_date,
               created_by,
               last_updated_by,
               last_update_date,
               last_update_login,
               program_application_id,
               program_id,
               program_update_date,
               request_id,
               attribute_category,
               attribute1,
               attribute2,
               attribute3,
               attribute4,
               attribute5,
               attribute6,
               attribute7,
               attribute8,
               attribute9,
               attribute10,
               attribute11,
               attribute12,
               attribute13,
               attribute14,
               attribute15,
               global_attribute_category,
               global_attribute1,
               global_attribute2,
               global_attribute3,
               global_attribute4,
               global_attribute5,
               global_attribute6,
               global_attribute7,
               global_attribute8,
               global_attribute9,
               global_attribute10,
               global_attribute11,
               global_attribute12,
               global_attribute13,
               global_attribute14,
               global_attribute15,
               global_attribute16,
               global_attribute17,
               global_attribute18,
               global_attribute19,
               global_attribute20,
               line_selected_for_appl_flag,
               prepay_appl_request_id,
               application_id,
               product_table,
               reference_key1,
               reference_key2,
               reference_key3,
               reference_key4,
               reference_key5,
               purchasing_category_id,
               cost_factor_id,
               control_amount,
               assessable_value,
               total_rec_tax_amount,
               total_nrec_tax_amount,
               total_rec_tax_amt_funcl_curr,
               total_nrec_tax_amt_funcl_curr,
               included_tax_amount,
               primary_intended_use,
               tax_already_calculated_flag,
               ship_to_location_id,
               product_type,
               product_category,
               product_fisc_classification,
               user_defined_fisc_class,
               trx_business_category,
               summary_tax_line_id,
               tax_regime_code,
               tax,
               tax_jurisdiction_code,
               tax_status_code,
               tax_rate_id,
               tax_rate_code,
               tax_rate,
               tax_code_id,
               historical_flag,
               tax_classification_code,
               source_application_id,
               source_event_class_code,
               source_entity_code,
               source_trx_id,
               source_line_id,
               source_trx_level_type,
               retained_amount,
               retained_amount_remaining,
               retained_invoice_id,
               retained_line_number,
               line_selected_for_release_flag,
               line_owner_role,
               disputable_flag,
               rcv_shipment_line_id,
               ail_invoice_id,
               ail_distribution_line_number,
               ail_invoice_id2,
               ail_distribution_line_number2,
               ail_invoice_id3,
               ail_distribution_line_number3,
               ail_invoice_id4,
               pay_awt_group_id,
               merchant_name#1
          from STD_LAYER.T05_AP_INVOICE_LINES_ALL)
      select report_id,
             invoice_id,
             line_number,
             line_type_lookup_code,
             requester_id,
             description,
             line_source,
             org_id,
             line_group_number,
             inventory_item_id,
             item_description,
             serial_number,
             manufacturer,
             model_number,
             warranty_number,
             generate_dists,
             match_type,
             distribution_set_id,
             account_segment,
             balancing_segment,
             cost_center_segment,
             overlay_dist_code_concat,
             default_dist_ccid,
             prorate_across_all_items,
             accounting_date,
             period_name,
             deferred_acctg_flag,
             def_acctg_start_date,
             def_acctg_end_date,
             def_acctg_number_of_periods,
             def_acctg_period_type,
             set_of_books_id,
             amount,
             base_amount,
             rounding_amt,
             quantity_invoiced,
             unit_meas_lookup_code,
             unit_price,
             wfapproval_status,
             ussgl_transaction_code,
             discarded_flag,
             original_amount,
             original_base_amount,
             original_rounding_amt,
             cancelled_flag,
             income_tax_region,
             type_1099,
             stat_amount,
             prepay_invoice_id,
             prepay_line_number,
             invoice_includes_prepay_flag,
             corrected_inv_id,
             corrected_line_number,
             po_header_id,
             po_line_id,
             po_release_id,
             po_line_location_id,
             po_distribution_id,
             rcv_transaction_id,
             final_match_flag,
             assets_tracking_flag,
             asset_book_type_code,
             asset_category_id,
             project_id,
             task_id,
             expenditure_type,
             expenditure_item_date,
             expenditure_organization_id,
             pa_quantity,
             pa_cc_ar_invoice_id,
             pa_cc_ar_invoice_line_num,
             pa_cc_processed_code,
             award_id,
             awt_group_id,
             reference_1,
             reference_2,
             receipt_verified_flag,
             receipt_required_flag,
             receipt_missing_flag,
             justification,
             expense_group,
             start_expense_date,
             end_expense_date,
             receipt_currency_code,
             receipt_conversion_rate,
             receipt_currency_amount,
             daily_amount,
             web_parameter_id,
             adjustment_reason,
             merchant_document_number,
             merchant_name,
             merchant_reference,
             merchant_tax_reg_number,
             merchant_taxpayer_id,
             country_of_supply,
             credit_card_trx_id,
             company_prepaid_invoice_id,
             cc_reversal_flag,
             creation_date,
             created_by,
             last_updated_by,
             last_update_date,
             last_update_login,
             program_application_id,
             program_id,
             program_update_date,
             request_id,
             attribute_category,
             attribute1,
             attribute2,
             attribute3,
             attribute4,
             attribute5,
             attribute6,
             attribute7,
             attribute8,
             attribute9,
             attribute10,
             attribute11,
             attribute12,
             attribute13,
             attribute14,
             attribute15,
             global_attribute_category,
             global_attribute1,
             global_attribute2,
             global_attribute3,
             global_attribute4,
             global_attribute5,
             global_attribute6,
             global_attribute7,
             global_attribute8,
             global_attribute9,
             global_attribute10,
             global_attribute11,
             global_attribute12,
             global_attribute13,
             global_attribute14,
             global_attribute15,
             global_attribute16,
             global_attribute17,
             global_attribute18,
             global_attribute19,
             global_attribute20,
             line_selected_for_appl_flag,
             prepay_appl_request_id,
             application_id,
             product_table,
             reference_key1,
             reference_key2,
             reference_key3,
             reference_key4,
             reference_key5,
             purchasing_category_id,
             cost_factor_id,
             control_amount,
             assessable_value,
             total_rec_tax_amount,
             total_nrec_tax_amount,
             total_rec_tax_amt_funcl_curr,
             total_nrec_tax_amt_funcl_curr,
             included_tax_amount,
             primary_intended_use,
             tax_already_calculated_flag,
             ship_to_location_id,
             product_type,
             product_category,
             product_fisc_classification,
             user_defined_fisc_class,
             trx_business_category,
             summary_tax_line_id,
             tax_regime_code,
             tax,
             tax_jurisdiction_code,
             tax_status_code,
             tax_rate_id,
             tax_rate_code,
             tax_rate,
             tax_code_id,
             historical_flag,
             tax_classification_code,
             source_application_id,
             source_event_class_code,
             source_entity_code,
             source_trx_id,
             source_line_id,
             source_trx_level_type,
             retained_amount,
             retained_amount_remaining,
             retained_invoice_id,
             retained_line_number,
             line_selected_for_release_flag,
             line_owner_role,
             disputable_flag,
             rcv_shipment_line_id,
             ail_invoice_id,
             ail_distribution_line_number,
             ail_invoice_id2,
             ail_distribution_line_number2,
             ail_invoice_id3,
             ail_distribution_line_number3,
             ail_invoice_id4,
             pay_awt_group_id,
             merchant_name#1,
             sysdate,
             data_date,
             to_date('9999-12-31', 'yyyy/mm/dd'),
             -1,
             ds_line_sequence.nextval
        from SRC_LAYER.EBS_AP_INVOICE_LINES_ALL
       where invoice_id not in (select invoice_id from intersect_query)
         and line_number not in (select line_number from intersect_query);
    commit;
    -- set header_id linked with header table
    merge into STD_LAYER.T05_AP_INVOICE_LINES_ALL a
    using (select * from STD_LAYER.DATA_HEADER) b
    on (a.start_date = b.data_date and b.report_flag = 'ap_invoice_lines_all')
    when matched then
      update set header_id = b.header_id;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.EBS_AP_INVOICE_LINES_ALL',
               'STD_LAYER.T05_AP_INVOICE_LINES_ALL',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.EBS_AP_INVOICE_LINES_ALL',
                 'STD_LAYER.T05_AP_INVOICE_LINES_ALL',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
    
  end update_ap_invoice_lines_all;

  procedure update_ap_invoice_distributions_all is
    query_date date;
  begin
    -- save query_date from etl_control 
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.T05_AP_INVOICE_DISTRIBUTIONS_ALL
     where start_date = query_date;
    update STD_LAYER.T05_AP_INVOICE_DISTRIBUTIONS_ALL
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
    -- update end_date for the AP_INVOICE_DISTRIBUTIONS_ALL
    merge into STD_LAYER.T05_AP_INVOICE_DISTRIBUTIONS_ALL HIS
    using (select report_id,
                  accounting_date,
                  accrual_posted_flag,
                  assets_addition_flag,
                  assets_tracking_flag,
                  cash_posted_flag,
                  distribution_line_number,
                  dist_code_combination_id,
                  invoice_id,
                  last_updated_by,
                  last_update_date,
                  line_type_lookup_code,
                  period_name,
                  set_of_books_id,
                  accts_pay_code_combination_id,
                  amount,
                  base_amount,
                  base_invoice_price_variance,
                  batch_id,
                  created_by,
                  creation_date,
                  description,
                  exchange_rate_variance,
                  final_match_flag,
                  income_tax_region,
                  invoice_price_variance,
                  last_update_login,
                  match_status_flag,
                  posted_flag,
                  po_distribution_id,
                  program_application_id,
                  program_id,
                  program_update_date,
                  quantity_invoiced,
                  rate_var_code_combination_id,
                  request_id,
                  reversal_flag,
                  type_1099,
                  unit_price,
                  amount_encumbered,
                  base_amount_encumbered,
                  encumbered_flag,
                  exchange_date,
                  exchange_rate,
                  exchange_rate_type,
                  price_adjustment_flag,
                  price_var_code_combination_id,
                  quantity_unencumbered,
                  stat_amount,
                  amount_to_post,
                  attribute1,
                  attribute10,
                  attribute11,
                  attribute12,
                  attribute13,
                  attribute14,
                  attribute15,
                  attribute2,
                  attribute3,
                  attribute4,
                  attribute5,
                  attribute6,
                  attribute7,
                  attribute8,
                  attribute9,
                  attribute_category,
                  base_amount_to_post,
                  cash_je_batch_id,
                  expenditure_item_date,
                  expenditure_organization_id,
                  expenditure_type,
                  je_batch_id,
                  parent_invoice_id,
                  pa_addition_flag,
                  pa_quantity,
                  posted_amount,
                  posted_base_amount,
                  prepay_amount_remaining,
                  project_accounting_context,
                  project_id,
                  task_id,
                  ussgl_transaction_code,
                  ussgl_trx_code_context,
                  earliest_settlement_date,
                  req_distribution_id,
                  quantity_variance,
                  base_quantity_variance,
                  packet_id,
                  awt_flag,
                  awt_group_id,
                  awt_tax_rate_id,
                  awt_gross_amount,
                  awt_invoice_id,
                  awt_origin_group_id,
                  reference_1,
                  reference_2,
                  org_id,
                  other_invoice_id,
                  awt_invoice_payment_id,
                  global_attribute_category,
                  global_attribute1,
                  global_attribute2,
                  global_attribute3,
                  global_attribute4,
                  global_attribute5,
                  global_attribute6,
                  global_attribute7,
                  global_attribute8,
                  global_attribute9,
                  global_attribute10,
                  global_attribute11,
                  global_attribute12,
                  global_attribute13,
                  global_attribute14,
                  global_attribute15,
                  global_attribute16,
                  global_attribute17,
                  global_attribute18,
                  global_attribute19,
                  global_attribute20,
                  line_group_number,
                  receipt_verified_flag,
                  receipt_required_flag,
                  receipt_missing_flag,
                  justification,
                  expense_group,
                  start_expense_date,
                  end_expense_date,
                  receipt_currency_code,
                  receipt_conversion_rate,
                  receipt_currency_amount,
                  daily_amount,
                  web_parameter_id,
                  adjustment_reason,
                  award_id,
                  mrc_accrual_posted_flag,
                  mrc_cash_posted_flag,
                  mrc_dist_code_combination_id,
                  mrc_amount,
                  mrc_base_amount,
                  mrc_base_inv_price_variance,
                  mrc_exchange_rate_variance,
                  mrc_posted_flag,
                  mrc_program_application_id,
                  mrc_program_id,
                  mrc_program_update_date,
                  mrc_rate_var_ccid,
                  mrc_request_id,
                  mrc_exchange_date,
                  mrc_exchange_rate,
                  mrc_exchange_rate_type,
                  mrc_amount_to_post,
                  mrc_base_amount_to_post,
                  mrc_cash_je_batch_id,
                  mrc_je_batch_id,
                  mrc_posted_amount,
                  mrc_posted_base_amount,
                  mrc_receipt_conversion_rate,
                  credit_card_trx_id,
                  dist_match_type,
                  rcv_transaction_id,
                  invoice_distribution_id,
                  parent_reversal_id,
                  tax_recoverable_flag,
                  pa_cc_ar_invoice_id,
                  pa_cc_ar_invoice_line_num,
                  pa_cc_processed_code,
                  merchant_document_number,
                  merchant_name,
                  merchant_reference,
                  merchant_tax_reg_number,
                  merchant_taxpayer_id,
                  country_of_supply,
                  matched_uom_lookup_code,
                  gms_burdenable_raw_cost,
                  accounting_event_id,
                  prepay_distribution_id,
                  upgrade_posted_amt,
                  upgrade_base_posted_amt,
                  inventory_transfer_status,
                  company_prepaid_invoice_id,
                  cc_reversal_flag,
                  awt_withheld_amt,
                  invoice_includes_prepay_flag,
                  price_correct_inv_id,
                  price_correct_qty,
                  pa_cmt_xface_flag,
                  cancellation_flag,
                  invoice_line_number,
                  corrected_invoice_dist_id,
                  rounding_amt,
                  charge_applicable_to_dist_id,
                  corrected_quantity,
                  related_id,
                  asset_book_type_code,
                  asset_category_id,
                  distribution_class,
                  final_payment_rounding,
                  final_application_rounding,
                  amount_at_prepay_xrate,
                  cash_basis_final_app_rounding,
                  amount_at_prepay_pay_xrate,
                  intended_use,
                  detail_tax_dist_id,
                  rec_nrec_rate,
                  recovery_rate_id,
                  recovery_rate_name,
                  recovery_type_code,
                  recovery_rate_code,
                  withholding_tax_code_id,
                  tax_already_distributed_flag,
                  summary_tax_line_id,
                  taxable_amount,
                  taxable_base_amount,
                  extra_po_erv,
                  prepay_tax_diff_amount,
                  tax_code_id,
                  vat_code,
                  amount_includes_tax_flag,
                  tax_calculated_flag,
                  tax_recovery_rate,
                  tax_recovery_override_flag,
                  tax_code_override_flag,
                  total_dist_amount,
                  total_dist_base_amount,
                  prepay_tax_parent_id,
                  cancelled_flag,
                  old_distribution_id,
                  old_dist_line_number,
                  amount_variance,
                  base_amount_variance,
                  historical_flag,
                  rcv_charge_addition_flag,
                  awt_related_id,
                  related_retainage_dist_id,
                  retained_amount_remaining,
                  bc_event_id,
                  retained_invoice_dist_id,
                  final_release_rounding,
                  fully_paid_acctd_flag,
                  root_distribution_id,
                  xinv_parent_reversal_id,
                  recurring_payment_id,
                  release_inv_dist_derived_from,
                  pay_awt_group_id
             from SRC_LAYER.EBS_AP_INVOICE_DISTRIBUTIONS_ALL
           minus
           select report_id,
                  accounting_date,
                  accrual_posted_flag,
                  assets_addition_flag,
                  assets_tracking_flag,
                  cash_posted_flag,
                  distribution_line_number,
                  dist_code_combination_id,
                  invoice_id,
                  last_updated_by,
                  last_update_date,
                  line_type_lookup_code,
                  period_name,
                  set_of_books_id,
                  accts_pay_code_combination_id,
                  amount,
                  base_amount,
                  base_invoice_price_variance,
                  batch_id,
                  created_by,
                  creation_date,
                  description,
                  exchange_rate_variance,
                  final_match_flag,
                  income_tax_region,
                  invoice_price_variance,
                  last_update_login,
                  match_status_flag,
                  posted_flag,
                  po_distribution_id,
                  program_application_id,
                  program_id,
                  program_update_date,
                  quantity_invoiced,
                  rate_var_code_combination_id,
                  request_id,
                  reversal_flag,
                  type_1099,
                  unit_price,
                  amount_encumbered,
                  base_amount_encumbered,
                  encumbered_flag,
                  exchange_date,
                  exchange_rate,
                  exchange_rate_type,
                  price_adjustment_flag,
                  price_var_code_combination_id,
                  quantity_unencumbered,
                  stat_amount,
                  amount_to_post,
                  attribute1,
                  attribute10,
                  attribute11,
                  attribute12,
                  attribute13,
                  attribute14,
                  attribute15,
                  attribute2,
                  attribute3,
                  attribute4,
                  attribute5,
                  attribute6,
                  attribute7,
                  attribute8,
                  attribute9,
                  attribute_category,
                  base_amount_to_post,
                  cash_je_batch_id,
                  expenditure_item_date,
                  expenditure_organization_id,
                  expenditure_type,
                  je_batch_id,
                  parent_invoice_id,
                  pa_addition_flag,
                  pa_quantity,
                  posted_amount,
                  posted_base_amount,
                  prepay_amount_remaining,
                  project_accounting_context,
                  project_id,
                  task_id,
                  ussgl_transaction_code,
                  ussgl_trx_code_context,
                  earliest_settlement_date,
                  req_distribution_id,
                  quantity_variance,
                  base_quantity_variance,
                  packet_id,
                  awt_flag,
                  awt_group_id,
                  awt_tax_rate_id,
                  awt_gross_amount,
                  awt_invoice_id,
                  awt_origin_group_id,
                  reference_1,
                  reference_2,
                  org_id,
                  other_invoice_id,
                  awt_invoice_payment_id,
                  global_attribute_category,
                  global_attribute1,
                  global_attribute2,
                  global_attribute3,
                  global_attribute4,
                  global_attribute5,
                  global_attribute6,
                  global_attribute7,
                  global_attribute8,
                  global_attribute9,
                  global_attribute10,
                  global_attribute11,
                  global_attribute12,
                  global_attribute13,
                  global_attribute14,
                  global_attribute15,
                  global_attribute16,
                  global_attribute17,
                  global_attribute18,
                  global_attribute19,
                  global_attribute20,
                  line_group_number,
                  receipt_verified_flag,
                  receipt_required_flag,
                  receipt_missing_flag,
                  justification,
                  expense_group,
                  start_expense_date,
                  end_expense_date,
                  receipt_currency_code,
                  receipt_conversion_rate,
                  receipt_currency_amount,
                  daily_amount,
                  web_parameter_id,
                  adjustment_reason,
                  award_id,
                  mrc_accrual_posted_flag,
                  mrc_cash_posted_flag,
                  mrc_dist_code_combination_id,
                  mrc_amount,
                  mrc_base_amount,
                  mrc_base_inv_price_variance,
                  mrc_exchange_rate_variance,
                  mrc_posted_flag,
                  mrc_program_application_id,
                  mrc_program_id,
                  mrc_program_update_date,
                  mrc_rate_var_ccid,
                  mrc_request_id,
                  mrc_exchange_date,
                  mrc_exchange_rate,
                  mrc_exchange_rate_type,
                  mrc_amount_to_post,
                  mrc_base_amount_to_post,
                  mrc_cash_je_batch_id,
                  mrc_je_batch_id,
                  mrc_posted_amount,
                  mrc_posted_base_amount,
                  mrc_receipt_conversion_rate,
                  credit_card_trx_id,
                  dist_match_type,
                  rcv_transaction_id,
                  invoice_distribution_id,
                  parent_reversal_id,
                  tax_recoverable_flag,
                  pa_cc_ar_invoice_id,
                  pa_cc_ar_invoice_line_num,
                  pa_cc_processed_code,
                  merchant_document_number,
                  merchant_name,
                  merchant_reference,
                  merchant_tax_reg_number,
                  merchant_taxpayer_id,
                  country_of_supply,
                  matched_uom_lookup_code,
                  gms_burdenable_raw_cost,
                  accounting_event_id,
                  prepay_distribution_id,
                  upgrade_posted_amt,
                  upgrade_base_posted_amt,
                  inventory_transfer_status,
                  company_prepaid_invoice_id,
                  cc_reversal_flag,
                  awt_withheld_amt,
                  invoice_includes_prepay_flag,
                  price_correct_inv_id,
                  price_correct_qty,
                  pa_cmt_xface_flag,
                  cancellation_flag,
                  invoice_line_number,
                  corrected_invoice_dist_id,
                  rounding_amt,
                  charge_applicable_to_dist_id,
                  corrected_quantity,
                  related_id,
                  asset_book_type_code,
                  asset_category_id,
                  distribution_class,
                  final_payment_rounding,
                  final_application_rounding,
                  amount_at_prepay_xrate,
                  cash_basis_final_app_rounding,
                  amount_at_prepay_pay_xrate,
                  intended_use,
                  detail_tax_dist_id,
                  rec_nrec_rate,
                  recovery_rate_id,
                  recovery_rate_name,
                  recovery_type_code,
                  recovery_rate_code,
                  withholding_tax_code_id,
                  tax_already_distributed_flag,
                  summary_tax_line_id,
                  taxable_amount,
                  taxable_base_amount,
                  extra_po_erv,
                  prepay_tax_diff_amount,
                  tax_code_id,
                  vat_code,
                  amount_includes_tax_flag,
                  tax_calculated_flag,
                  tax_recovery_rate,
                  tax_recovery_override_flag,
                  tax_code_override_flag,
                  total_dist_amount,
                  total_dist_base_amount,
                  prepay_tax_parent_id,
                  cancelled_flag,
                  old_distribution_id,
                  old_dist_line_number,
                  amount_variance,
                  base_amount_variance,
                  historical_flag,
                  rcv_charge_addition_flag,
                  awt_related_id,
                  related_retainage_dist_id,
                  retained_amount_remaining,
                  bc_event_id,
                  retained_invoice_dist_id,
                  final_release_rounding,
                  fully_paid_acctd_flag,
                  root_distribution_id,
                  xinv_parent_reversal_id,
                  recurring_payment_id,
                  release_inv_dist_derived_from,
                  pay_awt_group_id
             from STD_LAYER.T05_AP_INVOICE_DISTRIBUTIONS_ALL) DIF
    on (HIS.invoice_id = DIF.invoice_id and HIS.INVOICE_LINE_NUMBER = DIF.INVOICE_LINE_NUMBER and HIS.distribution_line_number = DIF.distribution_line_number)
    when matched then
      update set HIS.end_date = query_date;
  
    -- insert the nonredundant(new) records 
  
    insert into STD_LAYER.T05_AP_INVOICE_DISTRIBUTIONS_ALL
      with intersect_query as
       (select report_id,
               accounting_date,
               accrual_posted_flag,
               assets_addition_flag,
               assets_tracking_flag,
               cash_posted_flag,
               distribution_line_number,
               dist_code_combination_id,
               invoice_id,
               last_updated_by,
               last_update_date,
               line_type_lookup_code,
               period_name,
               set_of_books_id,
               accts_pay_code_combination_id,
               amount,
               base_amount,
               base_invoice_price_variance,
               batch_id,
               created_by,
               creation_date,
               description,
               exchange_rate_variance,
               final_match_flag,
               income_tax_region,
               invoice_price_variance,
               last_update_login,
               match_status_flag,
               posted_flag,
               po_distribution_id,
               program_application_id,
               program_id,
               program_update_date,
               quantity_invoiced,
               rate_var_code_combination_id,
               request_id,
               reversal_flag,
               type_1099,
               unit_price,
               amount_encumbered,
               base_amount_encumbered,
               encumbered_flag,
               exchange_date,
               exchange_rate,
               exchange_rate_type,
               price_adjustment_flag,
               price_var_code_combination_id,
               quantity_unencumbered,
               stat_amount,
               amount_to_post,
               attribute1,
               attribute10,
               attribute11,
               attribute12,
               attribute13,
               attribute14,
               attribute15,
               attribute2,
               attribute3,
               attribute4,
               attribute5,
               attribute6,
               attribute7,
               attribute8,
               attribute9,
               attribute_category,
               base_amount_to_post,
               cash_je_batch_id,
               expenditure_item_date,
               expenditure_organization_id,
               expenditure_type,
               je_batch_id,
               parent_invoice_id,
               pa_addition_flag,
               pa_quantity,
               posted_amount,
               posted_base_amount,
               prepay_amount_remaining,
               project_accounting_context,
               project_id,
               task_id,
               ussgl_transaction_code,
               ussgl_trx_code_context,
               earliest_settlement_date,
               req_distribution_id,
               quantity_variance,
               base_quantity_variance,
               packet_id,
               awt_flag,
               awt_group_id,
               awt_tax_rate_id,
               awt_gross_amount,
               awt_invoice_id,
               awt_origin_group_id,
               reference_1,
               reference_2,
               org_id,
               other_invoice_id,
               awt_invoice_payment_id,
               global_attribute_category,
               global_attribute1,
               global_attribute2,
               global_attribute3,
               global_attribute4,
               global_attribute5,
               global_attribute6,
               global_attribute7,
               global_attribute8,
               global_attribute9,
               global_attribute10,
               global_attribute11,
               global_attribute12,
               global_attribute13,
               global_attribute14,
               global_attribute15,
               global_attribute16,
               global_attribute17,
               global_attribute18,
               global_attribute19,
               global_attribute20,
               line_group_number,
               receipt_verified_flag,
               receipt_required_flag,
               receipt_missing_flag,
               justification,
               expense_group,
               start_expense_date,
               end_expense_date,
               receipt_currency_code,
               receipt_conversion_rate,
               receipt_currency_amount,
               daily_amount,
               web_parameter_id,
               adjustment_reason,
               award_id,
               mrc_accrual_posted_flag,
               mrc_cash_posted_flag,
               mrc_dist_code_combination_id,
               mrc_amount,
               mrc_base_amount,
               mrc_base_inv_price_variance,
               mrc_exchange_rate_variance,
               mrc_posted_flag,
               mrc_program_application_id,
               mrc_program_id,
               mrc_program_update_date,
               mrc_rate_var_ccid,
               mrc_request_id,
               mrc_exchange_date,
               mrc_exchange_rate,
               mrc_exchange_rate_type,
               mrc_amount_to_post,
               mrc_base_amount_to_post,
               mrc_cash_je_batch_id,
               mrc_je_batch_id,
               mrc_posted_amount,
               mrc_posted_base_amount,
               mrc_receipt_conversion_rate,
               credit_card_trx_id,
               dist_match_type,
               rcv_transaction_id,
               invoice_distribution_id,
               parent_reversal_id,
               tax_recoverable_flag,
               pa_cc_ar_invoice_id,
               pa_cc_ar_invoice_line_num,
               pa_cc_processed_code,
               merchant_document_number,
               merchant_name,
               merchant_reference,
               merchant_tax_reg_number,
               merchant_taxpayer_id,
               country_of_supply,
               matched_uom_lookup_code,
               gms_burdenable_raw_cost,
               accounting_event_id,
               prepay_distribution_id,
               upgrade_posted_amt,
               upgrade_base_posted_amt,
               inventory_transfer_status,
               company_prepaid_invoice_id,
               cc_reversal_flag,
               awt_withheld_amt,
               invoice_includes_prepay_flag,
               price_correct_inv_id,
               price_correct_qty,
               pa_cmt_xface_flag,
               cancellation_flag,
               invoice_line_number,
               corrected_invoice_dist_id,
               rounding_amt,
               charge_applicable_to_dist_id,
               corrected_quantity,
               related_id,
               asset_book_type_code,
               asset_category_id,
               distribution_class,
               final_payment_rounding,
               final_application_rounding,
               amount_at_prepay_xrate,
               cash_basis_final_app_rounding,
               amount_at_prepay_pay_xrate,
               intended_use,
               detail_tax_dist_id,
               rec_nrec_rate,
               recovery_rate_id,
               recovery_rate_name,
               recovery_type_code,
               recovery_rate_code,
               withholding_tax_code_id,
               tax_already_distributed_flag,
               summary_tax_line_id,
               taxable_amount,
               taxable_base_amount,
               extra_po_erv,
               prepay_tax_diff_amount,
               tax_code_id,
               vat_code,
               amount_includes_tax_flag,
               tax_calculated_flag,
               tax_recovery_rate,
               tax_recovery_override_flag,
               tax_code_override_flag,
               total_dist_amount,
               total_dist_base_amount,
               prepay_tax_parent_id,
               cancelled_flag,
               old_distribution_id,
               old_dist_line_number,
               amount_variance,
               base_amount_variance,
               historical_flag,
               rcv_charge_addition_flag,
               awt_related_id,
               related_retainage_dist_id,
               retained_amount_remaining,
               bc_event_id,
               retained_invoice_dist_id,
               final_release_rounding,
               fully_paid_acctd_flag,
               root_distribution_id,
               xinv_parent_reversal_id,
               recurring_payment_id,
               release_inv_dist_derived_from,
               pay_awt_group_id
          from src_layer.ebs_AP_INVOICE_DISTRIBUTIONS_ALL
        intersect
        select report_id,
               accounting_date,
               accrual_posted_flag,
               assets_addition_flag,
               assets_tracking_flag,
               cash_posted_flag,
               distribution_line_number,
               dist_code_combination_id,
               invoice_id,
               last_updated_by,
               last_update_date,
               line_type_lookup_code,
               period_name,
               set_of_books_id,
               accts_pay_code_combination_id,
               amount,
               base_amount,
               base_invoice_price_variance,
               batch_id,
               created_by,
               creation_date,
               description,
               exchange_rate_variance,
               final_match_flag,
               income_tax_region,
               invoice_price_variance,
               last_update_login,
               match_status_flag,
               posted_flag,
               po_distribution_id,
               program_application_id,
               program_id,
               program_update_date,
               quantity_invoiced,
               rate_var_code_combination_id,
               request_id,
               reversal_flag,
               type_1099,
               unit_price,
               amount_encumbered,
               base_amount_encumbered,
               encumbered_flag,
               exchange_date,
               exchange_rate,
               exchange_rate_type,
               price_adjustment_flag,
               price_var_code_combination_id,
               quantity_unencumbered,
               stat_amount,
               amount_to_post,
               attribute1,
               attribute10,
               attribute11,
               attribute12,
               attribute13,
               attribute14,
               attribute15,
               attribute2,
               attribute3,
               attribute4,
               attribute5,
               attribute6,
               attribute7,
               attribute8,
               attribute9,
               attribute_category,
               base_amount_to_post,
               cash_je_batch_id,
               expenditure_item_date,
               expenditure_organization_id,
               expenditure_type,
               je_batch_id,
               parent_invoice_id,
               pa_addition_flag,
               pa_quantity,
               posted_amount,
               posted_base_amount,
               prepay_amount_remaining,
               project_accounting_context,
               project_id,
               task_id,
               ussgl_transaction_code,
               ussgl_trx_code_context,
               earliest_settlement_date,
               req_distribution_id,
               quantity_variance,
               base_quantity_variance,
               packet_id,
               awt_flag,
               awt_group_id,
               awt_tax_rate_id,
               awt_gross_amount,
               awt_invoice_id,
               awt_origin_group_id,
               reference_1,
               reference_2,
               org_id,
               other_invoice_id,
               awt_invoice_payment_id,
               global_attribute_category,
               global_attribute1,
               global_attribute2,
               global_attribute3,
               global_attribute4,
               global_attribute5,
               global_attribute6,
               global_attribute7,
               global_attribute8,
               global_attribute9,
               global_attribute10,
               global_attribute11,
               global_attribute12,
               global_attribute13,
               global_attribute14,
               global_attribute15,
               global_attribute16,
               global_attribute17,
               global_attribute18,
               global_attribute19,
               global_attribute20,
               line_group_number,
               receipt_verified_flag,
               receipt_required_flag,
               receipt_missing_flag,
               justification,
               expense_group,
               start_expense_date,
               end_expense_date,
               receipt_currency_code,
               receipt_conversion_rate,
               receipt_currency_amount,
               daily_amount,
               web_parameter_id,
               adjustment_reason,
               award_id,
               mrc_accrual_posted_flag,
               mrc_cash_posted_flag,
               mrc_dist_code_combination_id,
               mrc_amount,
               mrc_base_amount,
               mrc_base_inv_price_variance,
               mrc_exchange_rate_variance,
               mrc_posted_flag,
               mrc_program_application_id,
               mrc_program_id,
               mrc_program_update_date,
               mrc_rate_var_ccid,
               mrc_request_id,
               mrc_exchange_date,
               mrc_exchange_rate,
               mrc_exchange_rate_type,
               mrc_amount_to_post,
               mrc_base_amount_to_post,
               mrc_cash_je_batch_id,
               mrc_je_batch_id,
               mrc_posted_amount,
               mrc_posted_base_amount,
               mrc_receipt_conversion_rate,
               credit_card_trx_id,
               dist_match_type,
               rcv_transaction_id,
               invoice_distribution_id,
               parent_reversal_id,
               tax_recoverable_flag,
               pa_cc_ar_invoice_id,
               pa_cc_ar_invoice_line_num,
               pa_cc_processed_code,
               merchant_document_number,
               merchant_name,
               merchant_reference,
               merchant_tax_reg_number,
               merchant_taxpayer_id,
               country_of_supply,
               matched_uom_lookup_code,
               gms_burdenable_raw_cost,
               accounting_event_id,
               prepay_distribution_id,
               upgrade_posted_amt,
               upgrade_base_posted_amt,
               inventory_transfer_status,
               company_prepaid_invoice_id,
               cc_reversal_flag,
               awt_withheld_amt,
               invoice_includes_prepay_flag,
               price_correct_inv_id,
               price_correct_qty,
               pa_cmt_xface_flag,
               cancellation_flag,
               invoice_line_number,
               corrected_invoice_dist_id,
               rounding_amt,
               charge_applicable_to_dist_id,
               corrected_quantity,
               related_id,
               asset_book_type_code,
               asset_category_id,
               distribution_class,
               final_payment_rounding,
               final_application_rounding,
               amount_at_prepay_xrate,
               cash_basis_final_app_rounding,
               amount_at_prepay_pay_xrate,
               intended_use,
               detail_tax_dist_id,
               rec_nrec_rate,
               recovery_rate_id,
               recovery_rate_name,
               recovery_type_code,
               recovery_rate_code,
               withholding_tax_code_id,
               tax_already_distributed_flag,
               summary_tax_line_id,
               taxable_amount,
               taxable_base_amount,
               extra_po_erv,
               prepay_tax_diff_amount,
               tax_code_id,
               vat_code,
               amount_includes_tax_flag,
               tax_calculated_flag,
               tax_recovery_rate,
               tax_recovery_override_flag,
               tax_code_override_flag,
               total_dist_amount,
               total_dist_base_amount,
               prepay_tax_parent_id,
               cancelled_flag,
               old_distribution_id,
               old_dist_line_number,
               amount_variance,
               base_amount_variance,
               historical_flag,
               rcv_charge_addition_flag,
               awt_related_id,
               related_retainage_dist_id,
               retained_amount_remaining,
               bc_event_id,
               retained_invoice_dist_id,
               final_release_rounding,
               fully_paid_acctd_flag,
               root_distribution_id,
               xinv_parent_reversal_id,
               recurring_payment_id,
               release_inv_dist_derived_from,
               pay_awt_group_id
          from STD_LAYER.T05_AP_INVOICE_DISTRIBUTIONS_ALL)
      select report_id,
             accounting_date,
             accrual_posted_flag,
             assets_addition_flag,
             assets_tracking_flag,
             cash_posted_flag,
             distribution_line_number,
             dist_code_combination_id,
             invoice_id,
             last_updated_by,
             last_update_date,
             line_type_lookup_code,
             period_name,
             set_of_books_id,
             accts_pay_code_combination_id,
             amount,
             base_amount,
             base_invoice_price_variance,
             batch_id,
             created_by,
             creation_date,
             description,
             exchange_rate_variance,
             final_match_flag,
             income_tax_region,
             invoice_price_variance,
             last_update_login,
             match_status_flag,
             posted_flag,
             po_distribution_id,
             program_application_id,
             program_id,
             program_update_date,
             quantity_invoiced,
             rate_var_code_combination_id,
             request_id,
             reversal_flag,
             type_1099,
             unit_price,
             amount_encumbered,
             base_amount_encumbered,
             encumbered_flag,
             exchange_date,
             exchange_rate,
             exchange_rate_type,
             price_adjustment_flag,
             price_var_code_combination_id,
             quantity_unencumbered,
             stat_amount,
             amount_to_post,
             attribute1,
             attribute10,
             attribute11,
             attribute12,
             attribute13,
             attribute14,
             attribute15,
             attribute2,
             attribute3,
             attribute4,
             attribute5,
             attribute6,
             attribute7,
             attribute8,
             attribute9,
             attribute_category,
             base_amount_to_post,
             cash_je_batch_id,
             expenditure_item_date,
             expenditure_organization_id,
             expenditure_type,
             je_batch_id,
             parent_invoice_id,
             pa_addition_flag,
             pa_quantity,
             posted_amount,
             posted_base_amount,
             prepay_amount_remaining,
             project_accounting_context,
             project_id,
             task_id,
             ussgl_transaction_code,
             ussgl_trx_code_context,
             earliest_settlement_date,
             req_distribution_id,
             quantity_variance,
             base_quantity_variance,
             packet_id,
             awt_flag,
             awt_group_id,
             awt_tax_rate_id,
             awt_gross_amount,
             awt_invoice_id,
             awt_origin_group_id,
             reference_1,
             reference_2,
             org_id,
             other_invoice_id,
             awt_invoice_payment_id,
             global_attribute_category,
             global_attribute1,
             global_attribute2,
             global_attribute3,
             global_attribute4,
             global_attribute5,
             global_attribute6,
             global_attribute7,
             global_attribute8,
             global_attribute9,
             global_attribute10,
             global_attribute11,
             global_attribute12,
             global_attribute13,
             global_attribute14,
             global_attribute15,
             global_attribute16,
             global_attribute17,
             global_attribute18,
             global_attribute19,
             global_attribute20,
             line_group_number,
             receipt_verified_flag,
             receipt_required_flag,
             receipt_missing_flag,
             justification,
             expense_group,
             start_expense_date,
             end_expense_date,
             receipt_currency_code,
             receipt_conversion_rate,
             receipt_currency_amount,
             daily_amount,
             web_parameter_id,
             adjustment_reason,
             award_id,
             mrc_accrual_posted_flag,
             mrc_cash_posted_flag,
             mrc_dist_code_combination_id,
             mrc_amount,
             mrc_base_amount,
             mrc_base_inv_price_variance,
             mrc_exchange_rate_variance,
             mrc_posted_flag,
             mrc_program_application_id,
             mrc_program_id,
             mrc_program_update_date,
             mrc_rate_var_ccid,
             mrc_request_id,
             mrc_exchange_date,
             mrc_exchange_rate,
             mrc_exchange_rate_type,
             mrc_amount_to_post,
             mrc_base_amount_to_post,
             mrc_cash_je_batch_id,
             mrc_je_batch_id,
             mrc_posted_amount,
             mrc_posted_base_amount,
             mrc_receipt_conversion_rate,
             credit_card_trx_id,
             dist_match_type,
             rcv_transaction_id,
             invoice_distribution_id,
             parent_reversal_id,
             tax_recoverable_flag,
             pa_cc_ar_invoice_id,
             pa_cc_ar_invoice_line_num,
             pa_cc_processed_code,
             merchant_document_number,
             merchant_name,
             merchant_reference,
             merchant_tax_reg_number,
             merchant_taxpayer_id,
             country_of_supply,
             matched_uom_lookup_code,
             gms_burdenable_raw_cost,
             accounting_event_id,
             prepay_distribution_id,
             upgrade_posted_amt,
             upgrade_base_posted_amt,
             inventory_transfer_status,
             company_prepaid_invoice_id,
             cc_reversal_flag,
             awt_withheld_amt,
             invoice_includes_prepay_flag,
             price_correct_inv_id,
             price_correct_qty,
             pa_cmt_xface_flag,
             cancellation_flag,
             invoice_line_number,
             corrected_invoice_dist_id,
             rounding_amt,
             charge_applicable_to_dist_id,
             corrected_quantity,
             related_id,
             asset_book_type_code,
             asset_category_id,
             distribution_class,
             final_payment_rounding,
             final_application_rounding,
             amount_at_prepay_xrate,
             cash_basis_final_app_rounding,
             amount_at_prepay_pay_xrate,
             intended_use,
             detail_tax_dist_id,
             rec_nrec_rate,
             recovery_rate_id,
             recovery_rate_name,
             recovery_type_code,
             recovery_rate_code,
             withholding_tax_code_id,
             tax_already_distributed_flag,
             summary_tax_line_id,
             taxable_amount,
             taxable_base_amount,
             extra_po_erv,
             prepay_tax_diff_amount,
             tax_code_id,
             vat_code,
             amount_includes_tax_flag,
             tax_calculated_flag,
             tax_recovery_rate,
             tax_recovery_override_flag,
             tax_code_override_flag,
             total_dist_amount,
             total_dist_base_amount,
             prepay_tax_parent_id,
             cancelled_flag,
             old_distribution_id,
             old_dist_line_number,
             amount_variance,
             base_amount_variance,
             historical_flag,
             rcv_charge_addition_flag,
             awt_related_id,
             related_retainage_dist_id,
             retained_amount_remaining,
             bc_event_id,
             retained_invoice_dist_id,
             final_release_rounding,
             fully_paid_acctd_flag,
             root_distribution_id,
             xinv_parent_reversal_id,
             recurring_payment_id,
             release_inv_dist_derived_from,
             pay_awt_group_id,
             sysdate,
             data_date,
             to_date('9999-12-31', 'yyyy/mm/dd'),
             -1,
             ds_line_sequence.nextval
        from SRC_LAYER.EBS_AP_INVOICE_DISTRIBUTIONS_ALL
       where invoice_id not in (select invoice_id from intersect_query)
         and invoice_line_number not in
             (select invoice_line_number from intersect_query)
         and distribution_line_number not in
             (select distribution_line_number from intersect_query);
    commit;
    -- set header_id linked with header table
    merge into STD_LAYER.T05_AP_INVOICE_DISTRIBUTIONS_ALL a
    using (select * from STD_LAYER.DATA_HEADER) b
    on (a.start_date = b.data_date and b.report_flag = 'AP_INVOICE_DISTRIBUTIONS_ALL')
    when matched then
      update set header_id = b.header_id;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.EBS_AP_INVOICE_DISTRIBUTIONS_ALL',
               'STD_LAYER.T05_AP_INVOICE_DISTRIBUTIONS_ALL',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.EBS_AP_INVOICE_DISTRIBUTIONS_ALL',
                 'STD_LAYER.T05_AP_INVOICE_DISTRIBUTIONS_ALL',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
    
  end update_ap_invoice_distributions_all;

  procedure update_ap_invoices_all is
    query_date date;
  begin
    -- save query_date from etl_control 
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.T05_AP_INVOICES_ALL
     where start_date = query_date;
    update STD_LAYER.T05_AP_INVOICES_ALL
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
    -- update end_date for the AP_INVOICES_ALL
    merge into STD_LAYER.T05_AP_INVOICES_ALL HIS
    using (select report_id,
                  invoice_id,
                  last_update_date,
                  last_updated_by,
                  vendor_id,
                  invoice_num,
                  set_of_books_id,
                  invoice_currency_code,
                  payment_currency_code,
                  payment_cross_rate,
                  invoice_amount,
                  vendor_site_id,
                  amount_paid,
                  discount_amount_taken,
                  invoice_date,
                  source,
                  invoice_type_lookup_code,
                  description,
                  batch_id,
                  amount_applicable_to_discount,
                  tax_amount,
                  terms_id,
                  terms_date,
                  payment_method_lookup_code,
                  pay_group_lookup_code,
                  accts_pay_code_combination_id,
                  payment_status_flag,
                  creation_date,
                  created_by,
                  base_amount,
                  vat_code,
                  last_update_login,
                  exclusive_payment_flag,
                  po_header_id,
                  freight_amount,
                  goods_received_date,
                  invoice_received_date,
                  voucher_num,
                  approved_amount,
                  recurring_payment_id,
                  exchange_rate,
                  exchange_rate_type,
                  exchange_date,
                  earliest_settlement_date,
                  original_prepayment_amount,
                  doc_sequence_id,
                  doc_sequence_value,
                  doc_category_code,
                  attribute1,
                  attribute2,
                  attribute3,
                  attribute4,
                  attribute5,
                  attribute6,
                  attribute7,
                  attribute8,
                  attribute9,
                  attribute10,
                  attribute11,
                  attribute12,
                  attribute13,
                  attribute14,
                  attribute15,
                  attribute_category,
                  approval_status,
                  approval_description,
                  invoice_distribution_total,
                  posting_status,
                  prepay_flag,
                  authorized_by,
                  cancelled_date,
                  cancelled_by,
                  cancelled_amount,
                  temp_cancelled_amount,
                  project_accounting_context,
                  ussgl_transaction_code,
                  ussgl_trx_code_context,
                  project_id,
                  task_id,
                  expenditure_type,
                  expenditure_item_date,
                  pa_quantity,
                  expenditure_organization_id,
                  pa_default_dist_ccid,
                  vendor_prepay_amount,
                  payment_amount_total,
                  awt_flag,
                  awt_group_id,
                  reference_1,
                  reference_2,
                  org_id,
                  pre_withholding_amount,
                  global_attribute_category,
                  global_attribute1,
                  global_attribute2,
                  global_attribute3,
                  global_attribute4,
                  global_attribute5,
                  global_attribute6,
                  global_attribute7,
                  global_attribute8,
                  global_attribute9,
                  global_attribute10,
                  global_attribute11,
                  global_attribute12,
                  global_attribute13,
                  global_attribute14,
                  global_attribute15,
                  global_attribute16,
                  global_attribute17,
                  global_attribute18,
                  global_attribute19,
                  global_attribute20,
                  auto_tax_calc_flag,
                  payment_cross_rate_type,
                  payment_cross_rate_date,
                  pay_curr_invoice_amount,
                  mrc_base_amount,
                  mrc_exchange_rate,
                  mrc_exchange_rate_type,
                  mrc_exchange_date,
                  gl_date,
                  award_id,
                  paid_on_behalf_employee_id,
                  amt_due_ccard_company,
                  amt_due_employee,
                  approval_ready_flag,
                  approval_iteration,
                  wfapproval_status,
                  requester_id,
                  validation_request_id,
                  validated_tax_amount,
                  quick_credit,
                  credited_invoice_id,
                  distribution_set_id,
                  application_id,
                  product_table,
                  reference_key1,
                  reference_key2,
                  reference_key3,
                  reference_key4,
                  reference_key5,
                  total_tax_amount,
                  self_assessed_tax_amount,
                  tax_related_invoice_id,
                  trx_business_category,
                  user_defined_fisc_class,
                  taxation_country,
                  document_sub_type,
                  supplier_tax_invoice_number,
                  supplier_tax_invoice_date,
                  supplier_tax_exchange_rate,
                  tax_invoice_recording_date,
                  tax_invoice_internal_seq,
                  legal_entity_id,
                  historical_flag,
                  force_revalidation_flag,
                  bank_charge_bearer,
                  remittance_message1,
                  remittance_message2,
                  remittance_message3,
                  unique_remittance_identifier,
                  uri_check_digit,
                  settlement_priority,
                  payment_reason_code,
                  payment_reason_comments,
                  payment_method_code,
                  delivery_channel_code,
                  quick_po_header_id,
                  net_of_retainage_flag,
                  release_amount_net_of_tax,
                  control_amount,
                  party_id,
                  party_site_id,
                  pay_proc_trxn_type_code,
                  payment_function,
                  cust_registration_code,
                  cust_registration_number,
                  port_of_entry_code,
                  external_bank_account_id,
                  vendor_contact_id,
                  internal_contact_email,
                  disc_is_inv_less_tax_flag,
                  exclude_freight_from_discount,
                  pay_awt_group_id,
                  original_invoice_amount,
                  dispute_reason,
                  remit_to_supplier_name,
                  remit_to_supplier_id,
                  remit_to_supplier_site,
                  remit_to_supplier_site_id,
                  relationship_id,
                  po_matched_flag,
                  validation_worker_id
             from SRC_LAYER.EBS_AP_INVOICES_ALL
           minus
           select report_id,
                  invoice_id,
                  last_update_date,
                  last_updated_by,
                  vendor_id,
                  invoice_num,
                  set_of_books_id,
                  invoice_currency_code,
                  payment_currency_code,
                  payment_cross_rate,
                  invoice_amount,
                  vendor_site_id,
                  amount_paid,
                  discount_amount_taken,
                  invoice_date,
                  source,
                  invoice_type_lookup_code,
                  description,
                  batch_id,
                  amount_applicable_to_discount,
                  tax_amount,
                  terms_id,
                  terms_date,
                  payment_method_lookup_code,
                  pay_group_lookup_code,
                  accts_pay_code_combination_id,
                  payment_status_flag,
                  creation_date,
                  created_by,
                  base_amount,
                  vat_code,
                  last_update_login,
                  exclusive_payment_flag,
                  po_header_id,
                  freight_amount,
                  goods_received_date,
                  invoice_received_date,
                  voucher_num,
                  approved_amount,
                  recurring_payment_id,
                  exchange_rate,
                  exchange_rate_type,
                  exchange_date,
                  earliest_settlement_date,
                  original_prepayment_amount,
                  doc_sequence_id,
                  doc_sequence_value,
                  doc_category_code,
                  attribute1,
                  attribute2,
                  attribute3,
                  attribute4,
                  attribute5,
                  attribute6,
                  attribute7,
                  attribute8,
                  attribute9,
                  attribute10,
                  attribute11,
                  attribute12,
                  attribute13,
                  attribute14,
                  attribute15,
                  attribute_category,
                  approval_status,
                  approval_description,
                  invoice_distribution_total,
                  posting_status,
                  prepay_flag,
                  authorized_by,
                  cancelled_date,
                  cancelled_by,
                  cancelled_amount,
                  temp_cancelled_amount,
                  project_accounting_context,
                  ussgl_transaction_code,
                  ussgl_trx_code_context,
                  project_id,
                  task_id,
                  expenditure_type,
                  expenditure_item_date,
                  pa_quantity,
                  expenditure_organization_id,
                  pa_default_dist_ccid,
                  vendor_prepay_amount,
                  payment_amount_total,
                  awt_flag,
                  awt_group_id,
                  reference_1,
                  reference_2,
                  org_id,
                  pre_withholding_amount,
                  global_attribute_category,
                  global_attribute1,
                  global_attribute2,
                  global_attribute3,
                  global_attribute4,
                  global_attribute5,
                  global_attribute6,
                  global_attribute7,
                  global_attribute8,
                  global_attribute9,
                  global_attribute10,
                  global_attribute11,
                  global_attribute12,
                  global_attribute13,
                  global_attribute14,
                  global_attribute15,
                  global_attribute16,
                  global_attribute17,
                  global_attribute18,
                  global_attribute19,
                  global_attribute20,
                  auto_tax_calc_flag,
                  payment_cross_rate_type,
                  payment_cross_rate_date,
                  pay_curr_invoice_amount,
                  mrc_base_amount,
                  mrc_exchange_rate,
                  mrc_exchange_rate_type,
                  mrc_exchange_date,
                  gl_date,
                  award_id,
                  paid_on_behalf_employee_id,
                  amt_due_ccard_company,
                  amt_due_employee,
                  approval_ready_flag,
                  approval_iteration,
                  wfapproval_status,
                  requester_id,
                  validation_request_id,
                  validated_tax_amount,
                  quick_credit,
                  credited_invoice_id,
                  distribution_set_id,
                  application_id,
                  product_table,
                  reference_key1,
                  reference_key2,
                  reference_key3,
                  reference_key4,
                  reference_key5,
                  total_tax_amount,
                  self_assessed_tax_amount,
                  tax_related_invoice_id,
                  trx_business_category,
                  user_defined_fisc_class,
                  taxation_country,
                  document_sub_type,
                  supplier_tax_invoice_number,
                  supplier_tax_invoice_date,
                  supplier_tax_exchange_rate,
                  tax_invoice_recording_date,
                  tax_invoice_internal_seq,
                  legal_entity_id,
                  historical_flag,
                  force_revalidation_flag,
                  bank_charge_bearer,
                  remittance_message1,
                  remittance_message2,
                  remittance_message3,
                  unique_remittance_identifier,
                  uri_check_digit,
                  settlement_priority,
                  payment_reason_code,
                  payment_reason_comments,
                  payment_method_code,
                  delivery_channel_code,
                  quick_po_header_id,
                  net_of_retainage_flag,
                  release_amount_net_of_tax,
                  control_amount,
                  party_id,
                  party_site_id,
                  pay_proc_trxn_type_code,
                  payment_function,
                  cust_registration_code,
                  cust_registration_number,
                  port_of_entry_code,
                  external_bank_account_id,
                  vendor_contact_id,
                  internal_contact_email,
                  disc_is_inv_less_tax_flag,
                  exclude_freight_from_discount,
                  pay_awt_group_id,
                  original_invoice_amount,
                  dispute_reason,
                  remit_to_supplier_name,
                  remit_to_supplier_id,
                  remit_to_supplier_site,
                  remit_to_supplier_site_id,
                  relationship_id,
                  po_matched_flag,
                  validation_worker_id
             from STD_LAYER.T05_AP_INVOICES_ALL) DIF
    on (HIS.invoice_id = DIF.invoice_id)
    
    when matched then
      update set HIS.end_date = query_date;
  
    -- insert the nonredundant(new) records 
  
    insert into STD_LAYER.T05_AP_INVOICES_ALL
      with intersect_query as
       (select report_id,
               invoice_id,
               last_update_date,
               last_updated_by,
               vendor_id,
               invoice_num,
               set_of_books_id,
               invoice_currency_code,
               payment_currency_code,
               payment_cross_rate,
               invoice_amount,
               vendor_site_id,
               amount_paid,
               discount_amount_taken,
               invoice_date,
               source,
               invoice_type_lookup_code,
               description,
               batch_id,
               amount_applicable_to_discount,
               tax_amount,
               terms_id,
               terms_date,
               payment_method_lookup_code,
               pay_group_lookup_code,
               accts_pay_code_combination_id,
               payment_status_flag,
               creation_date,
               created_by,
               base_amount,
               vat_code,
               last_update_login,
               exclusive_payment_flag,
               po_header_id,
               freight_amount,
               goods_received_date,
               invoice_received_date,
               voucher_num,
               approved_amount,
               recurring_payment_id,
               exchange_rate,
               exchange_rate_type,
               exchange_date,
               earliest_settlement_date,
               original_prepayment_amount,
               doc_sequence_id,
               doc_sequence_value,
               doc_category_code,
               attribute1,
               attribute2,
               attribute3,
               attribute4,
               attribute5,
               attribute6,
               attribute7,
               attribute8,
               attribute9,
               attribute10,
               attribute11,
               attribute12,
               attribute13,
               attribute14,
               attribute15,
               attribute_category,
               approval_status,
               approval_description,
               invoice_distribution_total,
               posting_status,
               prepay_flag,
               authorized_by,
               cancelled_date,
               cancelled_by,
               cancelled_amount,
               temp_cancelled_amount,
               project_accounting_context,
               ussgl_transaction_code,
               ussgl_trx_code_context,
               project_id,
               task_id,
               expenditure_type,
               expenditure_item_date,
               pa_quantity,
               expenditure_organization_id,
               pa_default_dist_ccid,
               vendor_prepay_amount,
               payment_amount_total,
               awt_flag,
               awt_group_id,
               reference_1,
               reference_2,
               org_id,
               pre_withholding_amount,
               global_attribute_category,
               global_attribute1,
               global_attribute2,
               global_attribute3,
               global_attribute4,
               global_attribute5,
               global_attribute6,
               global_attribute7,
               global_attribute8,
               global_attribute9,
               global_attribute10,
               global_attribute11,
               global_attribute12,
               global_attribute13,
               global_attribute14,
               global_attribute15,
               global_attribute16,
               global_attribute17,
               global_attribute18,
               global_attribute19,
               global_attribute20,
               auto_tax_calc_flag,
               payment_cross_rate_type,
               payment_cross_rate_date,
               pay_curr_invoice_amount,
               mrc_base_amount,
               mrc_exchange_rate,
               mrc_exchange_rate_type,
               mrc_exchange_date,
               gl_date,
               award_id,
               paid_on_behalf_employee_id,
               amt_due_ccard_company,
               amt_due_employee,
               approval_ready_flag,
               approval_iteration,
               wfapproval_status,
               requester_id,
               validation_request_id,
               validated_tax_amount,
               quick_credit,
               credited_invoice_id,
               distribution_set_id,
               application_id,
               product_table,
               reference_key1,
               reference_key2,
               reference_key3,
               reference_key4,
               reference_key5,
               total_tax_amount,
               self_assessed_tax_amount,
               tax_related_invoice_id,
               trx_business_category,
               user_defined_fisc_class,
               taxation_country,
               document_sub_type,
               supplier_tax_invoice_number,
               supplier_tax_invoice_date,
               supplier_tax_exchange_rate,
               tax_invoice_recording_date,
               tax_invoice_internal_seq,
               legal_entity_id,
               historical_flag,
               force_revalidation_flag,
               bank_charge_bearer,
               remittance_message1,
               remittance_message2,
               remittance_message3,
               unique_remittance_identifier,
               uri_check_digit,
               settlement_priority,
               payment_reason_code,
               payment_reason_comments,
               payment_method_code,
               delivery_channel_code,
               quick_po_header_id,
               net_of_retainage_flag,
               release_amount_net_of_tax,
               control_amount,
               party_id,
               party_site_id,
               pay_proc_trxn_type_code,
               payment_function,
               cust_registration_code,
               cust_registration_number,
               port_of_entry_code,
               external_bank_account_id,
               vendor_contact_id,
               internal_contact_email,
               disc_is_inv_less_tax_flag,
               exclude_freight_from_discount,
               pay_awt_group_id,
               original_invoice_amount,
               dispute_reason,
               remit_to_supplier_name,
               remit_to_supplier_id,
               remit_to_supplier_site,
               remit_to_supplier_site_id,
               relationship_id,
               po_matched_flag,
               validation_worker_id
          from src_layer.ebs_AP_INVOICES_ALL
        intersect
        select report_id,
               invoice_id,
               last_update_date,
               last_updated_by,
               vendor_id,
               invoice_num,
               set_of_books_id,
               invoice_currency_code,
               payment_currency_code,
               payment_cross_rate,
               invoice_amount,
               vendor_site_id,
               amount_paid,
               discount_amount_taken,
               invoice_date,
               source,
               invoice_type_lookup_code,
               description,
               batch_id,
               amount_applicable_to_discount,
               tax_amount,
               terms_id,
               terms_date,
               payment_method_lookup_code,
               pay_group_lookup_code,
               accts_pay_code_combination_id,
               payment_status_flag,
               creation_date,
               created_by,
               base_amount,
               vat_code,
               last_update_login,
               exclusive_payment_flag,
               po_header_id,
               freight_amount,
               goods_received_date,
               invoice_received_date,
               voucher_num,
               approved_amount,
               recurring_payment_id,
               exchange_rate,
               exchange_rate_type,
               exchange_date,
               earliest_settlement_date,
               original_prepayment_amount,
               doc_sequence_id,
               doc_sequence_value,
               doc_category_code,
               attribute1,
               attribute2,
               attribute3,
               attribute4,
               attribute5,
               attribute6,
               attribute7,
               attribute8,
               attribute9,
               attribute10,
               attribute11,
               attribute12,
               attribute13,
               attribute14,
               attribute15,
               attribute_category,
               approval_status,
               approval_description,
               invoice_distribution_total,
               posting_status,
               prepay_flag,
               authorized_by,
               cancelled_date,
               cancelled_by,
               cancelled_amount,
               temp_cancelled_amount,
               project_accounting_context,
               ussgl_transaction_code,
               ussgl_trx_code_context,
               project_id,
               task_id,
               expenditure_type,
               expenditure_item_date,
               pa_quantity,
               expenditure_organization_id,
               pa_default_dist_ccid,
               vendor_prepay_amount,
               payment_amount_total,
               awt_flag,
               awt_group_id,
               reference_1,
               reference_2,
               org_id,
               pre_withholding_amount,
               global_attribute_category,
               global_attribute1,
               global_attribute2,
               global_attribute3,
               global_attribute4,
               global_attribute5,
               global_attribute6,
               global_attribute7,
               global_attribute8,
               global_attribute9,
               global_attribute10,
               global_attribute11,
               global_attribute12,
               global_attribute13,
               global_attribute14,
               global_attribute15,
               global_attribute16,
               global_attribute17,
               global_attribute18,
               global_attribute19,
               global_attribute20,
               auto_tax_calc_flag,
               payment_cross_rate_type,
               payment_cross_rate_date,
               pay_curr_invoice_amount,
               mrc_base_amount,
               mrc_exchange_rate,
               mrc_exchange_rate_type,
               mrc_exchange_date,
               gl_date,
               award_id,
               paid_on_behalf_employee_id,
               amt_due_ccard_company,
               amt_due_employee,
               approval_ready_flag,
               approval_iteration,
               wfapproval_status,
               requester_id,
               validation_request_id,
               validated_tax_amount,
               quick_credit,
               credited_invoice_id,
               distribution_set_id,
               application_id,
               product_table,
               reference_key1,
               reference_key2,
               reference_key3,
               reference_key4,
               reference_key5,
               total_tax_amount,
               self_assessed_tax_amount,
               tax_related_invoice_id,
               trx_business_category,
               user_defined_fisc_class,
               taxation_country,
               document_sub_type,
               supplier_tax_invoice_number,
               supplier_tax_invoice_date,
               supplier_tax_exchange_rate,
               tax_invoice_recording_date,
               tax_invoice_internal_seq,
               legal_entity_id,
               historical_flag,
               force_revalidation_flag,
               bank_charge_bearer,
               remittance_message1,
               remittance_message2,
               remittance_message3,
               unique_remittance_identifier,
               uri_check_digit,
               settlement_priority,
               payment_reason_code,
               payment_reason_comments,
               payment_method_code,
               delivery_channel_code,
               quick_po_header_id,
               net_of_retainage_flag,
               release_amount_net_of_tax,
               control_amount,
               party_id,
               party_site_id,
               pay_proc_trxn_type_code,
               payment_function,
               cust_registration_code,
               cust_registration_number,
               port_of_entry_code,
               external_bank_account_id,
               vendor_contact_id,
               internal_contact_email,
               disc_is_inv_less_tax_flag,
               exclude_freight_from_discount,
               pay_awt_group_id,
               original_invoice_amount,
               dispute_reason,
               remit_to_supplier_name,
               remit_to_supplier_id,
               remit_to_supplier_site,
               remit_to_supplier_site_id,
               relationship_id,
               po_matched_flag,
               validation_worker_id
          from STD_LAYER.T05_AP_INVOICES_ALL)
      select report_id,
             invoice_id,
             last_update_date,
             last_updated_by,
             vendor_id,
             invoice_num,
             set_of_books_id,
             invoice_currency_code,
             payment_currency_code,
             payment_cross_rate,
             invoice_amount,
             vendor_site_id,
             amount_paid,
             discount_amount_taken,
             invoice_date,
             source,
             invoice_type_lookup_code,
             description,
             batch_id,
             amount_applicable_to_discount,
             tax_amount,
             terms_id,
             terms_date,
             payment_method_lookup_code,
             pay_group_lookup_code,
             accts_pay_code_combination_id,
             payment_status_flag,
             creation_date,
             created_by,
             base_amount,
             vat_code,
             last_update_login,
             exclusive_payment_flag,
             po_header_id,
             freight_amount,
             goods_received_date,
             invoice_received_date,
             voucher_num,
             approved_amount,
             recurring_payment_id,
             exchange_rate,
             exchange_rate_type,
             exchange_date,
             earliest_settlement_date,
             original_prepayment_amount,
             doc_sequence_id,
             doc_sequence_value,
             doc_category_code,
             attribute1,
             attribute2,
             attribute3,
             attribute4,
             attribute5,
             attribute6,
             attribute7,
             attribute8,
             attribute9,
             attribute10,
             attribute11,
             attribute12,
             attribute13,
             attribute14,
             attribute15,
             attribute_category,
             approval_status,
             approval_description,
             invoice_distribution_total,
             posting_status,
             prepay_flag,
             authorized_by,
             cancelled_date,
             cancelled_by,
             cancelled_amount,
             temp_cancelled_amount,
             project_accounting_context,
             ussgl_transaction_code,
             ussgl_trx_code_context,
             project_id,
             task_id,
             expenditure_type,
             expenditure_item_date,
             pa_quantity,
             expenditure_organization_id,
             pa_default_dist_ccid,
             vendor_prepay_amount,
             payment_amount_total,
             awt_flag,
             awt_group_id,
             reference_1,
             reference_2,
             org_id,
             pre_withholding_amount,
             global_attribute_category,
             global_attribute1,
             global_attribute2,
             global_attribute3,
             global_attribute4,
             global_attribute5,
             global_attribute6,
             global_attribute7,
             global_attribute8,
             global_attribute9,
             global_attribute10,
             global_attribute11,
             global_attribute12,
             global_attribute13,
             global_attribute14,
             global_attribute15,
             global_attribute16,
             global_attribute17,
             global_attribute18,
             global_attribute19,
             global_attribute20,
             auto_tax_calc_flag,
             payment_cross_rate_type,
             payment_cross_rate_date,
             pay_curr_invoice_amount,
             mrc_base_amount,
             mrc_exchange_rate,
             mrc_exchange_rate_type,
             mrc_exchange_date,
             gl_date,
             award_id,
             paid_on_behalf_employee_id,
             amt_due_ccard_company,
             amt_due_employee,
             approval_ready_flag,
             approval_iteration,
             wfapproval_status,
             requester_id,
             validation_request_id,
             validated_tax_amount,
             quick_credit,
             credited_invoice_id,
             distribution_set_id,
             application_id,
             product_table,
             reference_key1,
             reference_key2,
             reference_key3,
             reference_key4,
             reference_key5,
             total_tax_amount,
             self_assessed_tax_amount,
             tax_related_invoice_id,
             trx_business_category,
             user_defined_fisc_class,
             taxation_country,
             document_sub_type,
             supplier_tax_invoice_number,
             supplier_tax_invoice_date,
             supplier_tax_exchange_rate,
             tax_invoice_recording_date,
             tax_invoice_internal_seq,
             legal_entity_id,
             historical_flag,
             force_revalidation_flag,
             bank_charge_bearer,
             remittance_message1,
             remittance_message2,
             remittance_message3,
             unique_remittance_identifier,
             uri_check_digit,
             settlement_priority,
             payment_reason_code,
             payment_reason_comments,
             payment_method_code,
             delivery_channel_code,
             quick_po_header_id,
             net_of_retainage_flag,
             release_amount_net_of_tax,
             control_amount,
             party_id,
             party_site_id,
             pay_proc_trxn_type_code,
             payment_function,
             cust_registration_code,
             cust_registration_number,
             port_of_entry_code,
             external_bank_account_id,
             vendor_contact_id,
             internal_contact_email,
             disc_is_inv_less_tax_flag,
             exclude_freight_from_discount,
             pay_awt_group_id,
             original_invoice_amount,
             dispute_reason,
             remit_to_supplier_name,
             remit_to_supplier_id,
             remit_to_supplier_site,
             remit_to_supplier_site_id,
             relationship_id,
             po_matched_flag,
             validation_worker_id,
             sysdate,
             data_date,
             to_date('9999-12-31', 'yyyy/mm/dd'),
             -1,
             ds_line_sequence.nextval
        from SRC_LAYER.EBS_AP_INVOICES_ALL
       where invoice_id not in (select invoice_id from intersect_query);
    commit;
    -- set header_id linked with header table
    merge into STD_LAYER.T05_AP_INVOICES_ALL a
    using (select * from STD_LAYER.DATA_HEADER) b
    on (a.start_date = b.data_date and b.report_flag = 'ap_invoices_all')
    when matched then
      update set header_id = b.header_id;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.EBS_AP_INVOICES_ALL',
               'STD_LAYER.T05_AP_INVOICES_ALL',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.EBS_AP_INVOICES_ALL',
                 'STD_LAYER.T05_AP_INVOICES_ALL',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
    
  end update_ap_invoices_all;

  procedure update_ap_suppliers is
    query_date date;
  begin
    -- save query_date from etl_control 
    select data_date
      into query_date
      from ETL_CONTROL.CTL_GENERAL_PARAMETER;
    -- remove duplicated record identified by data_date
    delete from STD_LAYER.T01_AP_SUPPLIERS where start_date = query_date;
    update STD_LAYER.T01_AP_SUPPLIERS
       set end_date = to_date('9999-12-31', 'yyyy/mm/dd')
     where end_date = query_date;
    -- update end_date for the AP_SUPPLIERS
    merge into STD_LAYER.T01_AP_SUPPLIERS HIS
    using (select report_id,
                  vendor_id,
                  last_update_date,
                  last_updated_by,
                  vendor_name,
                  vendor_name_alt,
                  segment1,
                  summary_flag,
                  enabled_flag,
                  segment2,
                  segment3,
                  segment4,
                  segment5,
                  last_update_login,
                  creation_date,
                  created_by,
                  employee_id,
                  vendor_type_lookup_code,
                  customer_num,
                  one_time_flag,
                  parent_vendor_id,
                  min_order_amount,
                  ship_to_location_id,
                  bill_to_location_id,
                  ship_via_lookup_code,
                  freight_terms_lookup_code,
                  fob_lookup_code,
                  terms_id,
                  set_of_books_id,
                  credit_status_lookup_code,
                  credit_limit,
                  always_take_disc_flag,
                  pay_date_basis_lookup_code,
                  pay_group_lookup_code,
                  payment_priority,
                  invoice_currency_code,
                  payment_currency_code,
                  invoice_amount_limit,
                  exchange_date_lookup_code,
                  hold_all_payments_flag,
                  hold_future_payments_flag,
                  hold_reason,
                  distribution_set_id,
                  accts_pay_code_combination_id,
                  disc_lost_code_combination_id,
                  disc_taken_code_combination_id,
                  expense_code_combination_id,
                  prepay_code_combination_id,
                  num_1099,
                  type_1099,
                  withholding_status_lookup_code,
                  withholding_start_date,
                  organization_type_lookup_code,
                  vat_code,
                  start_date_active,
                  end_date_active,
                  minority_group_lookup_code,
                  payment_method_lookup_code,
                  bank_account_name,
                  bank_account_num,
                  bank_num,
                  bank_account_type,
                  women_owned_flag,
                  small_business_flag,
                  standard_industry_class,
                  hold_flag,
                  purchasing_hold_reason,
                  hold_by,
                  hold_date,
                  terms_date_basis,
                  price_tolerance,
                  inspection_required_flag,
                  receipt_required_flag,
                  qty_rcv_tolerance,
                  qty_rcv_exception_code,
                  enforce_ship_to_location_code,
                  days_early_receipt_allowed,
                  days_late_receipt_allowed,
                  receipt_days_exception_code,
                  receiving_routing_id,
                  allow_substitute_receipts_flag,
                  allow_unordered_receipts_flag,
                  hold_unmatched_invoices_flag,
                  exclusive_payment_flag,
                  ap_tax_rounding_rule,
                  auto_tax_calc_flag,
                  auto_tax_calc_override,
                  amount_includes_tax_flag,
                  tax_verification_date,
                  name_control,
                  state_reportable_flag,
                  federal_reportable_flag,
                  attribute_category,
                  attribute1,
                  attribute2,
                  attribute3,
                  attribute4,
                  attribute5,
                  attribute6,
                  attribute7,
                  attribute8,
                  attribute9,
                  attribute10,
                  attribute11,
                  attribute12,
                  attribute13,
                  attribute14,
                  attribute15,
                  request_id,
                  program_application_id,
                  program_id,
                  program_update_date,
                  offset_vat_code,
                  vat_registration_num,
                  auto_calculate_interest_flag,
                  validation_number,
                  exclude_freight_from_discount,
                  tax_reporting_name,
                  check_digits,
                  bank_number,
                  allow_awt_flag,
                  awt_group_id,
                  global_attribute1,
                  global_attribute2,
                  global_attribute3,
                  global_attribute4,
                  global_attribute5,
                  global_attribute6,
                  global_attribute7,
                  global_attribute8,
                  global_attribute9,
                  global_attribute10,
                  global_attribute11,
                  global_attribute12,
                  global_attribute13,
                  global_attribute14,
                  global_attribute15,
                  global_attribute16,
                  global_attribute17,
                  global_attribute18,
                  global_attribute19,
                  global_attribute20,
                  global_attribute_category,
                  edi_transaction_handling,
                  edi_payment_method,
                  edi_payment_format,
                  edi_remittance_method,
                  edi_remittance_instruction,
                  bank_charge_bearer,
                  bank_branch_type,
                  match_option,
                  future_dated_payment_ccid,
                  create_debit_memo_flag,
                  offset_tax_flag,
                  party_id,
                  parent_party_id,
                  ni_number,
                  tca_sync_num_1099,
                  tca_sync_vendor_name,
                  tca_sync_vat_reg_num,
                  individual_1099,
                  unique_tax_reference_num,
                  partnership_utr,
                  partnership_name,
                  cis_enabled_flag,
                  first_name,
                  second_name,
                  last_name,
                  salutation,
                  trading_name,
                  work_reference,
                  company_registration_number,
                  national_insurance_number,
                  verification_number,
                  verification_request_id,
                  match_status_flag,
                  cis_verification_date,
                  pay_awt_group_id,
                  cis_parent_vendor_id,
                  bus_class_last_certified_date,
                  bus_class_last_certified_by
             from SRC_LAYER.EBS_AP_SUPPLIERS
           minus
           select report_id,
                  vendor_id,
                  last_update_date,
                  last_updated_by,
                  vendor_name,
                  vendor_name_alt,
                  segment1,
                  summary_flag,
                  enabled_flag,
                  segment2,
                  segment3,
                  segment4,
                  segment5,
                  last_update_login,
                  creation_date,
                  created_by,
                  employee_id,
                  vendor_type_lookup_code,
                  customer_num,
                  one_time_flag,
                  parent_vendor_id,
                  min_order_amount,
                  ship_to_location_id,
                  bill_to_location_id,
                  ship_via_lookup_code,
                  freight_terms_lookup_code,
                  fob_lookup_code,
                  terms_id,
                  set_of_books_id,
                  credit_status_lookup_code,
                  credit_limit,
                  always_take_disc_flag,
                  pay_date_basis_lookup_code,
                  pay_group_lookup_code,
                  payment_priority,
                  invoice_currency_code,
                  payment_currency_code,
                  invoice_amount_limit,
                  exchange_date_lookup_code,
                  hold_all_payments_flag,
                  hold_future_payments_flag,
                  hold_reason,
                  distribution_set_id,
                  accts_pay_code_combination_id,
                  disc_lost_code_combination_id,
                  disc_taken_code_combination_id,
                  expense_code_combination_id,
                  prepay_code_combination_id,
                  num_1099,
                  type_1099,
                  withholding_status_lookup_code,
                  withholding_start_date,
                  organization_type_lookup_code,
                  vat_code,
                  start_date_active,
                  end_date_active,
                  minority_group_lookup_code,
                  payment_method_lookup_code,
                  bank_account_name,
                  bank_account_num,
                  bank_num,
                  bank_account_type,
                  women_owned_flag,
                  small_business_flag,
                  standard_industry_class,
                  hold_flag,
                  purchasing_hold_reason,
                  hold_by,
                  hold_date,
                  terms_date_basis,
                  price_tolerance,
                  inspection_required_flag,
                  receipt_required_flag,
                  qty_rcv_tolerance,
                  qty_rcv_exception_code,
                  enforce_ship_to_location_code,
                  days_early_receipt_allowed,
                  days_late_receipt_allowed,
                  receipt_days_exception_code,
                  receiving_routing_id,
                  allow_substitute_receipts_flag,
                  allow_unordered_receipts_flag,
                  hold_unmatched_invoices_flag,
                  exclusive_payment_flag,
                  ap_tax_rounding_rule,
                  auto_tax_calc_flag,
                  auto_tax_calc_override,
                  amount_includes_tax_flag,
                  tax_verification_date,
                  name_control,
                  state_reportable_flag,
                  federal_reportable_flag,
                  attribute_category,
                  attribute1,
                  attribute2,
                  attribute3,
                  attribute4,
                  attribute5,
                  attribute6,
                  attribute7,
                  attribute8,
                  attribute9,
                  attribute10,
                  attribute11,
                  attribute12,
                  attribute13,
                  attribute14,
                  attribute15,
                  request_id,
                  program_application_id,
                  program_id,
                  program_update_date,
                  offset_vat_code,
                  vat_registration_num,
                  auto_calculate_interest_flag,
                  validation_number,
                  exclude_freight_from_discount,
                  tax_reporting_name,
                  check_digits,
                  bank_number,
                  allow_awt_flag,
                  awt_group_id,
                  global_attribute1,
                  global_attribute2,
                  global_attribute3,
                  global_attribute4,
                  global_attribute5,
                  global_attribute6,
                  global_attribute7,
                  global_attribute8,
                  global_attribute9,
                  global_attribute10,
                  global_attribute11,
                  global_attribute12,
                  global_attribute13,
                  global_attribute14,
                  global_attribute15,
                  global_attribute16,
                  global_attribute17,
                  global_attribute18,
                  global_attribute19,
                  global_attribute20,
                  global_attribute_category,
                  edi_transaction_handling,
                  edi_payment_method,
                  edi_payment_format,
                  edi_remittance_method,
                  edi_remittance_instruction,
                  bank_charge_bearer,
                  bank_branch_type,
                  match_option,
                  future_dated_payment_ccid,
                  create_debit_memo_flag,
                  offset_tax_flag,
                  party_id,
                  parent_party_id,
                  ni_number,
                  tca_sync_num_1099,
                  tca_sync_vendor_name,
                  tca_sync_vat_reg_num,
                  individual_1099,
                  unique_tax_reference_num,
                  partnership_utr,
                  partnership_name,
                  cis_enabled_flag,
                  first_name,
                  second_name,
                  last_name,
                  salutation,
                  trading_name,
                  work_reference,
                  company_registration_number,
                  national_insurance_number,
                  verification_number,
                  verification_request_id,
                  match_status_flag,
                  cis_verification_date,
                  pay_awt_group_id,
                  cis_parent_vendor_id,
                  bus_class_last_certified_date,
                  bus_class_last_certified_by
             from STD_LAYER.T01_AP_SUPPLIERS) DIF
    on (HIS.vendor_id = DIF.vendor_id)
    
    when matched then
      update set HIS.end_date = query_date;
  
    -- insert the nonredundant(new) records 
  
    insert into STD_LAYER.T01_AP_SUPPLIERS
      with intersect_query as
       (select report_id,
               vendor_id,
               last_update_date,
               last_updated_by,
               vendor_name,
               vendor_name_alt,
               segment1,
               summary_flag,
               enabled_flag,
               segment2,
               segment3,
               segment4,
               segment5,
               last_update_login,
               creation_date,
               created_by,
               employee_id,
               vendor_type_lookup_code,
               customer_num,
               one_time_flag,
               parent_vendor_id,
               min_order_amount,
               ship_to_location_id,
               bill_to_location_id,
               ship_via_lookup_code,
               freight_terms_lookup_code,
               fob_lookup_code,
               terms_id,
               set_of_books_id,
               credit_status_lookup_code,
               credit_limit,
               always_take_disc_flag,
               pay_date_basis_lookup_code,
               pay_group_lookup_code,
               payment_priority,
               invoice_currency_code,
               payment_currency_code,
               invoice_amount_limit,
               exchange_date_lookup_code,
               hold_all_payments_flag,
               hold_future_payments_flag,
               hold_reason,
               distribution_set_id,
               accts_pay_code_combination_id,
               disc_lost_code_combination_id,
               disc_taken_code_combination_id,
               expense_code_combination_id,
               prepay_code_combination_id,
               num_1099,
               type_1099,
               withholding_status_lookup_code,
               withholding_start_date,
               organization_type_lookup_code,
               vat_code,
               start_date_active,
               end_date_active,
               minority_group_lookup_code,
               payment_method_lookup_code,
               bank_account_name,
               bank_account_num,
               bank_num,
               bank_account_type,
               women_owned_flag,
               small_business_flag,
               standard_industry_class,
               hold_flag,
               purchasing_hold_reason,
               hold_by,
               hold_date,
               terms_date_basis,
               price_tolerance,
               inspection_required_flag,
               receipt_required_flag,
               qty_rcv_tolerance,
               qty_rcv_exception_code,
               enforce_ship_to_location_code,
               days_early_receipt_allowed,
               days_late_receipt_allowed,
               receipt_days_exception_code,
               receiving_routing_id,
               allow_substitute_receipts_flag,
               allow_unordered_receipts_flag,
               hold_unmatched_invoices_flag,
               exclusive_payment_flag,
               ap_tax_rounding_rule,
               auto_tax_calc_flag,
               auto_tax_calc_override,
               amount_includes_tax_flag,
               tax_verification_date,
               name_control,
               state_reportable_flag,
               federal_reportable_flag,
               attribute_category,
               attribute1,
               attribute2,
               attribute3,
               attribute4,
               attribute5,
               attribute6,
               attribute7,
               attribute8,
               attribute9,
               attribute10,
               attribute11,
               attribute12,
               attribute13,
               attribute14,
               attribute15,
               request_id,
               program_application_id,
               program_id,
               program_update_date,
               offset_vat_code,
               vat_registration_num,
               auto_calculate_interest_flag,
               validation_number,
               exclude_freight_from_discount,
               tax_reporting_name,
               check_digits,
               bank_number,
               allow_awt_flag,
               awt_group_id,
               global_attribute1,
               global_attribute2,
               global_attribute3,
               global_attribute4,
               global_attribute5,
               global_attribute6,
               global_attribute7,
               global_attribute8,
               global_attribute9,
               global_attribute10,
               global_attribute11,
               global_attribute12,
               global_attribute13,
               global_attribute14,
               global_attribute15,
               global_attribute16,
               global_attribute17,
               global_attribute18,
               global_attribute19,
               global_attribute20,
               global_attribute_category,
               edi_transaction_handling,
               edi_payment_method,
               edi_payment_format,
               edi_remittance_method,
               edi_remittance_instruction,
               bank_charge_bearer,
               bank_branch_type,
               match_option,
               future_dated_payment_ccid,
               create_debit_memo_flag,
               offset_tax_flag,
               party_id,
               parent_party_id,
               ni_number,
               tca_sync_num_1099,
               tca_sync_vendor_name,
               tca_sync_vat_reg_num,
               individual_1099,
               unique_tax_reference_num,
               partnership_utr,
               partnership_name,
               cis_enabled_flag,
               first_name,
               second_name,
               last_name,
               salutation,
               trading_name,
               work_reference,
               company_registration_number,
               national_insurance_number,
               verification_number,
               verification_request_id,
               match_status_flag,
               cis_verification_date,
               pay_awt_group_id,
               cis_parent_vendor_id,
               bus_class_last_certified_date,
               bus_class_last_certified_by
          from src_layer.ebs_AP_SUPPLIERS
        intersect
        select report_id,
               vendor_id,
               last_update_date,
               last_updated_by,
               vendor_name,
               vendor_name_alt,
               segment1,
               summary_flag,
               enabled_flag,
               segment2,
               segment3,
               segment4,
               segment5,
               last_update_login,
               creation_date,
               created_by,
               employee_id,
               vendor_type_lookup_code,
               customer_num,
               one_time_flag,
               parent_vendor_id,
               min_order_amount,
               ship_to_location_id,
               bill_to_location_id,
               ship_via_lookup_code,
               freight_terms_lookup_code,
               fob_lookup_code,
               terms_id,
               set_of_books_id,
               credit_status_lookup_code,
               credit_limit,
               always_take_disc_flag,
               pay_date_basis_lookup_code,
               pay_group_lookup_code,
               payment_priority,
               invoice_currency_code,
               payment_currency_code,
               invoice_amount_limit,
               exchange_date_lookup_code,
               hold_all_payments_flag,
               hold_future_payments_flag,
               hold_reason,
               distribution_set_id,
               accts_pay_code_combination_id,
               disc_lost_code_combination_id,
               disc_taken_code_combination_id,
               expense_code_combination_id,
               prepay_code_combination_id,
               num_1099,
               type_1099,
               withholding_status_lookup_code,
               withholding_start_date,
               organization_type_lookup_code,
               vat_code,
               start_date_active,
               end_date_active,
               minority_group_lookup_code,
               payment_method_lookup_code,
               bank_account_name,
               bank_account_num,
               bank_num,
               bank_account_type,
               women_owned_flag,
               small_business_flag,
               standard_industry_class,
               hold_flag,
               purchasing_hold_reason,
               hold_by,
               hold_date,
               terms_date_basis,
               price_tolerance,
               inspection_required_flag,
               receipt_required_flag,
               qty_rcv_tolerance,
               qty_rcv_exception_code,
               enforce_ship_to_location_code,
               days_early_receipt_allowed,
               days_late_receipt_allowed,
               receipt_days_exception_code,
               receiving_routing_id,
               allow_substitute_receipts_flag,
               allow_unordered_receipts_flag,
               hold_unmatched_invoices_flag,
               exclusive_payment_flag,
               ap_tax_rounding_rule,
               auto_tax_calc_flag,
               auto_tax_calc_override,
               amount_includes_tax_flag,
               tax_verification_date,
               name_control,
               state_reportable_flag,
               federal_reportable_flag,
               attribute_category,
               attribute1,
               attribute2,
               attribute3,
               attribute4,
               attribute5,
               attribute6,
               attribute7,
               attribute8,
               attribute9,
               attribute10,
               attribute11,
               attribute12,
               attribute13,
               attribute14,
               attribute15,
               request_id,
               program_application_id,
               program_id,
               program_update_date,
               offset_vat_code,
               vat_registration_num,
               auto_calculate_interest_flag,
               validation_number,
               exclude_freight_from_discount,
               tax_reporting_name,
               check_digits,
               bank_number,
               allow_awt_flag,
               awt_group_id,
               global_attribute1,
               global_attribute2,
               global_attribute3,
               global_attribute4,
               global_attribute5,
               global_attribute6,
               global_attribute7,
               global_attribute8,
               global_attribute9,
               global_attribute10,
               global_attribute11,
               global_attribute12,
               global_attribute13,
               global_attribute14,
               global_attribute15,
               global_attribute16,
               global_attribute17,
               global_attribute18,
               global_attribute19,
               global_attribute20,
               global_attribute_category,
               edi_transaction_handling,
               edi_payment_method,
               edi_payment_format,
               edi_remittance_method,
               edi_remittance_instruction,
               bank_charge_bearer,
               bank_branch_type,
               match_option,
               future_dated_payment_ccid,
               create_debit_memo_flag,
               offset_tax_flag,
               party_id,
               parent_party_id,
               ni_number,
               tca_sync_num_1099,
               tca_sync_vendor_name,
               tca_sync_vat_reg_num,
               individual_1099,
               unique_tax_reference_num,
               partnership_utr,
               partnership_name,
               cis_enabled_flag,
               first_name,
               second_name,
               last_name,
               salutation,
               trading_name,
               work_reference,
               company_registration_number,
               national_insurance_number,
               verification_number,
               verification_request_id,
               match_status_flag,
               cis_verification_date,
               pay_awt_group_id,
               cis_parent_vendor_id,
               bus_class_last_certified_date,
               bus_class_last_certified_by
          from STD_LAYER.T01_AP_SUPPLIERS)
      select report_id,
             vendor_id,
             last_update_date,
             last_updated_by,
             vendor_name,
             vendor_name_alt,
             segment1,
             summary_flag,
             enabled_flag,
             segment2,
             segment3,
             segment4,
             segment5,
             last_update_login,
             creation_date,
             created_by,
             employee_id,
             vendor_type_lookup_code,
             customer_num,
             one_time_flag,
             parent_vendor_id,
             min_order_amount,
             ship_to_location_id,
             bill_to_location_id,
             ship_via_lookup_code,
             freight_terms_lookup_code,
             fob_lookup_code,
             terms_id,
             set_of_books_id,
             credit_status_lookup_code,
             credit_limit,
             always_take_disc_flag,
             pay_date_basis_lookup_code,
             pay_group_lookup_code,
             payment_priority,
             invoice_currency_code,
             payment_currency_code,
             invoice_amount_limit,
             exchange_date_lookup_code,
             hold_all_payments_flag,
             hold_future_payments_flag,
             hold_reason,
             distribution_set_id,
             accts_pay_code_combination_id,
             disc_lost_code_combination_id,
             disc_taken_code_combination_id,
             expense_code_combination_id,
             prepay_code_combination_id,
             num_1099,
             type_1099,
             withholding_status_lookup_code,
             withholding_start_date,
             organization_type_lookup_code,
             vat_code,
             start_date_active,
             end_date_active,
             minority_group_lookup_code,
             payment_method_lookup_code,
             bank_account_name,
             bank_account_num,
             bank_num,
             bank_account_type,
             women_owned_flag,
             small_business_flag,
             standard_industry_class,
             hold_flag,
             purchasing_hold_reason,
             hold_by,
             hold_date,
             terms_date_basis,
             price_tolerance,
             inspection_required_flag,
             receipt_required_flag,
             qty_rcv_tolerance,
             qty_rcv_exception_code,
             enforce_ship_to_location_code,
             days_early_receipt_allowed,
             days_late_receipt_allowed,
             receipt_days_exception_code,
             receiving_routing_id,
             allow_substitute_receipts_flag,
             allow_unordered_receipts_flag,
             hold_unmatched_invoices_flag,
             exclusive_payment_flag,
             ap_tax_rounding_rule,
             auto_tax_calc_flag,
             auto_tax_calc_override,
             amount_includes_tax_flag,
             tax_verification_date,
             name_control,
             state_reportable_flag,
             federal_reportable_flag,
             attribute_category,
             attribute1,
             attribute2,
             attribute3,
             attribute4,
             attribute5,
             attribute6,
             attribute7,
             attribute8,
             attribute9,
             attribute10,
             attribute11,
             attribute12,
             attribute13,
             attribute14,
             attribute15,
             request_id,
             program_application_id,
             program_id,
             program_update_date,
             offset_vat_code,
             vat_registration_num,
             auto_calculate_interest_flag,
             validation_number,
             exclude_freight_from_discount,
             tax_reporting_name,
             check_digits,
             bank_number,
             allow_awt_flag,
             awt_group_id,
             global_attribute1,
             global_attribute2,
             global_attribute3,
             global_attribute4,
             global_attribute5,
             global_attribute6,
             global_attribute7,
             global_attribute8,
             global_attribute9,
             global_attribute10,
             global_attribute11,
             global_attribute12,
             global_attribute13,
             global_attribute14,
             global_attribute15,
             global_attribute16,
             global_attribute17,
             global_attribute18,
             global_attribute19,
             global_attribute20,
             global_attribute_category,
             edi_transaction_handling,
             edi_payment_method,
             edi_payment_format,
             edi_remittance_method,
             edi_remittance_instruction,
             bank_charge_bearer,
             bank_branch_type,
             match_option,
             future_dated_payment_ccid,
             create_debit_memo_flag,
             offset_tax_flag,
             party_id,
             parent_party_id,
             ni_number,
             tca_sync_num_1099,
             tca_sync_vendor_name,
             tca_sync_vat_reg_num,
             individual_1099,
             unique_tax_reference_num,
             partnership_utr,
             partnership_name,
             cis_enabled_flag,
             first_name,
             second_name,
             last_name,
             salutation,
             trading_name,
             work_reference,
             company_registration_number,
             national_insurance_number,
             verification_number,
             verification_request_id,
             match_status_flag,
             cis_verification_date,
             pay_awt_group_id,
             cis_parent_vendor_id,
             bus_class_last_certified_date,
             bus_class_last_certified_by,
             sysdate,
             data_date,
             to_date('9999-12-31', 'yyyy/mm/dd'),
             -1,
             ds_line_sequence.nextval
        from SRC_LAYER.EBS_AP_SUPPLIERS
       where vendor_id not in (select vendor_id from intersect_query);
    commit;
    -- set header_id linked with header table
    merge into STD_LAYER.T01_AP_SUPPLIERS a
    using (select * from STD_LAYER.DATA_HEADER) b
    on (a.start_date = b.data_date and b.report_flag = 'ap_suppliers')
    when matched then
      update set header_id = b.header_id;
  
    -- update system log in etl_control
    update_log('SRC_LAYER.EBS_AP_SUPPLIERS',
               'STD_LAYER.T01_AP_SUPPLIERS',
               query_date,
               'yes');
  exception
    -- error handling if exception happens
    when others then
      update_log('SRC_LAYER.EBS_AP_SUPPLIERS',
                 'STD_LAYER.T01_AP_SUPPLIERS',
                 query_date,
                 'no',
                 sqlerrm);
      dbms_output.put_line(sqlerrm);
      rollback;
    
  end update_ap_suppliers;

  -- update log in etl_control 
  procedure update_log(source_sheet      varchar2,
                       target_sheet      varchar2,
                       query_date        date,
                       success_status    varchar2,
                       exception_message varchar2 default NULL) is
  begin
    insert into etl_control.etl_control_log
      (etl_modle,
       etl_source,
       etl_target,
       data_date,
       etl_date,
       is_success,
       exceptionerrormsg)
    values
      ('STD_LAYER',
       source_sheet,
       target_sheet,
       query_date,
       sysdate,
       success_status,
       exception_message);
    commit;
  end update_log;

end ETL_process_entry;
/
