<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<title>锐安协同办公 - 考勤管理 - 考勤打卡</title>
<link rel="stylesheet" type="text/css" href="style/global.css" />
<link rel="stylesheet" type="text/css" href="style/style.css">
<script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="js/global.js"></script>
</head>
<body>
	<div class="container relative">
		<input id="userName" type="hidden" /> <input id="address"
			type="hidden" /> <input id="province" type="hidden" /> <input
			id="city" type="hidden" /> <input id="district" type="hidden" /> <input
			id="street" type="hidden" /> <input id="streetNumber" type="hidden" />
		<input id="mLocation_X" type="hidden" /> <input id="mLocation_Y"
			type="hidden" /> <input id="adressMsg" type="hidden" />
		<div id='container' class="map"></div>
		<div id='tip'></div>
		<div class="punchClockWrap">
			<a href="javascript:;" id="res1" class='left'> <span
				class="punch disabled"></span> <span class="curTime">09:00</span>
			</a> <a href="javascript:;" id="res2" class='left'> <span
				class="punch disabled"></span> <span class="curTime">12:00</span>
			</a> <a href="javascript:;" id="res3" class='left'> <span
				class="punch disabled"></span> <span class="curTime">13:00</span>
			</a> <a href="javascript:;" id="res4" class='left'> <span
				class="punch disabled"></span> <span class="curTime">18:00</span>
			</a>
		</div>
	</div>
	<div class="popWrap1">
		<p class="msg">--</p>
		<a href="javascript:;" class="btn_sure_res1">确定</a> <a
			href="javascript:;" class="btn_load_res1">重定位</a> <a
			href="javascript:;" class="btn_close_res1">取消</a>
	</div>

	<div class="popWrap2">
		<p class="msg">--</p>
		<a href="javascript:;" class="btn_sure_res2">确定</a> <a
			href="javascript:;" class="btn_load_res2">重定位</a> <a
			href="javascript:;" class="btn_close_res2">取消</a>
	</div>

	<div class="popWrap3">
		<p class="msg">--</p>
		<a href="javascript:;" class="btn_sure_res3">确定</a> <a
			href="javascript:;" class="btn_load_res3">重定位</a> <a
			href="javascript:;" class="btn_close_res3">取 消</a>
	</div>

	<div class="popWrap4">
		<p class="msg">--</p>
		<a href="javascript:;" class="btn_sure_res4">确定</a> <a
			href="javascript:;" class="btn_load_res4">重定位</a> <a
			href="javascript:;" class="btn_close_res4">取消</a>
	</div>
	<link rel="stylesheet"
		href="https://cache.amap.com/lbs/static/main1119.css" />
	<script type="text/javascript"
		src="https://webapi.amap.com/maps?v=1.4.9&key=1bd747249cad2f541cb7c6cae5224f41&radius=1000"></script>
	<script type="text/javascript"
		src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
	<script type="text/javascript">
			var wxObjet = {};
			var url = window.location.href.split("#")[0];
			if(localStorage.wxUser != null && localStorage.wxCode!=null){
				var wxCodes = getQueryString("code");
				var wxdata = JSON.parse(localStorage.wxCode);
				if(wxdata.code == wxCodes){
					var data = JSON.parse(localStorage.wxUser);
					$('#userName').val(data.userName);
					getKaoqinRecord(data.userName,'');
				}else{
					getUserDataInfo();
				}
			}else{
				getUserDataInfo();
			}
			
			//href=encodeURIComponent(window.location.href)//这个参数是用来获取当前页面的url
			$.ajax({
				url:URL_PATH+'/RunErpSystem/getSha1.action',
				type:'post',
				data : {
				url:url,
				AppId:'KAOQIN'
				},
				async:false,/*同步请求*/
				dataType:'jsonp',
				jsonp:'callback',
				jsonpCallback:'flightHandler',
				success:function(data){
					var test = JSON.parse(data);
					wxObjet.timestamp = test.timestamp;
					wxObjet.nonceStr = test.nonceStr;
					wxObjet.signature = test.signature;

					
					wx.config({
						beta: true,// 调用wx.invoke形式的接口值时，该值必须为true。
						debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
						appId: 'wla377739e7a', // 必填，公众号的唯一标识
						timestamp: wxObjet.timestamp, // 必填，生成签名的时间戳
						nonceStr: wxObjet.nonceStr, // 必填，生成签名的随机串
						signature: wxObjet.signature,// 必填，签名
						jsApiList: ["getLocation","hideOptionMenu"] // 必填，需要使用的JS接口列表
					});
					
					wx.ready(function(){
						load();
						wx.hideOptionMenu();		
					});

					wx.error(function(res){
					});
				}		
			});
		function getUserDataInfo(){
			$('#userName').val('');
			localStorage.removeItem('wxCode');
			//获取code
			var code = getQueryString("code");
			var wxCode = {code:code};
			var codeStr = JSON.stringify(wxCode);
			localStorage.wxCode = codeStr;
			$.ajax({
					url:URL_PATH+'/RunErpSystem/queryWXUserInfo.action',
					type:'post',
					data : {
					code:code,
					AppId:'KAOQIN'
					},
					async:false,/*同步请求*/
					dataType:'jsonp',
					jsonp:'callback',
					jsonpCallback:'flightHandler',
					error : function(){
						alert('网络异常！');
					},
					success:function(data){
						var data = JSON.parse(data);
						$("#userName").val(data.userName);
						var message = data.msg;
						if(message.indexOf("success") != -1){
							localStorage.removeItem('wxUser');
							var wxUser = {userName:data.userName,wxUserId:data.wxUserId};
							var str = JSON.stringify(wxUser);
							localStorage.wxUser = str;
							
							getKaoqinRecord(data.userName,'');
						}
					}    
			});	
		}
		function load(){
			$("#address").attr("value","");
			var map = new AMap.Map('container');
				map.setZoom(18);//地图显示的缩放级别

				//添加点标记，并使用自己的icon
			var marker = new AMap.Marker({
				map: map,
				position: [116.367258,39.981089],
				icon: new AMap.Icon({            
					size: new AMap.Size(40, 50),  //图标大小
					image: "https://webapi.amap.com/theme/v1.3/images/newpc/way_btn2.png",
					imageOffset: new AMap.Pixel(0, -60)
				})        
			});
			
			wx.getLocation({
					type: 'gcj02', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
					success: function (res) {
						var latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
						var longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
						var mLocationStr=[];
						mLocationStr.push(longitude);
						mLocationStr.push(latitude);
						map.setCenter(mLocationStr);//根据定位到的经纬度设置中心点
						marker.setPosition(mLocationStr);
						$("#mLocation_X").val(latitude);
						$("#mLocation_Y").val(longitude);
						
						var location = longitude+","+latitude;
						 $.ajax({     
							//要用post方式      
							type: "post",     
							//方法所在页面和方法名      
							url: "https://restapi.amap.com/v3/geocode/regeo?output=json&location="+location+"&key=1bd747249cad2f541cb7c6cae5224f41&radius=200&extensions=all&batch=false",     
							contentType: "charset=utf-8",     
							dataType: "jsonp",
							async: false,
							success: function(data) {
								//返回的数据用data.d获取内容      
								if(data.status == 1 && data.info == 'OK'){
									var addressComponent = data.regeocode.addressComponent;
									var province = addressComponent.province ;
									var city = addressComponent.city ;
									if(city == ""){
										city = province;
									}
									var district = addressComponent.district;
									var streetObj = addressComponent.streetNumber;
									var street = streetObj.street ;
									var streetNumber = streetObj.number;
									
									$("#province").val(province);
									$("#city").val(city);
									$("#district").val(district);
									$("#street").val(street);
									$("#streetNumber").val(streetNumber);
									//定位成功
									var address = province + ", " + city + ", " + district + ", " + street + ", " + streetNumber;
									$("#address").val(address);
									$("#adressMsg").val(address);
								}else{
									map.setCenter([116.3972282,39.90960456]);
									alert("解析地址失败,请重试!");
								}
							},
							error: function(err) { 
								alert("解析地址失败,请重试!");
							}     
						});
				   }, error: function(err) { 
						alert("获取地址失败,请重试!");
					 }
			})


	}
			
function loadMap(){
	$("#address").attr("value","");
	var map = new AMap.Map('container');
	map.setZoom(18);//地图显示的缩放级别
	//添加点标记，并使用自己的icon
	var marker = new AMap.Marker({
		map: map,
		position: [116.367258,39.981089],
		icon: new AMap.Icon({            
			size: new AMap.Size(40, 50),  //图标大小
			image: "https://webapi.amap.com/theme/v1.3/images/newpc/way_btn2.png",
			imageOffset: new AMap.Pixel(0, -60)
		})        
	});
	
	wx.getLocation({
			type: 'gcj02', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
			success: function (res) {
				var latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
				var longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
				var mLocationStr=[];
				mLocationStr.push(longitude);
				mLocationStr.push(latitude);
				map.setCenter(mLocationStr);//根据定位到的经纬度设置中心点
				marker.setPosition(mLocationStr);
				$("#mLocation_X").val(latitude);
				$("#mLocation_Y").val(longitude);
				var location = longitude+","+latitude;
				 $.ajax({     
					//要用post方式      
					type: "post",     
					//方法所在页面和方法名      
					url: "https://restapi.amap.com/v3/geocode/regeo?output=json&location="+location+"&key=1bd747249cad2f541cb7c6cae5224f41&radius=200&extensions=all&batch=false",     
					contentType: "charset=utf-8",     
					dataType: "jsonp",
					async: false,
					success: function(data) {
						//返回的数据用data.d获取内容      
						if(data.status == 1 && data.info == 'OK'){
							var addressComponent = data.regeocode.addressComponent;
							var province = addressComponent.province ;
							var city = addressComponent.city ;
							if(city == ""){
								city = province;
							}
							var district = addressComponent.district;
							var streetObj = addressComponent.streetNumber;
							var street = streetObj.street ;
							var streetNumber = streetObj.number;
							$("#province").val(province);
							$("#city").val(city);
							$("#district").val(district);
							$("#street").val(street);
							$("#streetNumber").val(streetNumber);
							//定位成功
							var address = province + ", " + city + ", " + district + ", " + street + ", " + streetNumber;
							$("#address").val(address);
							$("#adressMsg").val(address);
						}else{
							map.setCenter([116.3972282,39.90960456]);
							alert("解析地址失败,请重试!");
						}
					},
					error: function(err) { 
						alert("解析地址失败,请重试!");
					}     
				});
		   }, error: function(err) { 
				alert("获取地址失败,请重试!");
			 }
	})
	var userName = $('#userName').val();
	getKaoqinRecord(userName,'');
}			
//获取url？后的参数
function getQueryString(name) {
	var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
	var r = window.location.search.substr(1).match(reg);
	if (r != null) return unescape(r[2]);
	return null;
}		
			
function getKaoqinRecord(userName,kaoQinPath){
	$.ajax({
			url:URL_PATH+"/RunErpSystem/querySignInfo.action",
			type:"post",
			data : {
			userName:userName,
			fromWXApp:true
			},
			async:false,/*同步请求*/
			dataType:"jsonp",
			jsonp:"callback",
			jsonpCallback:"flightHandler",
			error : function(){
				alert("打卡信息加载失败！");
			},
			success:function(data){
				var test = JSON.parse(data);
				var signInfo = test.signInfo;
				var userName = test.userName;
			   if(signInfo.msStatus == "已打卡"){
				  $('.punchClockWrap #res1').removeClass('cur').find('.punch').addClass('disabled');						  
				  $('#res1 .curTime').html(signInfo.msTime.substring(11));
			   }else{
				  $('.punchClockWrap #res1').find('.punch').removeClass('disabled');	
			   }
			   
			   if(signInfo.msoStatus == "已打卡"){
				  $('.punchClockWrap #res2').removeClass('cur').find('.punch').addClass('disabled');                         
				  $('#res2 .curTime').html(signInfo.msoTime.substring(11));
			   }else{
				   $('.punchClockWrap #res2').find('.punch').removeClass('disabled');						  
			   }
			  
			   if(signInfo.asStatus == "已打卡"){  
				  $('.punchClockWrap #res3').removeClass('cur').find('.punch').addClass('disabled');                         
				  $('#res3 .curTime').html(signInfo.asTime.substring(11));
			   }else{
				   $('.punchClockWrap #res3').find('.punch').removeClass('disabled');						  
			   }
			   
			   if(signInfo.asoStatus == "已打卡"){  
				  $('.punchClockWrap #res4').removeClass('cur').find('.punch').addClass('disabled');                  
				  $('#res4 .curTime').html(signInfo.asoTime.substring(11));
			   }else{
				   $('.punchClockWrap #res4').find('.punch').removeClass('disabled');						  
			   }	
			}    
	});
}

//更新打卡记录
function userSign(jsonData) {
	$.ajax({
		   url:URL_PATH+"/RunErpSystem/userSign.action",
		   type:"post",
		   data : jsonData,
		   async:false,/*同步请求*/
		   dataType:"jsonp",
		   jsonp:"callback",
		   jsonpCallback:"flightHandler",
		   error : function(){    
			   alert("警告","打卡错误，请联系管理员！");
		   },
		   success:function(data){
			   data = eval("("+data+")");    //包数据解析为json 格式
			   var signInfo = data.signInfo;
			   if(signInfo.msStatus == "已打卡"){
				  $('.punchClockWrap #res1').removeClass('cur').find('.punch').addClass('disabled');						  
				  $('#res1 .curTime').html(signInfo.msTime.substring(11));
			   }
			   
			   if(signInfo.msoStatus == "已打卡"){
				  $('.punchClockWrap #res2').removeClass('cur').find('.punch').addClass('disabled');                         
				  $('#res2 .curTime').html(signInfo.msoTime.substring(11));
			   }
			  
			   if(signInfo.asStatus == "已打卡"){
				  $('.punchClockWrap #res3').removeClass('cur').find('.punch').addClass('disabled');                         
				  $('#res3 .curTime').html(signInfo.asTime.substring(11));
			   }
			   
			   if(signInfo.asoStatus == "已打卡"){ 
				  $('.punchClockWrap #res4').removeClass('cur').find('.punch').addClass('disabled');                  
				  $('#res4 .curTime').html(signInfo.asoTime.substring(11));
			   }	
		   }
	});
}

	//弹框1显示
	$('#res1').off().on('click', function(){
		if(!$(this).find('.punch').hasClass('disabled')){	
			loadMap();
			setTimeout(function(){
				var address=$("#address").val();
				var adressMsg = $("#adressMsg").val();
				if(address != '' && adressMsg != ''){
					$('.popWrap1 .msg').html(adressMsg);
					$('.btn_sure_res1').show();
					$('.btn_load_res1').hide();
					$('.btn_close_res1').show();
				}else{
					$('.popWrap1 .msg').html("定位失败，请重新定位！");
					$('.btn_sure_res1').hide();
					$('.btn_load_res1').show();
					$('.btn_close_res1').show();
				}
				$('.popWrap1').show();
				$('#res1').removeClass('cur');
				$(this).addClass('cur');
			},1500)	
		}
	});
	// 确定打卡并关闭弹框1
	$('.btn_sure_res1, .btn_close_res1').off().on('click', function(){
		if($(this).hasClass('btn_sure_res1')){
			var address=$("#address").val();
			if(address != ''){//写入打卡记录
				var jsonData = {};
				jsonData.userName = $("#userName").val();
				jsonData.province = $("#province").val();//省份
				jsonData.city = $("#city").val();//市
				jsonData.district = $("#district").val();//区
				jsonData.street = $("#street").val();//街道
				jsonData.streetNumber = $("#streetNumber").val();
				jsonData.address = $("#address").val();//
				jsonData.longitude = $("#mLocation_X").val();// 经度
				jsonData.latitude = $("#mLocation_Y").val(); // 纬度
				jsonData.signType = "m-sign";
				jsonData.fromWXApp = "true";
				userSign(jsonData);
				
			}
		}
		$('.popWrap1').hide();
		
	});
	// 重新定位并关闭弹框1
	$('.btn_load_res1').off().on('click', function(){
		if($(this).hasClass('btn_load_res1')){
			loadMap();//重新加载地图进行定位
		}
		$('.popWrap2').hide();
	});

	//弹框2显示
	$('#res2').off().on('click', function(){
		if(!$(this).find('.punch').hasClass('disabled')){
			loadMap();
			setTimeout(function(){
				var address=$("#address").val();
				var adressMsg = $("#adressMsg").val();
				if(address != '' && adressMsg != ''){
					$('.popWrap2 .msg').html(adressMsg);
					$('.btn_sure_res2').show();
					$('.btn_load_res2').hide();
					$('.btn_close_res2').show();	
				}else{
					$('.popWrap2 .msg').html("定位失败，请重新定位！");
					$('.btn_sure_res2').hide();
					$('.btn_load_res2').show();
					$('.btn_close_res2').show();
				}
				$('.popWrap2').show();
				$('#res2').removeClass('cur');
				$(this).addClass('cur');	
			},1500)
		}
	});
	
	// 确定打卡并关闭弹框2
	$('.btn_sure_res2, .btn_close_res2').off().on('click', function(){
		if($(this).hasClass('btn_sure_res2')){
			var address=$("#address").val();
			if(address != ''){//写入打卡记录
				var jsonData = {};
				jsonData.userName = $("#userName").val();
				jsonData.province = $("#province").val();//省份
				jsonData.city = $("#city").val();//市
				jsonData.district = $("#district").val();//区
				jsonData.street = $("#street").val();//街道
				jsonData.streetNumber = $("#streetNumber").val();
				jsonData.address = $("#address").val();//
				jsonData.longitude = $("#mLocation_X").val();// 经度
				jsonData.latitude = $("#mLocation_Y").val(); // 纬度
				jsonData.signType =  "m-sign-out";
				jsonData.fromWXApp = "true";
				userSign(jsonData);
			}
		}
		$('.popWrap2').hide();
	});
	
	// 重新定位并关闭弹框2
	$('.btn_load_res2').off().on('click', function(){
		if($(this).hasClass('btn_load_res2')){
			loadMap();//重新加载地图进行定位
		}
		$('.popWrap2').hide();
	});
	
	////=====================================
	//弹框3显示
	$('#res3').off().on('click', function(){
		if(!$(this).find('.punch').hasClass('disabled')){
			loadMap();
			setTimeout(function(){
			var address=$("#address").val();
			var adressMsg = $("#adressMsg").val();
				if(address != '' && adressMsg != ''){
					$('.popWrap3 .msg').html(adressMsg);
					$('.btn_sure_res3').show();
					$('.btn_load_res3').hide();
					$('.btn_close_res3').show();
				}else{
					$('.popWrap3 .msg').html("定位失败，请重新定位！");
					$('.btn_sure_res3').hide();
					$('.btn_load_res3').show();
					$('.btn_close_res3').show();
				}
				$('.popWrap3').show();
				$('#res3').removeClass('cur');
				$(this).addClass('cur');
			},1500)	
		}
	});
	
	// 确定打卡并关闭弹框3
	$('.btn_sure_res3, .btn_close_res3').off().on('click', function(){
		if($(this).hasClass('btn_sure_res3')){
			var address=$("#address").val();
			if(address != ''){//写入打卡记录
				var jsonData = {};
				jsonData.userName = $("#userName").val();
				jsonData.province = $("#province").val();//省份
				jsonData.city = $("#city").val();//市
				jsonData.district = $("#district").val();//区
				jsonData.street = $("#street").val();//街道
				jsonData.streetNumber = $("#streetNumber").val();
				jsonData.address = $("#address").val();//
				jsonData.longitude = $("#mLocation_X").val();// 经度
				jsonData.latitude = $("#mLocation_Y").val(); // 纬度
				jsonData.signType =  "a-sign";
				jsonData.fromWXApp = "true";
				userSign(jsonData);
			}
		}
		$('.popWrap3').hide();
	});
	
	// 重新定位并关闭弹框3
	$('.btn_load_res3').off().on('click', function(){
		if($(this).hasClass('btn_load_res3')){
			loadMap();//重新加载地图进行定位
		}
		$('.popWrap3').hide();
	});
	//=======================
	
	//弹框4显示
	$('#res4').off().on('click', function(){
		if(!$(this).find('.punch').hasClass('disabled')){
			loadMap();
			setTimeout(function(){
				var address=$("#address").val();
				var adressMsg = $("#adressMsg").val();
				if(address != '' && adressMsg != ''){
					$('.popWrap4 .msg').html(adressMsg);				
					$('.btn_sure_res4').show();
					$('.btn_load_res4').hide();
					$('.btn_close_res4').show();
				}else{
					$('.popWrap4 .msg').html("定位失败，请重新定位！");				
					$('.btn_sure_res4').hide();
					$('.btn_load_res4').show();
					$('.btn_close_res4').show();
				}
				$('.popWrap4').show();
				$('#res4').removeClass('cur');
				$(this).addClass('cur');	
			},1500)	
		}
	});
	
	// 确定打卡并关闭弹框4
	$('.btn_sure_res4, .btn_close_res4').off().on('click', function(){
		if($(this).hasClass('btn_sure_res4')){
			var address=$("#address").val();
			if(address != ''){//写入打卡记录
				var jsonData = {};
				jsonData.userName = $("#userName").val();
				jsonData.province = $("#province").val();//省份
				jsonData.city = $("#city").val();//市
				jsonData.district = $("#district").val();//区
				jsonData.street = $("#street").val();//街道
				jsonData.streetNumber = $("#streetNumber").val();
				jsonData.address = $("#address").val();//
				jsonData.longitude = $("#mLocation_X").val();// 经度
				jsonData.latitude = $("#mLocation_Y").val(); // 纬度
				jsonData.signType =  "a-sign-out";
				jsonData.fromWXApp = "true";
				userSign(jsonData);	
			}
		}
		$('.popWrap4').hide();
	});
	
	// 重新定位并关闭弹框4
	$('.btn_load_res4').off().on('click', function(){
		if($(this).hasClass('btn_load_res4')){
			loadMap();//重新加载地图进行定位
		}
		$('.popWrap4').hide();
	});

		</script>
</body>
</html>
