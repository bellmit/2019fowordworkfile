<html>
<head>
<script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="js/md5.js"></script>
<script type="text/javascript" src="js/global.js"></script>
<script type="text/javascript"
	src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
</head>
<body style="height: 100%">
</body>
<script type="text/javascript">

var wxObjet = {};
var url = window.location.href.split("#")[0];
if(localStorage.wxUser != null && localStorage.wxCode!=null){
	var wxCodes = getQueryString("code");
	var wxdata = JSON.parse(localStorage.wxCode);
	if(wxdata.code == wxCodes){
			var userData = JSON.parse(localStorage.wxUser);
			var mUserId = userData.wxUserId;
            var t = Math.random();
			var timestamp=new Date().getTime();
			var passStr = 'Run.$*!(@._'+mUserId;
            var sign = $.md5("5FBAoT5WWyGMzcA93mmi"+"3b7feb5d20964fe0956d0f6b3287a5f9"+"91110108746736751Q"+passStr+timestamp);
			var orsrc = "https://api.piaozone.com/fpcy-mobile/fpzs/rakj?tin=91110108746736751Q&client_id=5FBAoT5WWyGMzcA93mmi&method=get&clientType=mobile&billNumber=0&serialNo=0&indexType=rakj"+"&eid="+passStr+"&random="+t+"&timestamp="+timestamp+"&sign="+sign;
			window.location.href=orsrc;
		
	}else{
		getUserDataInfo();
	}
}else{
	getUserDataInfo();
}


$.ajax({
	url:URL_PATH+'/RunErpSystem/getSha1.action',
	type:'post',
	data : {
	url:url,
	AppId:'INOVICE'
	},
	async:false,/*ͬ������*/
	dataType:'jsonp',
	jsonp:'callback',
	jsonpCallback:'flightHandler',
	success:function(data){
		var test = JSON.parse(data);
		wxObjet.timestamp = test.timestamp;
		wxObjet.nonceStr = test.nonceStr;
		wxObjet.signature = test.signature;
		
		wx.config({
			beta: true,// ����wx.invoke��ʽ�Ľӿ�ֵʱ����ֵ����Ϊtrue��
			debug: false, // �������ģʽ,���õ�����api�ķ���ֵ���ڿͻ���alert��4����Ҫ�鿴����Ĳ��������pc�˴򿪣�������Ϣ��ͨ��log������pc��ʱ�Ż��ӡ��
			appId: 'wla377739e7a', // ������ںŵ�Ψһ��ʶ
			timestamp: wxObjet.timestamp, // ������ǩ���ʱ���
			nonceStr: wxObjet.nonceStr, // ������ǩ������
			signature: wxObjet.signature,// ���ǩ��
			jsApiList: ["getLocation","hideOptionMenu"] // �����Ҫʹ�õ�JS�ӿ��б�
		});
		
		wx.ready(function(){
			wx.hideOptionMenu();		
		});

		wx.error(function(res){
		});
	}		
});


function getUserDataInfo(){
	localStorage.removeItem('wxCode');
	//��ȡcode
	var code = getQueryString("code");
	var wxCode = {code:code};
	var codeStr = JSON.stringify(wxCode);
	localStorage.wxCode = codeStr;
	$.ajax({
			url:URL_PATH+'/RunErpSystem/queryWXUserInfo.action',
			type:'post',
			data : {
			code:code,
			AppId:'INOVICE'
			},
			async:false,/*ͬ������*/
			dataType:'jsonp',
			jsonp:'callback',
			jsonpCallback:'flightHandler',
			error : function(){
				
			},
			success:function(data){
				var datas = JSON.parse(data);				
				var message = datas.msg;
				if(message.indexOf("success") != -1){
					localStorage.removeItem('wxUser');
					var wxUser = {userName:datas.userName,wxUserId:datas.wXUserId};
					var str = JSON.stringify(wxUser);
					localStorage.wxUser = str;
					var mUserId = datas.wXUserId;
	                var t = Math.random();
					var timestamp=new Date().getTime();
					var passStr ='Run.$*!(@._'+mUserId;
	                var sign = $.md5("5FBAoT5WWyGMzcA93mmi"+"3b7feb5d20964fe0956d0f6b3287a5f9"+"91110108746736751Q"+passStr+timestamp);
					var orsrc = "https://api.piaozone.com/fpcy-mobile/fpzs/rakj?tin=91110108746736751Q&client_id=5FBAoT5WWyGMzcA93mmi&method=get&clientType=mobile&billNumber=0&serialNo=0&indexType=rakj"+"&eid="+passStr+"&random="+t+"&timestamp="+timestamp+"&sign="+sign;
					window.location.href=orsrc;
					
				}
			}    
	});	
}


 //��ȡurl����Ĳ���
function getQueryString(name) {
	var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
	var r = window.location.search.substr(1).match(reg);
	if (r != null) return unescape(r[2]);
	return null;
}
 
</script>

</html>