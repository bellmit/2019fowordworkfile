<html>
<head>
<meta http-equiv="Content-Type" content="text/html;" charset="utf-8">
<script type="text/javascript"
	src="https://cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript"
	src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script type="text/javascript" src="js/global.js"></script>
<script type="text/javascript">  
	
	var wxObjet = {};
	var url = window.location.href.split("#")[0];
	if(localStorage.wxUser != null && localStorage.wxCode!=null){
		var wxCodes = getQueryString("code");
		var wxdata = JSON.parse(localStorage.wxCode);
		if(wxdata.code == wxCodes){
				var userData = JSON.parse(localStorage.wxUser);
				var mUserId = userData.wxUserId;
				var userName = userData.userName;
				logInAction(userName,mUserId);
		}else{
			getUserDataInfo();
		}
	}else{
		getUserDataInfo();
	}
	
	
	$.ajax({
		url:URL_PATH+'/RunErpSystem/getSha1.action',
		type:'post',
		data : {
		url:url,
		AppId:'INOVICE'
		},
		async:false,/*ͬ������*/
		dataType:'jsonp',
		jsonp:'callback',
		jsonpCallback:'flightHandler',
		success:function(data){
			var test = JSON.parse(data);
			wxObjet.timestamp = test.timestamp;
			wxObjet.nonceStr = test.nonceStr;
			wxObjet.signature = test.signature;
			
			wx.config({
				beta: true,// ����wx.invoke��ʽ�Ľӿ�ֵʱ����ֵ����Ϊtrue��
				debug: false, // ��������ģʽ,���õ�����api�ķ���ֵ���ڿͻ���alert��������Ҫ�鿴����Ĳ�����������pc�˴򿪣�������Ϣ��ͨ��log���������pc��ʱ�Ż��ӡ��
				appId: 'wla377739e7a', // ������ںŵ�Ψһ��ʶ
				timestamp: wxObjet.timestamp, // �������ǩ����ʱ���
				nonceStr: wxObjet.nonceStr, // �������ǩ���������
				signature: wxObjet.signature,// ���ǩ��
				jsApiList: ["getLocation","hideOptionMenu"] // �����Ҫʹ�õ�JS�ӿ��б�
			});
			
			wx.ready(function(){
				wx.hideOptionMenu();		
			});
	
			wx.error(function(res){
			});
		}		
	});
	
	
	
function getUserDataInfo(){
	localStorage.removeItem('wxCode');
	//��ȡcode
	var code = getQueryString("code");
	var wxCode = {code:code};
	var codeStr = JSON.stringify(wxCode);
	localStorage.wxCode = codeStr;
	$.ajax({
			url:URL_PATH+'/RunErpSystem/queryWXUserInfo.action',
			type:'post',
			data : {
			code:code,
			AppId:'FINE_BI'
			},
			async:false,/*ͬ������*/
			dataType:'jsonp',
			jsonp:'callback',
			jsonpCallback:'flightHandler',
			error : function(){
				
			},
			success:function(data){
				var datas = JSON.parse(data);				
				var message = datas.msg;
				if(message.indexOf("success") != -1){
					localStorage.removeItem('wxUser');
					var wxUser = {userName:datas.userName,wxUserId:datas.wXUserId};
					var str = JSON.stringify(wxUser);
					localStorage.wxUser = str;
					var mUserId = datas.wXUserId;
	             	logInAction(datas.userName,datas.wXUserId);
				}
			}    
	});	
}	
	
	

//��ȡurl����Ĳ���
function getQueryString(name) {
	var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
	var r = window.location.search.substr(1).match(reg);
	if (r != null) return unescape(r[2]);
	return null;
}	
	
function logInAction(userName,wXUserId) {
      jQuery.ajax({  
         url: URL_PATH_BI+'/webroot/decision/login/cross/domain?__device__=iPhone&terminal=H5',   
		 data: {'fine_username': userName, 'fine_password': 'Run.$*!(@._'+wXUserId, 'validity': -1},
         timeout: 5000,  
         dataType: 'jsonp',   
         jsonp:"callback",   
         success: function (res) {    
             var token = res.accessToken;   
             window.location.href = URL_PATH_BI+"/webroot/decision/url/mobile?token=" + token;   
         },   
         error: function () {   
             alert('��¼ʧ��');   
         }   
     });     
}  
    
 </script>
</head>
</html>