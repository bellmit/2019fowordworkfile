WITH dept AS (
SELECT a.db_key dept1
      ,b.db_key dept2
      ,c.db_key dept3
      ,d.db_key dept4
      ,f.db_key dept5
  FROM dw_fi_dept a
  LEFT JOIN dw_fi_dept b ON b.parent_key = a.db_key
  LEFT JOIN dw_fi_dept c ON c.parent_key = b.db_key
  LEFT JOIN dw_fi_dept d ON d.parent_key = c.db_key
  LEFT JOIN dw_fi_dept f ON f.parent_key = d.db_key)
 ,dept1 AS (--用户的利润中心：用来排除内部交易
   SELECT dept1 dept  FROM dept a WHERE a.dept1 ='8301'
   UNION  
   SELECT dept2  FROM dept a WHERE a.dept1 ='8301'--用户对应的利润中心
   UNION           
   SELECT dept3  FROM dept a WHERE a.dept1='8301'
   UNION 
   SELECT dept4  FROM dept a WHERE a.dept1='8301'       
   UNION 
   SELECT dept5  FROM dept a WHERE a.dept1 ='8301')
   
  ,dept2 AS (--参数的利润中心：用来排除底层数据
   SELECT dept1 dept  FROM dept a WHERE a.dept1 ='8301'--利润中心参数
   UNION  
   SELECT dept2  FROM dept a WHERE a.dept1 ='8301'
   UNION           
   SELECT dept3  FROM dept a WHERE a.dept1='8301'
   UNION 
   SELECT dept4  FROM dept a WHERE a.dept1='8301'       
   UNION 
   SELECT dept5  FROM dept a WHERE a.dept1 ='8301') 

    
select a.batch_num
      ,a.gjahr --年
      ,a.poper --会计期间
      ,a.budat --过账日期
      ,a.belnr --凭证号
      ,a.prctr --利润中心
      ,a.sprctr --伙伴利润中心
      ,a.racct --科目
      ,a.racct_t --摘要
      ,a.mat_pspnr --WBS元素
      ,tdate --传输日期
      ,dmbtr1 --本位币金额
  FROM dw_fi_detail a
 WHERE a.gjahr = '2019' --年参数
   AND a.poper <= '006' --期间参数
   AND a.racct in  (select A.saknr 
from (select * from dw_fi_subject B where B.ZC_INDEX='00011')B--报表参数
left join (
select A.saknr,A.txt20 from dw_fi_subject_des A
union 
select B.kostl,B.ktext from dw_fi_cost_factor_des B )A
on A.saknr between B.from_racct and B.to_racct)
   and a.racct= '5502000030' --会计科目参数
   AND TRIM(leading '0' FROM a.prctr) in  (SELECT dept FROM dept2 where DEPT is not null)
   AND NOT EXISTS
 (
SELECT *
  FROM dw_fi_detail b
 WHERE b.racct LIKE 'A%'
  AND TRIM(leading '0' FROM b.sprctr) in  (SELECT dept FROM dept1)
           AND a.racct = b.racct
           AND a.sprctr = b.sprctr
           AND a.gjahr = b.gjahr
           AND a.poper = b.poper
           AND a.prctr = b.prctr)
            ;
