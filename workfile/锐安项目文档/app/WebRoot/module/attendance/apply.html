<!DOCTYPE html>
<html lang="en">
	<head>
	<meta charset="utf-8">
	<title>请假申请</title>
	<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<!-- <script src="js/vrv-jssdk.js"></script> -->
	<link rel="stylesheet" href="../../css/mui.min.css">
	<link href="../../css/mui.picker.css" rel="stylesheet" />
	<link href="../../css/mui.picker.min.css" rel="stylesheet" />
	<link href="../../css/mui.poppicker.css" rel="stylesheet" />
	<link href="../../css/app.css" rel="stylesheet" />
	<link href="../../css/myui.css" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="../../css/feedback.css" />

	<style>
		.title{
			margin: 20px 15px 7px;
			color: #6d6d72;
			font-size: 15px;
		}
		
		#tiaojian li{
			display: none;
		}
		#onload{
			display: none;
		}
		#buru1{
			display: none;
		}
		#buru2{
			display: none;
		}
		/*跨webview需要手动指定位置*/		
		.mui-plus header.mui-bar {
			display: none!important;
		}
		.mui-plus .mui-bar-nav~.mui-content {
			padding: 0!important;
		}
		
		.mui-plus .plus{
			display: inline;
		}			
		.plus{
			display: none;
		}
		#topPopover {
			position: fixed;
			top: 16px;
			right: 6px;
		}
		#topPopover .mui-popover-arrow {
			left: auto;
			right: 6px;
		}
		p {
			text-indent: 22px;
		}
		.mui-popover {
			height: 120px;
			width: 100%;
			z-index: 99999;
		}
		.mui-content {
			padding: 10px;
		}
		.user-portal-red{
            border-radius: 4px;
            padding:5px;
            margin-right: 10px;
            background-color: #F14E41;
            color: #fff;
           }
        .suser{
        	color: #000;
        	font-size: 15px;
        }
        .suser2{
        	color: #000;
        	font-size: 15px;
        }
	</style>
	</head>
	<body class="feedback">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">请假申请</h1>
		</header>
		<div class="mui-content">
			<ul class="formList">
				<li class="clearfix">
					<span class="left label">申请人</span>
					<span class="f_input right mr" id="userName"></span>
				</li>
				<li class="clearfix" id="showProPicker">
					<span class="left label">请假类型</span>
					<img src="../../images/rightarr.png" alt="" class="right rightArr"/>	
					<span class="right content" id="showAttendance">请选择</span>
				</li>
				<li class="clearfix" id="noBuru">
					<div class="left label">请假时间</div>
					<span id='demo2' data-options='{"type":"hour","beginYear":2018,"endYear":2020}' class="btn right mr">结束时间</span>
					<img src="../../images/adr-arrow.png" class="right" alt="" style="height: 25px;margin: 8px 10px;">
					<span id='demo1' class="btn right" data-options='{"type":"hour","beginYear":2018,"endYear":2020}'>开始时间</span>
				</li>
				<li class="clearfix" id="buru1">
					<div class="left label">请假时间</div>
					<span id='demo4' data-options='{"type":"date","beginYear":2018,"endYear":2020}' class="btn right mr">结束时间</span>
					<img src="../../images/adr-arrow.png" class="right" alt="" style="height: 25px;margin: 8px 10px;">
					<span id='demo3' class="btn right" data-options='{"type":"date","beginYear":2018,"endYear":2020}'>开始时间</span>
				</li>
				<li class="clearfix" id="buru2">
					<div class="left label">请假时间段</div>
					<span class="right">
						<input type="radio" name="duan" value="1"/>09:00-10:00
						<input type="radio" name="duan" value="2"/>17:00-18:00
					</span>
				</li>
				<li class="clearfix">
					<span class="left label">小时数</span>
					<input type="text" class="f_input right wp60" id="leaveHours" placeholder="" readonly="readonly"/>
				</li>
				<li class="clearfix">
					<span class="left label">工作代理人</span>
					<a href="#middlePopover" class="right suser"  style="margin-right: 14px;">请选择工作代理人</a>
				</li>
				<li class="clearfix" style="height: auto;">
					<textarea class="mui-input-speech t10" id="textarea" rows="5" placeholder="请输入请假事由"></textarea>
				</li>
				<li class="relative" id="onload">
		            <span id="results">请假条件</span>
		            <div>
		            	<ul id="tiaojian">
			            	<!-- 调休假-->
							<li class="mui-table-view-cell mui-media detailMsg fadeBox stateTable takeOffCheck" data-title="调休假" id="tiaoxiu">
								<div>调休假期明细：<span id="takeOffDay">
									<textarea rows="20" cols="20" id="tiaoxiu"></textarea>
								</span></div>
							</li>
							<!-- 产检假-->
							<li class="mui-table-view-cell mui-media detailMsg fadeBox stateTable birthCheck" data-title="产检假" id="chanjian">
								<div>产检假类型：<span id="checkType">
									<input type="radio" name="chan"  value="1"/>1-7个月
									<input type="radio" name="chan" value="2"/>8个月
									<input type="radio" name="chan" value="3"/>9个月
								</span></div>
								<div class="line"></div>
								<div>产检附件：<span id="birthCheckFile"></span></div>
							</li>
							<!-- 病假-->
							<li class="mui-table-view-cell mui-media detailMsg fadeBox stateTable sickLeave" data-title="病假" id="bing">
								<div>医院诊断证明：<span id="sickLeaveFile"></span></div>
							</li>
							<!-- 陪护假-->
							<li class="mui-table-view-cell mui-media detailMsg fadeBox stateTable chaperonage" data-title="陪护假" id="peihu">
								<div>子女出生日期：<span id="birthDay">
									<span id='demo5' class="btn right" data-options='{"type":"hour","beginYear":2018,"endYear":2020}'>请选择出生日期</span>
									</span>
								</div>
								<div class="line"></div>
								<div>子女出生证明：<span id="chaperonageFile"></span></div>
							</li>
							<!-- 计划生育假-->
							<li class="mui-table-view-cell mui-media detailMsg fadeBox stateTable planBirth" data-title="计划生育假" id="jihua">
								<div>计划类型：<span id="planBirthType">
										<input type="radio" name="jihua" value="1"/>未满4个月
										<input type="radio" name="jihua" value="2"/>满4个月
									</span>
								</div>
								<div class="line"></div>
								<div>医院诊断证明：<span id="planBirthFile"></span></div>
							</li>
							<!-- 产假-->
							<li class="mui-table-view-cell mui-media detailMsg fadeBox stateTable maternity" data-title="产假" id="chanjia">
								<div>产假类型：<span id="maternityType">
										<input type="radio" name="chanjia" value="1" />正常
										<input type="radio" name="chanjia" value="2" />难产/剖腹产
										<input type="radio" name="chanjia" value="3" />多胞胎
									</span>
								</div>
								<div>多胞胎数量：
									<span >
										<input type="text" style="border: 10px solid red; width: 50%;" placeholder="请输入数量" id="duo">
									</span>
								</div>
								<div>医院诊断证明：<span id="maternityFile"></span></div>
							</li>
							<!-- 哺乳假-->
							<li class="mui-table-view-cell mui-media detailMsg fadeBox stateTable suckle" data-title="哺乳假" id="burujia">
								<div>子女出生日期：<span id="suckleBirthDay">
									<span id='demo6' class="btn right" data-options='{"type":"hour","beginYear":2018,"endYear":2020}'>请选择子女出生日期
								</span></div>
								<div class="line"></div>
								<div>子女出生证明：<span id="suckleFile"></span></div>
							</li>
							<!-- 婚假-->
							<li class="mui-table-view-cell mui-media detailMsg fadeBox stateTable wedding" data-title="婚假" id="hunjia">
								<div>领取结婚证日期：<span id="weddingDay">
									<span id='demo7' class="btn right" data-options='{"type":"hour","beginYear":2018,"endYear":2020}'>请选择领证日期
								</span></div>
								<div class="line"></div>
								<div>结婚证复印件：<span id="weddingFile"></span></div>
							</li>
							<!-- 离职服务假-->
							<li class="mui-table-view-cell mui-media detailMsg fadeBox stateTable wedding" data-title="婚假" id="lizhi">
								<div>离职人员：<span id="weddingDay">
									<a href="#middlePopover2" class="right suser2" id="" style="margin-right: 14px;">请选择当前离职人</a>
								</span></div>
							</li>
			            </ul>
		            </div>
		            <div class="" style="height: 50px;margin-top: 10px;" id="files">
		                    <div class="fileBox left">
		                    </div>
		                    <a href="javascript:;" class="addbtn left fileAdd"><img src="../../images/addicon.png" alt class="addicon"/></a>
							<span id="questionFiles" ></span>
		            </div>
		        </li>
			</ul>
			<div id="middlePopover" class="mui-popover">
			    <div class="mui-popover-arrow"></div>
			    <div class="mui-scroll-wrapper">
				    <div class="mui-scroll">
					    <div style="float: left;padding-left: 3%;width: 40%;">
						    <select id="deptSelection" onchange="initManagerInfo(this)">
							    <option  >请选择部门</option>
						    </select>
					    </div>
					    <div style="float: left;padding-left: 3%;width: 40%;">
						    <select id="memberSelection" onchange="selectMember()">
							    <option id="memberOptions" >请选择代理人员</option>
						    </select>
					    </div>
				    </div>
			    </div>
		    </div>
			<div id="middlePopover2" class="mui-popover">
			    <div class="mui-popover-arrow"></div>
			    <div class="mui-scroll-wrapper">
				    <div class="mui-scroll">
					    <div style="float: left;padding-left: 3%;width: 40%;">
						    <select id="deptSelection2" onchange="initManagerInfo2(this)">
							    <option id="deptOptions2" >请选择部门</option>
						    </select>
					    </div>
					    <div style="float: left;padding-left: 3%;width: 40%;">
						    <select id="memberSelection2" onchange="selectMember2()">
							    <option id="memberOptions2" >请选择离职人员</option>
						    </select>
					    </div>
				    </div>
			    </div>
		    </div>
			<div class="clear"></div>
			<!-- <form> -->
				<div class="mui-card">
					<button type="button" id="leaveSubmit"  class="mui-btn mui-btn-primary mui-btn-block">提交</button>
				</div>
				
			<!-- </form> -->
		</div>
	</body>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/jquery-1.7.2.min.js"></script>
	<script src="../../js/mui.picker.js"></script>
	<script src="../../js/mui.poppicker.js"></script>
	<script src="../../js/mui.picker.min.js"></script>
	<script src="../../js/city.data.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/city.data-3.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/global.js"></script>
	<script>
		mui.init({
			swipeBack:true //启用右滑关闭功能
		});
		
        var delfile = [];
        var timer=null;
        var fileName;
        var files;
        mui.ready(function() {
    /**
     * 获取对象属性的值
     * 主要用于过滤三级联动中，可能出现的最低级的数据不存在的情况，实际开发中需要注意这一点；
     * @param {Object} obj 对象
     * @param {String} param 属性名
     */
    var _getParam = function(obj, param) {
        return obj[param] || '';
    };
   
    //添加文件
    $('.fileAdd').off().on('click',function(){
        var inputName = new Date().getTime();
        var _html = '<input type="file" class="hide fileInput" data-id="'+inputName+'" multiple/>';
        $('.fileBox').after(_html);
		
        $('input[data-id="'+inputName+'"]').click();
    });

    //文件选择变化
    $('.fileInput').die().live('change',function(e) {
        var _html = '';
        var filelength = e.target.files.length;
        if((filelength+$('.fileBox .imgbtn').length)>1){
            mui.alert('不能同时上传多个文件');
            return false;
        }
        	
            if(e.target.files.length<=1){

            	var result=$("#showAttendance").text();
            	var file = e.target.files[0];
            	if(result=="产检假"){
            		$("#birthCheckFile").text(file.name);
            	}
            	if(result=="陪护假" || result=="哺乳假" ){
            		$("#chaperonageFile").text(file.name);
            	}
            	if(result=="计划生育假"){
            		$("#planBirthFile").text(file.name);
            	}
            	if(result=="产假"){
            		$("#maternityFile").text(file.name);
            	}
            	if(result=="婚假"){
            		$("#weddingFile").text(file.name);
            	}
            	if(result=="病假" ||result=="长期病假" || result=="带薪病假" ){
            		$("#sickLeaveFile").text(file.name);
            	}
            	if(result=="哺乳假" ){
            		$("#suckleFile").text(file.name);
            	}
				var strFile=file.name;
				if(strFile.indexOf(";")!=-1){
					alert("文件名称不能带 ; ");
					return false;
				}
				 //上传控制！！！！！！！！
				const imgMaxSize = 1024 * 1024 * 5 ; // 5MB
				// 检查文件类型
				
				// 文件大小限制
				if(file.size > imgMaxSize ) {
					showAlert("文件大小不能超过5MB！");
					return false;
				}	
				if(file.name!=null&&file.name!='/'){
				goToFileUp(file);
                _html='<span class="imgbtn left relative" data-input="'+$(e.target).attr("data-id")+'" data-time="'+file.lastModified+'">'+
                    '<img src="../../images/imgicon.png" class="imgicon" />'+
                    '<a href="javascript:;" class="imgdelbtn">'+
                    '<img src="../../images/delicon.png" alt class="imgdelicon" />'+					
                    '</a>'+
                    '</span>';
				}
				
            }else{
            	var x = 100;
   				var y = 0;
   		    	var rand = parseInt(Math.random() * (x - y + 1) + y);
                var file = e.target.files;
                $.each(file,function(i,item){
				var strFile=item.name;
				if(strFile.indexOf(";")!=-1){
					alert("文件名称不能带 ; ");
					return false;
				}
				 //上传控制！！！！！！！！
				const imgMaxSize = 1024 * 1024 * 5; // 5MB
				// 检查文件类型
				
				// 文件大小限制
				if(file.size > imgMaxSize ) {
					showAlert("文件大小不能超过5MB！");
					return false;
				}	
				if(file.name!=null&&file.name!='/'){
				goToFileUp(file);
                    _html+='<span class="imgbtn left relative" data-input="'+$(e.target).attr("data-id")+'" data-time="'+item.lastModified+'">'+
                        '<img src="../../images/imgicon.png" class="imgicon"/>'+
                        '<a href="javascript:;" class="imgdelbtn">'+
                        '<img src="../../images/delicon.png" alt class="imgdelicon" />'+
                        '</a>'+
                        '</span>';}
                });
            }
            $('.fileBox').append(_html);
        
    });
    //关闭文件
    $('.imgdelbtn').die().live('touchend',function(){
        var fileId = $(this).parent().attr('data-time'); //file中的lastModified
        delfile.push(fileId);
        $(this).parent().remove();
        $("#questionFiles").text("");
        return false;
    });
});

function goToFileUp(file){
			
	// 图片上传							
	//transformFileToFormData(file);	
	// 图片压缩绘制
	// transformFileToDataUrl(file);
	// 图片上传
	transformFileToFormData(file);
}


// 将File append进 FormData
function transformFileToFormData (file) {
	localStorage.files=file.size;
    const formData = new FormData();
    // name
    formData.append('name', file.name);
    // append 文件
    formData.append('businessFile', file);	
    // 上传图片
    uploadMobileFile(formData);
}

// 上传图片
function uploadImg (formData) {
     const xhr = new XMLHttpRequest();
     // 进度监听
     xhr.upload.addEventListener('progress', function(e){console.log(e.loaded / e.total)}, false);
     // 加载监听
     // xhr.addEventListener('load', ()=>{console.log("加载中");}, false);
     // 错误监听
     xhr.addEventListener('error', function(){Toast.error("上传失败！", 2000, undefined, false);toCliekBtn();}, false);
     xhr.onreadystatechange = function () {
         if (xhr.readyState === 4) {
				 debugger;
			 if (xhr.status === 200) {
				 const result = JSON.parse(xhr.responseText);
                 // 上传成功
				 if(result.flag == true){
				 }else{
					// showAlert("上传失败");
				 }
             } else {
                 // 上传失败
				 //console.log("fail");
				 showAlert("服务异常,上传失败");
				
             }
			 //上传按钮处理！！！！！
         }
     };
     xhr.open('POST', pathUrl+'/FileMobile.action' , true);
	 xhr.send(formData);
}

function uploadMobileFile(formData){
			$.ajax({
			url: pathUrl+'/FileMobile.action',
			type:"post",
			data:formData,
			async:false,/*同步请求*/
			dataType:"json",
			contentType:false,
			processData:false,
			error : function(){
				mui.toast("上传图片失败！");
			},
			success:function(data){
				var data=JSON.parse(data);
				localStorage.newFileName= data.newFileName;
			}    
   });
}

function showAlert(str){
	setTimeout(function(){
		alert(str);
	},100);
}

</script>
<script type="text/javascript">
    //为了兼容高版本chrome浏览器，此处不能读取缓存，故采用加随机数方式引入脚本
    document.write("<s" + "cript type='text/javascript' src='js/attendance-apply.js?" + Math.random() + "'></s" + "cript>");
</script>
</html>