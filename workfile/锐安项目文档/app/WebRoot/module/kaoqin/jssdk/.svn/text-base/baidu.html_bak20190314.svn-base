<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <style type="text/css">
    body, html {width: 100%;height: 100%;margin:0;font-family:"微软雅黑";}
    #allmap{width:100%;height:100%;}
    p{margin-left:5px; font-size:14px;}
  </style>
  <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=7ebC5jOb9IEEecyddRzztgtruUtQtOQS"></script>
  <script type="text/javascript" src="jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="vrv-jssdk.js"></script>
  <title>锐安考勤打卡-国际版</title>
  <link rel="stylesheet" type="text/css" href="style/global.css" />
  <link rel="stylesheet" type="text/css" href="style/style.css">
</head>
<body>
  <div id="allmap"></div>
  		<div class="container relative">
				<input id = "userName" type = "hidden" />
				<input id = "address" type = "hidden" />
				<input id = "province" type = "hidden" />
				<input id = "city" type = "hidden" />
				<input id = "district" type = "hidden" />
				<input id = "street" type = "hidden" />
				<input id = "streetNumber" type = "hidden"/>
				<input id = "mLocation_X" type = "hidden" />
				<input id = "mLocation_Y" type = "hidden" />
				<input id = "adressMsg" type = "hidden" />
				
			<div id='container'  class="map">
			</div>
			<div id='tip' >
			</div>
			<div class="punchClockWrap">
				<a href="javascript:;" id = "res1" class='left'>
					<span class="punch disabled"></span>
					<span class="curTime">09:00</span>
				</a>
				<a href="javascript:;" id = "res2" class='left'>
					<span class="punch disabled"></span>
					<span class="curTime">12:00</span>
				</a>
				<a href="javascript:;" id = "res3" class='left'>
					<span class="punch disabled"></span>
					<span class="curTime">13:00</span>
				</a>
				<a href="javascript:;" id = "res4" class='left'>
					<span class="punch disabled"></span>
					<span class="curTime">18:00</span>
				</a>
			</div>
		</div>
		<div class="popWrap1">
			<p class="msg">--</p>
			<a href="javascript:;" class="btn_sure_res1">确定</a>
			<a href="javascript:;" class="btn_load_res1">重定位</a>
			<a href="javascript:;" class="btn_close_res1">取消</a>
		</div>
		
		<div class="popWrap2">
			<p class="msg">--</p>
			<a href="javascript:;" class="btn_sure_res2">确定</a>
			<a href="javascript:;" class="btn_load_res2">重定位</a>
			<a href="javascript:;" class="btn_close_res2">取消</a>
		</div>
		
		<div class="popWrap3">
			<p class="msg">--</p>
			<a href="javascript:;" class="btn_sure_res3">确定</a>
			<a href="javascript:;" class="btn_load_res3">重定位</a>
			<a href="javascript:;" class="btn_close_res3">取消</a>
		</div>
		
		<div class="popWrap4">
			<p class="msg">--</p>
			<a href="javascript:;" class="btn_sure_res4">确定</a>
			<a href="javascript:;" class="btn_load_res4">重定位</a>
			<a href="javascript:;" class="btn_close_res4">取消</a>
		</div>
</body>
</html>
<script type="text/javascript">

	$(function(){
		loadMap()	
	});
		
	function loadMap(){
		$("#address").attr("value","");
		$("#userName").attr("value","");
		vrv.init({
			debug:false//开启调试模式,调用的所有api的返回值会在客户端alert出来
		});
		var kaoQinPath = "https://www.wanglin.online:6443";
			vrv.jssdk.getAccountInfo({
				isEntUser: false,
				success: function (res) {

						$("#userName").val(res.mUserName);
						var phoneNum = res.phoneNumber;
						var userName = $("#userName").val();
						if(phoneNum != ''){
							getKaoqinRecord(userName,kaoQinPath);
						}else{
							alert("用户信息获取失败！");
						}
					}
				})
		
		var map = new BMap.Map("allmap");
		var point = new BMap.Point(116.501573, 39.900877);
		map.centerAndZoom(point, 16)
 
		// 此处二种方案可选其一，自测方案2更准确，1和2的方案，大致位置来讲都是准的
		// 定位对象方案1 : 百度获取经纬度
		var geoc = new BMap.Geocoder();
		var geolocation = new BMap.Geolocation();
		geolocation.getCurrentPosition(function(r){
		　　if(this.getStatus() == BMAP_STATUS_SUCCESS){
		　　　　var mk = new BMap.Marker(r.point);
		　　　　map.addOverlay(mk);
		　　　　map.panTo(r.point);
		　　　　//alert("当前位置经度为:"+r.point.lng+"纬度为:"+r.point.lat);
				//setLocation(r.point);
				var lat_lng = r.point.lat+','+r.point.lng;
				getPosition(lat_lng);
				$("#mLocation_X").val(r.point.lng);
				$("#mLocation_Y").val(r.point.lat);
				
		　　} else {
		　　　　alert('定位失败，请重新定位！');
		　　}
		},{enableHighAccuracy: true});
	}
	
	//获取地理位置的函数
	function setLocation(point){

　　	geoc.getLocation(point, function(rs){
　　　　var addComp = rs.addressComponents;
　　　　var result = addComp.province + addComp.city + addComp.district + addComp.street + addComp.streetNumber;
　　　//　alert("当前的位置为:"+result);
　　　　});
	}

	function getPosition(lat_lng){
	
		jQuery.ajax({  
            url: 'http://api.map.baidu.com/geocoder/v2/',  
			data: {
				location:lat_lng,
				output:'json',
				pois:'1',
				ak:'7ebC5jOb9IEEecyddRzztgtruUtQtOQS'
			},
            timeout: 3000,  
            dataType: 'jsonp',   
            callback:"renderReverse",   
            success: function (res) {   
				var addressComponent = res.result.addressComponent;
				var locationAdress = addressComponent.province+','+addressComponent.city+','+addressComponent.district+','+addressComponent.street;
				$("#address").val(locationAdress);
				$("#adressMsg").val(res.result.formatted_address);
				var str=[];
				str.push('日期：' + showTime());
				str.push('位置：' + (res.mAddress));
				//document.getElementById('tip').innerHTML=str.join('<br>');
				str=['定位信息'];
				$(".BMap_geolocationAddress").html('');	
            },   
            error: function () {   
                alert('定位失败！');   
            }   
        });
	}
	
				
function getKaoqinRecord(userName,kaoQinPath){

	$.ajax({
			url:kaoQinPath+"/RunErpSystem/querySignInfo.action",
			type:"post",
			data : {
				 userName:userName
			},
			async:false,/*同步请求*/
			dataType:"jsonp",
			jsonp:"callback",
			jsonpCallback:"flightHandler",
			error : function(){
				alert("信息加载失败！");
			},
			success:function(data){
				var test = JSON.parse(data);
				
				var signInfo = test.signInfo;
				var userName = test.userName;

			   if(signInfo.msStatus == "已打卡"){
				  $('.punchClockWrap #res1').removeClass('cur').find('.punch').addClass('disabled');						  
				  $('#res1 .curTime').html(signInfo.msTime.substring(11));
			   }else{
				  $('.punchClockWrap #res1').find('.punch').removeClass('disabled');	

				  
			   }
			   
			   if(signInfo.msoStatus == "已打卡"){
			   
				  $('.punchClockWrap #res2').removeClass('cur').find('.punch').addClass('disabled');                         
				  $('#res2 .curTime').html(signInfo.msoTime.substring(11));
			   }else{
				   $('.punchClockWrap #res2').find('.punch').removeClass('disabled');						  
			   }
			  
			   if(signInfo.asStatus == "已打卡"){
				  
				  $('.punchClockWrap #res3').removeClass('cur').find('.punch').addClass('disabled');                         
				  $('#res3 .curTime').html(signInfo.asTime.substring(11));
			   }else{
				   $('.punchClockWrap #res3').find('.punch').removeClass('disabled');						  
			   }
			   
			   if(signInfo.asoStatus == "已打卡"){
				   
				  $('.punchClockWrap #res4').removeClass('cur').find('.punch').addClass('disabled');                  
				  $('#res4 .curTime').html(signInfo.asoTime.substring(11));
			   }else{
				   $('.punchClockWrap #res4').find('.punch').removeClass('disabled');						  
			   }	
			}    
	});
	
}


//更新打卡记录
function userSign(jsonData) {
	$.ajax({
		   url:"https://www.wanglin.online:6443/RunErpSystem/userSign.action",
		   type:"post",
		   data : jsonData,
		   async:false,/*同步请求*/
		   dataType:"jsonp",
		   jsonp:"callback",
		   jsonpCallback:"flightHandler",
		   error : function(){    
			   alert("打卡失败，请重新打卡！");
		   },
		   success:function(data){
		   
			   data = eval("("+data+")");    //包数据解析为json 格式
			   var signInfo = data.signInfo;
			   
			   if(signInfo.msStatus == "已打卡"){
				  $('.punchClockWrap #res1').removeClass('cur').find('.punch').addClass('disabled');						  
				  $('#res1 .curTime').html(signInfo.msTime.substring(11));
			   }else{
				   $('.punchClockWrap #res1').find('.punch').removeClass('disabled');
			   }
			   
			   if(signInfo.msoStatus == "已打卡"){
			   
				  $('.punchClockWrap #res2').removeClass('cur').find('.punch').addClass('disabled');                         
				  $('#res2 .curTime').html(signInfo.msoTime.substring(11));
			   }else{
				   $('.punchClockWrap #res2').find('.punch').removeClass('disabled');
			   }
			  
			   if(signInfo.asStatus == "已打卡"){
				  
				  $('.punchClockWrap #res3').removeClass('cur').find('.punch').addClass('disabled');                         
				  $('#res3 .curTime').html(signInfo.asTime.substring(11));
			   }else{
				   $('.punchClockWrap #res3').find('.punch').removeClass('disabled');
			   }
			   
			   if(signInfo.asoStatus == "已打卡"){
				   
				  $('.punchClockWrap #res4').removeClass('cur').find('.punch').addClass('disabled');                  
				  $('#res4 .curTime').html(signInfo.asoTime.substring(11));
			   }else{
				   $('.punchClockWrap #res4').find('.punch').removeClass('disabled');
			   }	
		   }
	});
}

  //弹框1显示
	$('#res1').off().on('click', function(){
		if(!$(this).find('.punch').hasClass('disabled')){
			loadMap();
			setTimeout(function(){
				var address=$("#address").val();
				var adressMsg = $("#adressMsg").val();
				if(address != '' && adressMsg != ''){
				
					$('.popWrap1 .msg').html(adressMsg);
					$('.btn_sure_res1').show();
					$('.btn_load_res1').hide();
					$('.btn_close_res1').show();
				}else{
					$('.popWrap1 .msg').html("定位失败，请重新定位！");
					$('.btn_sure_res1').hide();
					$('.btn_load_res1').show();
					$('.btn_close_res1').show();
				}
				
				$('.popWrap1').show();
				$('#res1').removeClass('cur');
				$(this).addClass('cur');
			},2000)	
		}
	});
	// 确定打卡并关闭弹框1
	$('.btn_sure_res1, .btn_close_res1').off().on('click', function(){
		if($(this).hasClass('btn_sure_res1')){
			var address=$("#address").val();
			if(address != ''){//写入打卡记录
				var jsonData = {};
				jsonData.userName = $("#userName").val();
				jsonData.province = $("#province").val();//省份
				jsonData.city = $("#city").val();//市
				jsonData.district = $("#district").val();//区
				jsonData.street = $("#street").val();//街道
				jsonData.streetNumber = $("#streetNumber").val();
				jsonData.address = $("#address").val();//
				jsonData.longitude = $("#mLocation_X").val();// 经度
				jsonData.latitude = $("#mLocation_Y").val(); // 纬度
				jsonData.signType = "m-sign";
				jsonData.fromRunApp = "true";
				userSign(jsonData);
				
			}
		}
		$('.popWrap1').hide();
		
	});
	// 重新定位并关闭弹框1
	$('.btn_load_res1').off().on('click', function(){
		if($(this).hasClass('btn_load_res1')){
			loadMap();//重新加载地图进行定位
		}
		$('.popWrap2').hide();
		
	});
//弹框2显示
	$('#res2').off().on('click', function(){
		if(!$(this).find('.punch').hasClass('disabled')){

			loadMap();
			setTimeout(function(){
				var address=$("#address").val();
				var adressMsg = $("#adressMsg").val();
				if(address != '' && adressMsg != ''){
				
					$('.popWrap2 .msg').html(adressMsg);
					$('.btn_sure_res2').show();
					$('.btn_load_res2').hide();
					$('.btn_close_res2').show();
					
				}else{
					$('.popWrap2 .msg').html("定位失败，请重新定位！");

					$('.btn_sure_res2').hide();
					$('.btn_load_res2').show();
					$('.btn_close_res2').show();
				}

				$('.popWrap2').show();
				$('#res2').removeClass('cur');
				$(this).addClass('cur');	
			},2000)
		}
	});
	
	// 确定打卡并关闭弹框2
	$('.btn_sure_res2, .btn_close_res2').off().on('click', function(){
		if($(this).hasClass('btn_sure_res2')){
			var address=$("#address").val();
			if(address != ''){//写入打卡记录
				
				var jsonData = {};
				jsonData.userName = $("#userName").val();
				jsonData.province = $("#province").val();//省份
				jsonData.city = $("#city").val();//市
				jsonData.district = $("#district").val();//区
				jsonData.street = $("#street").val();//街道
				jsonData.streetNumber = $("#streetNumber").val();
				jsonData.address = $("#address").val();//
				jsonData.longitude = $("#mLocation_X").val();// 经度
				jsonData.latitude = $("#mLocation_Y").val(); // 纬度
				jsonData.signType =  "m-sign-out";
				jsonData.fromRunApp = "true";

				userSign(jsonData);
				
			}
		}
		$('.popWrap2').hide();
	});
	
	
	// 重新定位并关闭弹框2
	$('.btn_load_res2').off().on('click', function(){
		if($(this).hasClass('btn_load_res2')){
			loadMap();//重新加载地图进行定位
		}
		$('.popWrap2').hide();
		
	});
	

	////=====================================

	//弹框3显示
	$('#res3').off().on('click', function(){
		if(!$(this).find('.punch').hasClass('disabled')){
			
			loadMap();
			
			setTimeout(function(){
			var address=$("#address").val();
			var adressMsg = $("#adressMsg").val();
				if(address != '' && adressMsg != ''){
				
					$('.popWrap3 .msg').html(adressMsg);
					$('.btn_sure_res3').show();
					$('.btn_load_res3').hide();
					$('.btn_close_res3').show();
				}else{
					$('.popWrap3 .msg').html("定位失败，请重新定位！");

					$('.btn_sure_res3').hide();
					$('.btn_load_res3').show();
					$('.btn_close_res3').show();
				}
				$('.popWrap3').show();
				$('#res3').removeClass('cur');
				$(this).addClass('cur');
			},2000)	
		}
	});
	
	// 确定打卡并关闭弹框3
	$('.btn_sure_res3, .btn_close_res3').off().on('click', function(){
		if($(this).hasClass('btn_sure_res3')){
			var address=$("#address").val();
			if(address != ''){//写入打卡记录
			
				var jsonData = {};
				jsonData.userName = $("#userName").val();
				jsonData.province = $("#province").val();//省份
				jsonData.city = $("#city").val();//市
				jsonData.district = $("#district").val();//区
				jsonData.street = $("#street").val();//街道
				jsonData.streetNumber = $("#streetNumber").val();
				jsonData.address = $("#address").val();//
				jsonData.longitude = $("#mLocation_X").val();// 经度
				jsonData.latitude = $("#mLocation_Y").val(); // 纬度
				jsonData.signType =  "a-sign";
				jsonData.fromRunApp = "true";

				userSign(jsonData);

				
			}
		}
		$('.popWrap3').hide();
	});
	
	
	// 重新定位并关闭弹框3
	$('.btn_load_res3').off().on('click', function(){
		if($(this).hasClass('btn_load_res3')){
			loadMap();//重新加载地图进行定位
		}
		$('.popWrap3').hide();
		
	});
	//=======================
	
	//弹框4显示
	$('#res4').off().on('click', function(){
		if(!$(this).find('.punch').hasClass('disabled')){
			
			loadMap();
			setTimeout(function(){
				var address=$("#address").val();
				var adressMsg = $("#adressMsg").val();
				if(address != '' && adressMsg != ''){

					$('.popWrap4 .msg').html(adressMsg);				
					$('.btn_sure_res4').show();
					$('.btn_load_res4').hide();
					$('.btn_close_res4').show();
				}else{
					$('.popWrap4 .msg').html("定位失败，请重新定位！");				
					$('.btn_sure_res4').hide();
					$('.btn_load_res4').show();
					$('.btn_close_res4').show();
				}
				$('.popWrap4').show();
				$('#res4').removeClass('cur');
				$(this).addClass('cur');	
			},2000)	
		}
	});
	
	// 确定打卡并关闭弹框4
	$('.btn_sure_res4, .btn_close_res4').off().on('click', function(){
		if($(this).hasClass('btn_sure_res4')){
			var address=$("#address").val();
			if(address != ''){//写入打卡记录
			
				var jsonData = {};
				jsonData.userName = $("#userName").val();
				jsonData.province = $("#province").val();//省份
				jsonData.city = $("#city").val();//市
				jsonData.district = $("#district").val();//区
				jsonData.street = $("#street").val();//街道
				jsonData.streetNumber = $("#streetNumber").val();
				jsonData.address = $("#address").val();//
				jsonData.longitude = $("#mLocation_X").val();// 经度
				jsonData.latitude = $("#mLocation_Y").val(); // 纬度
				jsonData.signType =  "a-sign-out";
				jsonData.fromRunApp = "true";

				userSign(jsonData);
			}
		}
		$('.popWrap4').hide();
	});
	
	
	// 重新定位并关闭弹框4
	$('.btn_load_res4').off().on('click', function(){
		if($(this).hasClass('btn_load_res4')){
			loadMap();//重新加载地图进行定位
		}
		$('.popWrap4').hide();
		
	});
</script>
